{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Staff - Vetorial</title>
    <link rel="icon" href="{% static 'img/favicon.ico' %}" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- FullCalendar -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <style>
    :root {
        --primary-color: #0079bf; /* Trello Blue */
        --primary-hover: #026aa7;
        --sidebar-bg: #1F2937;
        --sidebar-text: #D1D5DB;
        --content-bg: #0079bf; /* Trello Background */
        --card-bg: #FFFFFF;
        --text-primary: #172b4d;
        --text-secondary: #5e6c84;
        --border-color: #dfe1e6;
        --success-color: #10B981;
        --danger-color: #EF4444;
        --warning-color: #F59E0B;
        --kanban-column-bg: #ebecf0;
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        background: var(--content-bg);
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        height: 100vh;
        overflow: hidden;
    }

    /* Layout Principal */
    .staff-dashboard {
        display: flex;
        flex-direction: column;
        height: 100vh;
    }

    /* Header Topo (Estilo Trello) */
    .trello-header {
        height: 48px;
        background: rgba(0,0,0,0.15);
        display: flex;
        align-items: center;
        padding: 0 16px;
        gap: 16px;
        backdrop-filter: blur(4px);
    }
    
    .trello-logo {
        color: white; /* Make logo white or use image */
        font-weight: bold;
        font-size: 1.2rem;
        display: flex;
        align-items: center;
        gap: 8px;
        opacity: 0.8;
    }
    
    .trello-logo:hover {
        opacity: 1;
        background: rgba(255,255,255,0.2);
        padding: 4px 8px;
        border-radius: 4px;
        cursor: pointer;
    }

    .trello-board-header {
        display: flex;
        align-items: center;
        padding: 8px 16px;
        gap: 16px;
    }
    
    .trello-board-title {
        font-size: 1.15rem;
        font-weight: 700;
        color: white;
    }

    /* Área de Conteúdo */
    .content-area {
        flex: 1;
        padding: 0;
        overflow-x: auto;
        display: flex;
        flex-direction: column;
    }

    /* Barra de Ações */
    .actions-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 16px;
        margin-bottom: 16px;
        flex-wrap: wrap;
        padding: 16px 16px 0;
    }

    .search-box {
        flex: 1;
        min-width: 300px;
        max-width: 400px;
        position: relative;
    }

    .search-box input {
        width: 100%;
        padding: 8px 12px 8px 36px;
        border: 1px solid var(--border-color);
        border-radius: 3px;
        font-size: 0.9rem;
    }

    .search-icon {
        position: absolute;
        left: 10px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-secondary);
        width: 16px;
        height: 16px;
    }

    /* Stats Cards */
    .stats-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 16px;
        padding: 0 16px 16px;
        margin-bottom: 8px;
    }

    .stat-card {
        background: white;
        border-radius: 8px;
        padding: 16px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        display: flex;
        flex-direction: column;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
        border-left: 4px solid transparent;
    }

    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .stat-card.active {
        background-color: #f0f9ff;
        border-color: var(--primary-color);
    }

    .stat-title {
        font-size: 0.85rem;
        color: var(--text-secondary);
        font-weight: 500;
        margin-bottom: 8px;
    }

    .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary);
    }
    
    .stat-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 8px;
        background-color: rgba(0, 121, 191, 0.1);
        color: var(--primary-color);
    }

    /* Esconder elementos antigos */
    .content-header {
        /* display: none !important;  Let's keep generic header hidden if we use the trello-one, or show it? */
        /* The user wants the button, which is in actions-bar. */
        display: block;
        padding: 16px 16px 0;
    }
    
    .content-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-primary);
    }
    
    .content-subtitle {
        font-size: 0.9rem;
        color: var(--text-secondary);
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar {
        width: 12px;
        height: 12px;
    }
    
    ::-webkit-scrollbar-track {
        background: rgba(0,0,0,0.1);
        border-radius: 6px;
    }
    
    ::-webkit-scrollbar-thumb {
        background: rgba(255,255,255,0.3);
        border-radius: 6px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
        background: rgba(255,255,255,0.4);
    }

    /* Kanban Board Styles Update */
    .kanban-container {
        display: flex;
        gap: 12px;
        overflow-x: auto;
        padding: 12px 16px;
        align-items: flex-start;
        height: 100%;
        width: 100%;
    }

    .kanban-column {
        min-width: 272px;
        max-width: 272px;
        background: var(--kanban-column-bg);
        border-radius: 3px;
        display: flex;
        flex-direction: column;
        max-height: calc(100vh - 100px);
        border: none;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    .kanban-column-header {
        padding: 10px 12px;
        background: transparent;
        border-radius: 3px 3px 0 0;
        border-top: none;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: none;
        cursor: pointer;
    }

    .kanban-column-title {
        font-size: 0.9rem;
        font-weight: 600;
        color: #172b4d;
        text-transform: none;
    }

    .kanban-column-count {
        background: rgba(9, 30, 66, 0.08); /* Neutral count */
        color: #172b4d;
    }

    .kanban-column-content {
        padding: 0 8px 8px 8px;
        gap: 8px;
        min-height: 20px;
    }

    .kanban-card {
        background: #FFFFFF;
        border-radius: 3px;
        padding: 8px 10px;
        box-shadow: 0 1px 0 rgba(9, 30, 66, 0.25);
        border: none;
        margin-bottom: 0;
    }

    .kanban-card:hover {
        transform: none;
        background-color: #F4F5F7;
        border-bottom-color: rgba(9, 30, 66, 0.25);
    }
    
    .kanban-card.dragging {
        background: #e4e6ea;
        box-shadow: none;
        transform: rotate(2deg);
    }

    .kanban-card-header {
        margin-bottom: 4px;
    }
    
    .kanban-card-protocol {
        font-size: 0.7rem;
        color: #5e6c84;
    }

    /* Labels Trello style */
    .kanban-card-priority {
         padding: 2px 0;
         border-radius: 4px;
         font-size: 0; /* Hide text, show color bar */
         height: 8px;
         width: 40px;
         display: block;
         margin-bottom: 4px;
    }
    
    .kanban-card-priority::after {
        content: ''; /* No content needed for color bar only, or hover for tooltip */
    }
    
    .kanban-card-priority.baixa { background-color: #61bd4f; }
    .kanban-card-priority.media { background-color: #f2d600; }
    .kanban-card-priority.alta { background-color: #eb5a46; }
    .kanban-card-priority.urgente { background-color: #c377e0; }

    .kanban-card-title {
        font-weight: 500;
        font-size: 0.9rem;
        color: #172b4d;
        margin-bottom: 4px;
        line-height: 1.3;
    }

    .kanban-card-client {
        font-size: 0.85rem;
        color: #5e6c84;
        margin-bottom: 0;
        display: none; /* Hide client for cleaner look unless essential */
    }
    
    .kanban-card-footer {
        border-top: none;
        padding-top: 6px;
        margin-top: 2px;
    }

    /* Sidebar Styles */
    .menu-section {
        margin-bottom: 24px;
    }

    .menu-section-title {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-secondary);
        margin-bottom: 8px;
        padding-left: 12px;
        font-weight: 600;
    }

    .menu-item {
        display: flex;
        align-items: center;
        padding: 10px 12px;
        color: var(--text-primary);
        text-decoration: none;
        border-radius: 6px;
        margin-bottom: 2px;
        transition: all 0.2s;
    }

    .menu-item:hover {
        background: #f4f5f7;
        color: var(--primary-color);
    }

    .menu-item.active {
        background: #e6f0f6;
        color: var(--primary-color);
        font-weight: 500;
    }

    .menu-item-icon {
        width: 20px;
        height: 20px;
        margin-right: 12px;
    }
    
    .menu-item-text {
        font-size: 0.95rem;
    }

    .btn-primary {
        background: var(--primary-color);
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        font-size: 0.95rem;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s ease;
    }

    .btn-primary:hover {
        background: var(--primary-hover);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    /* Card de Dados */
    .data-card {
        background: var(--card-bg);
        border-radius: 16px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    /* Tabela */
    .data-table {
        width: 100%;
        border-collapse: collapse;
    }

    .data-table thead {
        background: #F9FAFB;
        border-bottom: 2px solid var(--border-color);
    }

    .data-table th {
        padding: 16px 20px;
        text-align: left;
        font-weight: 600;
        font-size: 0.875rem;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .data-table tbody tr {
        border-bottom: 1px solid var(--border-color);
        transition: background 0.2s ease;
    }

    .data-table tbody tr:hover {
        background: #F9FAFB;
    }

    .data-table td {
        padding: 16px 20px;
        color: var(--text-primary);
        font-size: 0.95rem;
    }

    /* Status Badges */
    .badge {
        display: inline-flex;
        align-items: center;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.8125rem;
        font-weight: 600;
        gap: 6px;
        white-space: nowrap;
    }

    .badge-success {
        background: rgba(16, 185, 129, 0.1);
        color: var(--success-color);
    }

    .badge-warning {
        background: rgba(245, 158, 11, 0.1);
        color: var(--warning-color);
    }

    .badge-danger {
        background: rgba(239, 68, 68, 0.1);
        color: var(--danger-color);
    }

    .badge-info {
        background: rgba(59, 130, 246, 0.1);
        color: var(--primary-color);
    }

    /* Botões de Ação */
    .action-buttons {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .btn-action {
        padding: 8px 12px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.875rem;
        font-weight: 500;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        white-space: nowrap;
    }

    .btn-edit {
        background: rgba(59, 130, 246, 0.1);
        color: var(--primary-color);
    }

    .btn-edit:hover {
        background: rgba(59, 130, 246, 0.2);
    }

    .btn-delete {
        background: rgba(239, 68, 68, 0.1);
        color: var(--danger-color);
    }

    .btn-delete:hover {
        background: rgba(239, 68, 68, 0.2);
    }

    .btn-whatsapp {
        background: rgba(37, 211, 102, 0.1);
        color: #25D366;
    }

    .btn-whatsapp:hover {
        background: rgba(37, 211, 102, 0.2);
    }

    .btn-view {
        background: rgba(99, 102, 241, 0.1);
        color: #6366F1;
    }

    .btn-view:hover {
        background: rgba(99, 102, 241, 0.2);
    }

    /* Modal */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 3000;
        align-items: center;
        justify-content: center;
        padding: 20px;
    }

    .modal-overlay.active {
        display: flex;
    }

    .modal-content {
        background: white;
        border-radius: 16px;
        max-width: 700px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        animation: modalSlideIn 0.3s ease;
    }

    @keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .modal-header {
        padding: 24px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary);
        margin: 0;
    }

    .modal-close {
        background: none;
        border: none;
        cursor: pointer;
        padding: 8px;
        border-radius: 8px;
        color: var(--text-secondary);
        transition: all 0.2s ease;
    }

    .modal-close:hover {
        background: #F3F4F6;
        color: var(--text-primary);
    }

    .modal-body {
        padding: 24px;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-label {
        display: block;
        font-weight: 600;
        font-size: 0.875rem;
        color: var(--text-primary);
        margin-bottom: 8px;
    }

    .form-control {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid var(--border-color);
        border-radius: 12px;
        font-size: 0.95rem;
        transition: all 0.2s ease;
        font-family: inherit;
    }

    .form-control:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .modal-footer {
        padding: 24px;
        border-top: 1px solid var(--border-color);
        display: flex;
        justify-content: flex-end;
        gap: 12px;
    }

    .btn-secondary {
        background: #F3F4F6;
        color: var(--text-primary);
        padding: 12px 24px;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        font-size: 0.95rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .btn-secondary:hover {
        background: #E5E7EB;
    }

    /* Chat de Chamados */
    .chat-container {
        max-height: 500px;
        overflow-y: auto;
        padding: 16px;
        background: #F9FAFB;
        border-radius: 12px;
        margin-bottom: 16px;
    }

    .chat-message {
        margin-bottom: 16px;
        display: flex;
        gap: 12px;
    }

    .message-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--primary-color);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.875rem;
        flex-shrink: 0;
    }

    .message-avatar.staff {
        background: var(--success-color);
    }

    .message-content {
        flex: 1;
    }

    .message-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 4px;
    }

    .message-author {
        font-weight: 600;
        font-size: 0.875rem;
        color: var(--text-primary);
    }

    .message-time {
        font-size: 0.75rem;
        color: var(--text-secondary);
    }

    .message-text {
        background: white;
        padding: 12px 16px;
        border-radius: 12px;
        font-size: 0.95rem;
        line-height: 1.5;
        color: var(--text-primary);
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 64px 32px;
    }

    .empty-state-icon {
        width: 80px;
        height: 80px;
        margin: 0 auto 24px;
        opacity: 0.3;
    }

    .empty-state-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 8px;
    }

    .empty-state-text {
        color: var(--text-secondary);
        margin-bottom: 24px;
    }

    /* Responsivo */
    @media (max-width: 768px) {
        .sidebar {
            transform: translateX(-100%);
        }

        .sidebar.active {
            transform: translateX(0);
        }

        .content-area {
            margin-left: 0;
        }

        .actions-bar {
            flex-direction: column;
            align-items: stretch;
        }

        .search-box {
            min-width: 100%;
            max-width: 100%;
        }

        .data-table {
            font-size: 0.875rem;
        }

        .data-table th,
        .data-table td {
            padding: 12px 16px;
        }
    }

    /* Alert */
    .alert {
        padding: 16px 20px;
        border-radius: 12px;
        margin-bottom: 24px;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .alert-success {
        background: rgba(16, 185, 129, 0.1);
        color: var(--success-color);
        border: 1px solid rgba(16, 185, 129, 0.2);
    }

    .alert-error {
        background: rgba(239, 68, 68, 0.1);
        color: var(--danger-color);
        border: 1px solid rgba(239, 68, 68, 0.2);
    }

    /* Kanban Board */
    .kanban-container {
        display: flex;
        gap: 24px;
        overflow-x: auto;
        padding-bottom: 20px;
        align-items: flex-start;
        height: calc(100vh - 240px);
    }

    .kanban-column {
        flex: 1;
        min-width: 300px;
        background: #F3F4F6;
        border-radius: 12px;
        display: flex;
        flex-direction: column;
        max-height: 100%;
        border: 1px solid var(--border-color);
    }

    .kanban-column-header {
        padding: 16px;
        background: #FFFFFF;
        border-radius: 12px 12px 0 0;
        border-top: 4px solid transparent; /* Color set in JS */
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1px;
        border-bottom: 1px solid var(--border-color);
    }

    .kanban-column-title {
        font-size: 0.95rem;
        font-weight: 700;
        color: var(--text-primary);
        text-transform: uppercase;
        margin: 0;
    }

    .kanban-column-count {
        background: #E5E7EB;
        color: var(--text-secondary);
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .kanban-column-content {
        padding: 16px;
        overflow-y: auto;
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .kanban-card {
        background: #FFFFFF;
        border-radius: 8px;
        padding: 16px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
        border: 1px solid var(--border-color);
        position: relative;
    }

    .kanban-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        border-color: var(--primary-color);
    }
    
    .kanban-card.dragging {
        opacity: 0.5;
        border: 2px dashed var(--primary-color);
        background: #F9FAFB;
    }

    .kanban-card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 8px;
    }
    
    .kanban-card-protocol {
        font-size: 0.75rem;
        color: var(--text-secondary);
        font-weight: 500;
    }

    .kanban-card-priority {
         padding: 2px 6px;
         border-radius: 4px;
         font-size: 0.7rem;
         font-weight: 700;
         text-transform: uppercase;
    }
    
    .kanban-card-priority.baixa { background: #E0F2FE; color: #0284C7; }
    .kanban-card-priority.media { background: #FEF3C7; color: #D97706; }
    .kanban-card-priority.alta { background: #FEE2E2; color: #DC2626; }
    .kanban-card-priority.urgente { background: #991B1B; color: #FFFFFF; }

    .kanban-card-title {
        font-weight: 600;
        font-size: 0.95rem;
        color: var(--text-primary);
        margin-bottom: 8px;
        line-height: 1.4;
    }

    .kanban-card-client {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.85rem;
        color: #4B5563;
        margin-bottom: 12px;
    }
    
    .kanban-card-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-top: 1px solid #F3F4F6;
        padding-top: 12px;
        font-size: 0.75rem;
        color: var(--text-secondary);
    }
    
    .kanban-card-date {
        display: flex;
        align-items: center;
        gap: 4px;
    }

    /* Modal Styling Adjustments */
    .modal-content {
        animation: modalSlideIn 0.3s ease;
    }

    /* Client Card Styles */
    .client-card {
        background: #FFFFFF;
        border-radius: 3px;
        padding: 10px;
        box-shadow: 0 1px 0 rgba(9, 30, 66, 0.25);
        border: none;
        margin-bottom: 8px;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        gap: 6px;
    }
    
    .client-card:hover {
        background-color: #F4F5F7;
    }

    .client-avatar {
        width: 24px;
        height: 24px;
        background: #dfe1e6;
        border-radius: 50%;
        color: #172b4d;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        font-weight: 700;
    }
    
    .client-name {
        font-weight: 600;
        color: #172b4d;
        font-size: 0.95rem;
    }
    
    .client-email {
        font-size: 0.8rem;
        color: #5e6c84;
    }
    
    /* Panel/Modal Styles */
    .client-panel-overlay {
        position: fixed;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        background: rgba(0,0,0,0.6);
        z-index: 2000;
        display: none;
        justify-content: flex-end;
    }
    
    .client-panel {
        width: 1100px; /* Wider for details */
        max-width: 95%;
        background: #F4F5F7;
        height: 100%;
        box-shadow: -2px 0 10px rgba(0,0,0,0.2);
        display: flex;
        flex-direction: column;
        animation: slideInRight 0.3s ease;
    }

    /* Tabs inside Panel */
    .panel-tabs {
        display: flex;
        background: white;
        padding: 0 24px;
        border-bottom: 1px solid #dfe1e6;
        gap: 8px;
        overflow-x: auto;
    }
    .panel-tab {
        padding: 16px 12px;
        font-weight: 500;
        cursor: pointer;
        color: #5e6c84;
        border-bottom: 2px solid transparent;
        transition: all 0.2s;
        white-space: nowrap;
        font-size: 0.95rem;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    .panel-tab:hover {
        color: #0052cc;
        background: #f4f5f7;
    }
    .panel-tab.active {
        color: #0052cc;
        border-bottom-color: #0052cc;
        font-weight: 600;
        background: transparent;
    }
    .tab-content {
        display: none;
        flex: 1; /* Take remaining height */
    }
    .tab-content.active {
        display: flex;
        flex-direction: column;
        gap: 24px;
        animation: fadeIn 0.3s;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(5px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes slideInRight {
        from { transform: translateX(100%); }
        to { transform: translateX(0); }
    }
    
    .client-panel-header {
        background: #FFFFFF;
        padding: 20px 24px;
        border-bottom: 1px solid #dfe1e6;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .client-panel-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: #172b4d;
    }
    
    .client-panel-close {
        cursor: pointer;
        color: #5e6c84;
        padding: 8px;
        border-radius: 4px;
    }
    
    .client-panel-close:hover {
         background-color: rgba(9, 30, 66, 0.08);
         color: #172b4d;
    }
    
    .client-panel-content {
        flex: 1;
        overflow-y: auto;
        padding: 24px;
        display: flex;
        flex-direction: column;
        gap: 24px;
    }
    
    .panel-section {
        background: #FFFFFF;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    
    .panel-section-header {
        font-weight: 600;
        color: #172b4d;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 1rem;
        border-bottom: 2px solid #dfe1e6;
        padding-bottom: 8px;
    }
    
    .action-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 12px;
    }
    
    .action-card {
        background: #FAFBFC;
        border: 1px solid #dfe1e6;
        border-radius: 4px;
        padding: 16px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .action-card:hover {
        background: #ebecf0;
        border-color: #c1c7d0;
    }
    
    .items-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    
    .list-item {
        padding: 12px;
        background: #FAFBFC;
        border: 1px solid #dfe1e6;
        border-radius: 4px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    /* Client Card Styles */
    .client-card {
        background: #FFFFFF;
        border-radius: 3px;
        padding: 8px 10px;
        box-shadow: 0 1px 0 rgba(9, 30, 66, 0.25);
        border: none;
        margin-bottom: 8px;
        cursor: pointer;
    }
    .client-card:hover {
        background-color: #F4F5F7;
    }
    .client-avatar {
        width: 32px;
        height: 32px;
        background: #dfe1e6;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: #172b4d;
        font-size: 12px;
    }
    .client-name {
        font-weight: 500;
        color: #172b4d;
        font-size: 0.9rem;
    }
    .client-email {
        font-size: 0.75rem;
        color: #5e6c84;
    }

</style>
</head>
<body>
<div class="staff-dashboard">
    <!-- Trello Header -->
    <header class="trello-header">
         <div class="trello-logo">
            <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                <path d="M4 4h16a2 2 0 012 2v12a2 2 0 01-2 2H4a2 2 0 01-2-2V6a2 2 0 012-2zm0 2v12h16V6H4zm3 2h4v8H7V8zm6 0h4v5h-4V8z"/>
            </svg>
            Vetorial Board
         </div>
         <div class="trello-board-header">
             <h1 class="trello-board-title">Quadro de Atendimentos</h1>
         </div>
         <div style="margin-left: auto;">
             <a href="/" style="color: white; text-decoration: none; font-size: 0.9rem; opacity: 0.8; font-weight: 500;">Sair</a>
         </div>
    </header>

    <div style="display: flex; flex: 1; overflow: hidden;">
    <aside class="sidebar" style="width: 260px; background: white; border-right: 1px solid #dfe1e6; display: flex; flex-direction: column;">
        <nav class="sidebar-nav" style="padding: 16px; overflow-y: auto; flex: 1;">
            <div class="menu-section">
                <a href="#" class="menu-item active" data-model="clientes">
                    <svg class="menu-item-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                    </svg>
                    <span class="menu-item-text">Início</span>
                </a>
            </div>

            <div class="menu-section">
                <div class="menu-section-title">Atendimento</div>
                <a href="#" class="menu-item" data-model="leads">
                    <svg class="menu-item-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                    <span class="menu-item-text">Leads</span>
                </a>
                <a href="#" class="menu-item" data-model="chamados">
                    <svg class="menu-item-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                    <span class="menu-item-text">Chamados</span>
                </a>
            </div>

            <div class="menu-section">
                <div class="menu-section-title">Processos</div>
                <a href="#" class="menu-item" data-model="abertura">
                    <svg class="menu-item-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <span class="menu-item-text">Abertura de Empresa</span>
                </a>
                <a href="#" class="menu-item" data-model="dados-empresa">
                    <svg class="menu-item-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                    </svg>
                    <span class="menu-item-text">Dados da Empresa</span>
                </a>
                <a href="#" class="menu-item" data-model="servicos-mei">
                    <svg class="menu-item-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
                    </svg>
                    <span class="menu-item-text">Serviços MEI</span>
                    <span class="menu-badge" id="badge-servicos-mei" style="display: none; background: #EF4444; color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 10px; margin-left: auto;">0</span>
                </a>
            </div>

            <div class="menu-section">
                <div class="menu-section-title">Operacional</div>
                <a href="#" class="menu-item" data-model="agenda">
                    <svg class="menu-item-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    <span class="menu-item-text">Agenda</span>
                </a>
                <a href="#" class="menu-item" data-model="staff-tasks">
                    <svg class="menu-item-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                    </svg>
                    <span class="menu-item-text">Quadros / Tarefas</span>
                </a>
                <a href="#" class="menu-item" data-model="servicos-avulsos">
                    <svg class="menu-item-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>
                    </svg>
                    <span class="menu-item-text">Serviços Avulsos</span>
                    <span class="menu-badge" id="badge-servicos-avulsos" style="display: none; background: #EF4444; color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 10px; margin-left: auto;">0</span>
                </a>
            </div>
        </nav>
    </aside>

    <!-- Área de Conteúdo -->
    <main class="content-area">
        <div id="alertContainer"></div>

        <div class="content-header">
            <h1 class="content-title" id="content-title">Leads</h1>
            <p class="content-subtitle" id="content-subtitle">Gerencie todos os leads capturados do site</p>
        </div>

        <div class="actions-bar">
            <div class="search-box">
                <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                </svg>
                <input type="text" id="searchInput" placeholder="Buscar...">
            </div>
            <button class="btn-primary" id="btnAddNew">
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
                <span id="btnAddNewText">Adicionar Novo</span>
            </button>
        </div>

        <!-- Dashboard Stats Section -->
        <div class="stats-container" id="dashboardStats" style="display: none;">
            <!-- Dados carregados via JS -->
            <div class="stat-card" onclick="openActiveClientsModal()">
                <div class="stat-title">Clientes Ativos</div>
                <div class="stat-value" id="stat-total">0</div>
            </div>
            <div class="stat-card" onclick="openRegimeModal('MEI', 'Microempreendedor (MEI)')">
                <div class="stat-title">Microempreendedor (MEI)</div>
                <div class="stat-value" id="stat-mei">0</div>
            </div>
            <div class="stat-card" onclick="openRegimeModal('SN', 'Simples Nacional')">
                <div class="stat-title">Simples Nacional</div>
                <div class="stat-value" id="stat-simples">0</div>
            </div>
            <div class="stat-card" onclick="openRegimeModal('LP', 'Lucro Presumido')">
                <div class="stat-title">Lucro Presumido</div>
                <div class="stat-value" id="stat-presumido">0</div>
            </div>
            <div class="stat-card" onclick="openRegimeModal('LR', 'Lucro Real')">
                <div class="stat-title">Lucro Real</div>
                <div class="stat-value" id="stat-real">0</div>
            </div>
            <div class="stat-card" style="cursor: default;" onclick="event.stopPropagation()">
                <div class="stat-title">Por Plano</div>
                <div style="font-size: 0.8rem; color: #4b5563;" id="stat-planos">
                    <!-- Lista de planos -->
                    Carregando...
                </div>
            </div>
        </div>

        <div class="data-card" id="dataCard" style="display: none;">
            <table class="data-table" id="dataTable">
                <thead id="tableHead">
                    <!-- Headers serão carregados dinamicamente -->
                </thead>
                <tbody id="tableBody">
                    <!-- Dados serão carregados aqui via JavaScript -->
                </tbody>
            </table>
        </div>
        
        <!-- Container do Calendário (Agenda) -->
        <div id="calendarContainer" style="display: none; height: 800px; padding: 20px; background: white; border-radius: 8px;">
            <div id="calendar"></div>
        </div>
    </main>
</div>
</div>

<!-- Modal de Detalhes do Processo de Abertura -->
<div class="modal-overlay" id="processoAberturaModal">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
            <h3 class="modal-title" id="processoTitle">Detalhes do Processo</h3>
            <button class="modal-close" onclick="closeProcessoAberturaModal()">
                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <div class="modal-body" id="processoBody">
            <div style="text-align: center; padding: 20px;">Carregando...</div>
        </div>
    </div>
</div>

<!-- Modal de Chamado Detalhes -->
<div class="modal-overlay" id="chamadoModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="chamadoTitle"></h3>
            <button class="modal-close" onclick="closeChamadoModal()">
                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <div id="chamadoInfo" style="margin-bottom: 24px;">
                <!-- Informações do chamado -->
            </div>
            
            <div class="chat-container" id="chatContainer">
                <!-- Mensagens serão carregadas aqui -->
            </div>

            <div class="form-group">
                <label class="form-label" for="respondMessage">Responder ao Cliente</label>
                <textarea class="form-control" id="respondMessage" rows="4" placeholder="Digite sua resposta..."></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="closeChamadoModal()">Fechar</button>
            <button class="btn-primary" onclick="sendResponse()">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                </svg>
                Enviar Resposta
            </button>
        </div>
    </div>
</div>

<!-- Modal de Tarefa Staff -->
<div class="modal-overlay" id="staffTaskModal">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h3 class="modal-title">Nova Tarefa Interna</h3>
            <button class="modal-close" onclick="closeStaffTaskModal()">
                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <form id="staffTaskForm">
                <div class="form-group">
                    <label class="form-label" for="staffTaskTitle">Título da Tarefa *</label>
                    <input type="text" class="form-control" id="staffTaskTitle" required placeholder="Ex: Pendente da Receita Federal">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="staffTaskClients">Clientes Envolvidos</label>
                    <select class="form-control" id="staffTaskClients" multiple style="height: 150px;">
                        <!-- Clientes carregados via JS -->
                    </select>
                    <small style="color: var(--text-secondary); display: block; margin-top: 4px;">Segure Ctrl para selecionar múltiplos</small>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label class="form-label" for="staffTaskPriority">Prioridade</label>
                        <select class="form-control" id="staffTaskPriority">
                            <option value="low">Baixa</option>
                            <option value="medium" selected>Média</option>
                            <option value="high">Alta</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="staffTaskDueDate">Data de Vencimento</label>
                        <input type="date" class="form-control" id="staffTaskDueDate">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="staffTaskDescription">Descrição Adicional</label>
                    <textarea class="form-control" id="staffTaskDescription" rows="3" placeholder="Detalhes da tarefa..."></textarea>
                </div>
                
                <div class="modal-footer" style="padding: 0; margin-top: 24px;">
                    <button type="button" class="btn-secondary" onclick="closeStaffTaskModal()">Cancelar</button>
                    <button type="submit" class="btn-primary">Criar Tarefa</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal de Nova Agenda -->
<div class="modal-overlay" id="agendaModal">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h3 class="modal-title">Nova Agenda</h3>
            <button class="modal-close" onclick="closeAgendaModal()">
                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <form id="agendaForm">
                <input type="hidden" id="agendaId">
                <div class="form-group">
                    <label class="form-label" for="agendaTitulo">Título da Agenda *</label>
                    <input type="text" class="form-control" id="agendaTitulo" required placeholder="Ex: Reunião Mensal">
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label class="form-label" for="agendaDataInicio">Data/Hora Início *</label>
                        <input type="datetime-local" class="form-control" id="agendaDataInicio" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="agendaDataFim">Data/Hora Fim</label>
                        <input type="datetime-local" class="form-control" id="agendaDataFim">
                    </div>
                </div>

                <div class="form-group" style="display: flex; align-items: center; gap: 10px; margin-top: 10px;">
                    <input type="checkbox" id="agendaRecorrente" style="width: auto;">
                    <label for="agendaRecorrente" style="margin-bottom: 0;">Repetir Mensalmente (Recorrente)</label>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="agendaDescricao">Descrição</label>
                    <textarea class="form-control" id="agendaDescricao" rows="3" placeholder="Detalhes da agenda..."></textarea>
                </div>
                
                <div class="modal-footer" style="padding: 0; margin-top: 24px;">
                    <button type="button" class="btn-secondary" onclick="closeAgendaModal()">Cancelar</button>
                    <button type="submit" class="btn-primary">Salvar Agenda</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal de Clientes Ativos e Regimes (Popup) -->
<div class="modal-overlay" id="activeClientsModal">
    <div class="modal-content" style="max-width: 800px; height: 80vh; display:flex; flex-direction:column;">
        <div class="modal-header">
            <h3 class="modal-title" id="activeClientsModalTitle">Clientes Ativos</h3>
            <button class="modal-close" onclick="closeActiveClientsModal()">
                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
        </div>
        <div class="modal-body" style="flex:1; overflow-y:auto; padding:0;">
             <div style="padding: 16px; border-bottom: 1px solid #dfe1e6; position:sticky; top:0; background:white;">
                <input type="text" id="activeClientsSearch" placeholder="Buscar cliente por nome..." class="form-control" onkeyup="filterActiveClientsList()">
             </div>
             <div id="activeClientsList" class="items-list" style="padding: 16px;">
                <!-- Lista -->
             </div>
        </div>
    </div>
</div>

<!-- Modal de Enviar Nota Fiscal -->
<div class="modal-overlay" id="nfModal">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h3 class="modal-title">Enviar Nota Fiscal</h3>
            <button class="modal-close" onclick="closeNFModal()">
                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <form id="nfForm" enctype="multipart/form-data">
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="nfCliente">Cliente *</label>
                    <select class="form-control" id="nfCliente" required>
                        <option value="">Selecione um cliente...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="nfArquivo">Arquivo da Nota Fiscal * (PDF, XML ou ZIP)</label>
                    <input type="file" class="form-control" id="nfArquivo" accept=".pdf,.xml,.zip" required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="nfObservacoes">Observações (opcional)</label>
                    <textarea class="form-control" id="nfObservacoes" rows="3" placeholder="Informações adicionais sobre a nota fiscal..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeNFModal()">Cancelar</button>
                <button type="submit" class="btn-primary">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                    </svg>
                    Enviar Nota Fiscal
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal de Documento da Empresa -->
<div class="modal-overlay" id="documentoEmpresaModal">
    <div class="modal-content" style="max-width: 550px;">
        <div class="modal-header">
            <h3 class="modal-title">Enviar Documento da Empresa</h3>
            <button class="modal-close" onclick="closeDocumentoEmpresaModal()">
                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <form id="documentoEmpresaForm" enctype="multipart/form-data">
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="docEmpresaCliente">Cliente *</label>
                    <select class="form-control" id="docEmpresaCliente" required>
                        <option value="">Selecione um cliente...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="docEmpresaTitulo">Título do Documento *</label>
                    <input type="text" class="form-control" id="docEmpresaTitulo" placeholder="Ex: Contrato Social da Empresa" required>
                    <small style="color: var(--text-secondary); font-size: 0.875rem;">Nome descritivo do documento</small>
                </div>

                <div class="form-group">
                    <label class="form-label" for="docEmpresaCategoria">Categoria *</label>
                    <select class="form-control" id="docEmpresaCategoria" required>
                        <option value="">Selecione a categoria...</option>
                        <option value="contrato_social">📋 Contrato Social</option>
                        <option value="alvara">🏢 Alvará</option>
                        <option value="certidao">📜 Certidão</option>
                        <option value="procuracao">✍️ Procuração</option>
                        <option value="registro">📝 Registro</option>
                        <option value="declaracao">📄 Declaração</option>
                        <option value="relatorio">📊 Relatório</option>
                        <option value="outros">📁 Outros</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="docEmpresaArquivo">Arquivo *</label>
                    <input type="file" class="form-control" id="docEmpresaArquivo" required>
                    <small style="color: var(--text-secondary); font-size: 0.875rem;">Aceita PDF, DOC, DOCX, XLS, XLSX, ZIP</small>
                </div>

                <div class="form-group">
                    <label class="form-label" for="docEmpresaDescricao">Descrição (opcional)</label>
                    <textarea class="form-control" id="docEmpresaDescricao" rows="2" placeholder="Informações adicionais sobre o documento..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeDocumentoEmpresaModal()">Cancelar</button>
                <button type="submit" class="btn-primary">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                    </svg>
                    Enviar Documento
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal de Certidão Negativa -->
<div class="modal-overlay" id="certidaoModal">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h3 class="modal-title">Enviar Certidão Negativa</h3>
            <button class="modal-close" onclick="closeCertidaoModal()">
                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <form id="certidaoForm" enctype="multipart/form-data">
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="certidaoCliente">Cliente *</label>
                    <select class="form-control" id="certidaoCliente" required>
                        <option value="">Selecione um cliente...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="certidaoTipo">Tipo de Certidão *</label>
                    <select class="form-control" id="certidaoTipo" required>
                        <option value="">Selecione o tipo...</option>
                        <option value="federal">🏛️ Certidão Federal</option>
                        <option value="estadual">🏢 Certidão Estadual</option>
                        <option value="trabalhista">👷 Certidão Trabalhista</option>
                        <option value="fgts">💼 Certidão FGTS</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="certidaoStatus">Status da Certidão *</label>
                    <select class="form-control" id="certidaoStatus" required>
                        <option value="negativa">✅ Negativa (Sem débitos)</option>
                        <option value="positiva">⚠️ Positiva (Com débitos)</option>
                        <option value="indisponivel">❌ Indisponível</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="certidaoArquivo">Arquivo da Certidão * (PDF ou ZIP)</label>
                    <input type="file" class="form-control" id="certidaoArquivo" accept=".pdf,.zip" required>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeCertidaoModal()">Cancelar</button>
                <button type="submit" class="btn-primary">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                    </svg>
                    Enviar Certidão
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal de Guia de Imposto -->
<div class="modal-overlay" id="guiaModal">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h3 class="modal-title">Enviar Guia de Imposto</h3>
            <button class="modal-close" onclick="closeGuiaModal()">
                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <form id="guiaForm" enctype="multipart/form-data">
            <div class="modal-body">
                <input type="hidden" id="guiaClienteVal" name="cliente_id">
                
                <div class="form-group">
                    <label class="form-label" for="guiaTipo">Tipo de Imposto *</label>
                    <select class="form-control" id="guiaTipo" name="tipo" required>
                        <option value="das">DAS</option>
                        <option value="inss">INSS</option>
                        <option value="fgts">FGTS</option>
                        <option value="irrf">IRRF</option>
                        <option value="iss">ISS</option>
                        <option value="icms">ICMS</option>
                         <option value="pis">PIS</option>
                         <option value="cofins">COFINS</option>
                         <option value="csll">CSLL</option>
                         <option value="irpj">IRPJ</option>
                        <option value="outros">Outros</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="guiaValor">Valor (R$) *</label>
                    <input type="number" step="0.01" class="form-control" id="guiaValor" name="valor" required>
                </div>
                
                <div class="form-group grid-2" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div>
                        <label class="form-label" for="guiaVencimento">Vencimento *</label>
                        <input type="date" class="form-control" id="guiaVencimento" name="vencimento" required>
                    </div>
                    <div>
                        <label class="form-label" for="guiaCompetencia">Competência *</label>
                        <input type="date" class="form-control" id="guiaCompetencia" name="competencia" required>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="guiaArquivo">Arquivo PDF *</label>
                    <input type="file" class="form-control" id="guiaArquivo" accept=".pdf" required>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeGuiaModal()">Cancelar</button>
                <button type="submit" class="btn-primary">Enviar Guia</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal Editar Dados da Empresa do Cliente -->
<div class="modal-overlay" id="clienteEmpresaModal">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <h3 class="modal-title">Dados da Empresa do Cliente</h3>
            <button class="modal-close" onclick="closeClienteEmpresaModal()">
                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <form id="clienteEmpresaForm">
            <input type="hidden" id="clienteEmpresaId" name="cliente_id">
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <!-- Info do Cliente -->
                <div style="background: #f8fafc; padding: 12px 16px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="font-weight: 600; color: #1e293b;" id="clienteEmpresaNome">Nome do Cliente</div>
                    <div style="font-size: 0.85rem; color: #64748b;" id="clienteEmpresaEmail">email@exemplo.com</div>
                </div>

                <!-- Dados da Empresa -->
                <h4 style="font-size: 0.9rem; font-weight: 600; color: #374151; margin-bottom: 12px; border-bottom: 1px solid #e5e7eb; padding-bottom: 8px;">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="vertical-align: middle; margin-right: 6px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                    </svg>
                    Dados da Empresa
                </h4>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label class="form-label" for="clienteCnpj">CNPJ</label>
                        <input type="text" class="form-control" id="clienteCnpj" placeholder="00.000.000/0000-00">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="clienteTelefone">Telefone</label>
                        <input type="text" class="form-control" id="clienteTelefone" placeholder="(00) 00000-0000">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="clienteRazaoSocial">Razão Social</label>
                    <input type="text" class="form-control" id="clienteRazaoSocial" placeholder="Razão Social da Empresa">
                </div>

                <div class="form-group">
                    <label class="form-label" for="clienteNomeFantasia">Nome Fantasia</label>
                    <input type="text" class="form-control" id="clienteNomeFantasia" placeholder="Nome Fantasia">
                </div>

                <div class="form-group">
                    <label class="form-label" for="clienteEndereco">Endereço Completo</label>
                    <textarea class="form-control" id="clienteEndereco" rows="2" placeholder="Rua, número, bairro, cidade - UF, CEP"></textarea>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label class="form-label" for="clienteFase">Fase de Abertura</label>
                        <select class="form-control" id="clienteFase">
                            <option value="fase_1">Fase 1 - Planejamento</option>
                            <option value="fase_2">Fase 2 - Viabilidade</option>
                            <option value="fase_3">Fase 3 - Registro</option>
                            <option value="fase_4">Fase 4 - Inscrições</option>
                            <option value="fase_5">Fase 5 - Licenças</option>
                            <option value="fase_6">Fase 6 - Tributário</option>
                            <option value="fase_7">Fase 7 - Concluído</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="clienteRegime">Regime Tributário</label>
                        <select class="form-control" id="clienteRegime">
                            <option value="SN">Simples Nacional</option>
                            <option value="LP">Lucro Presumido</option>
                            <option value="LR">Lucro Real</option>
                            <option value="MEI">MEI</option>
                        </select>
                    </div>
                </div>

                <!-- Endereço Virtual -->
                <h4 style="font-size: 0.9rem; font-weight: 600; color: #374151; margin: 20px 0 12px 0; border-bottom: 1px solid #e5e7eb; padding-bottom: 8px;">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="vertical-align: middle; margin-right: 6px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    Endereço Virtual
                </h4>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label class="form-label" for="clienteEndVirtualStatus">Status</label>
                        <select class="form-control" id="clienteEndVirtualStatus">
                            <option value="nao_contratado">Não Contratado</option>
                            <option value="ativo">Ativo</option>
                            <option value="vencido">Vencido</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="clienteEndVirtualValidade">Validade</label>
                        <input type="date" class="form-control" id="clienteEndVirtualValidade">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="clienteEndVirtualEndereco">Endereço Virtual</label>
                    <textarea class="form-control" id="clienteEndVirtualEndereco" rows="2" placeholder="Endereço virtual contratado"></textarea>
                </div>

                <!-- Certificado Digital -->
                <h4 style="font-size: 0.9rem; font-weight: 600; color: #374151; margin: 20px 0 12px 0; border-bottom: 1px solid #e5e7eb; padding-bottom: 8px;">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="vertical-align: middle; margin-right: 6px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                    </svg>
                    Certificado Digital
                </h4>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label class="form-label" for="clienteCertStatus">Status</label>
                        <select class="form-control" id="clienteCertStatus">
                            <option value="nao_contratado">Não Contratado</option>
                            <option value="ativo">Ativo</option>
                            <option value="vencido">Vencido</option>
                            <option value="a_vencer">Próximo ao Vencimento</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="clienteCertValidade">Validade</label>
                        <input type="date" class="form-control" id="clienteCertValidade">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="clienteCertTipo">Tipo de Certificado</label>
                    <input type="text" class="form-control" id="clienteCertTipo" placeholder="Ex: A1, A3, e-CPF, e-CNPJ">
                </div>

                <!-- Boletos da Contabilidade -->
                <h4 style="font-size: 0.9rem; font-weight: 600; color: #374151; margin: 20px 0 12px 0; border-bottom: 1px solid #e5e7eb; padding-bottom: 8px;">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="vertical-align: middle; margin-right: 6px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/>
                    </svg>
                    Boletos da Mensalidade
                </h4>
                
                <div id="boletosListContainer" style="margin-bottom: 16px;">
                    <div style="text-align: center; color: #9ca3af; padding: 16px 0;">
                        Carregando boletos...
                    </div>
                </div>

                <button type="button" class="btn-secondary" onclick="openEnviarBoletoModal()" style="width: 100%; margin-bottom: 8px;">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="vertical-align: middle; margin-right: 6px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    Enviar Novo Boleto
                </button>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeClienteEmpresaModal()">Cancelar</button>
                <button type="submit" class="btn-primary">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                    Salvar Alterações
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal Enviar Boleto -->
<div class="modal-overlay" id="enviarBoletoModal">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h3 class="modal-title">Enviar Boleto da Mensalidade</h3>
            <button class="modal-close" onclick="closeEnviarBoletoModal()">
                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <form id="enviarBoletoForm" enctype="multipart/form-data">
            <input type="hidden" id="boletoClienteId" name="cliente_id">
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="boletoReferencia">Mês de Referência *</label>
                    <input type="text" class="form-control" id="boletoReferencia" name="referencia" placeholder="Ex: Janeiro/2026" required>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label class="form-label" for="boletoValor">Valor (R$) *</label>
                        <input type="text" class="form-control" id="boletoValor" name="valor" placeholder="0,00" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="boletoVencimento">Data de Vencimento *</label>
                        <input type="date" class="form-control" id="boletoVencimento" name="data_vencimento" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="boletoArquivo">Arquivo do Boleto (PDF) *</label>
                    <input type="file" class="form-control" id="boletoArquivo" name="arquivo_boleto" accept=".pdf" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="boletoObservacoes">Observações</label>
                    <textarea class="form-control" id="boletoObservacoes" name="observacoes" rows="2" placeholder="Observações internas (opcional)"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeEnviarBoletoModal()">Cancelar</button>
                <button type="submit" class="btn-primary">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                    </svg>
                    Enviar Boleto
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Client Management Panel -->
<div class="client-panel-overlay" id="clientPanel">
    <div class="client-panel">
        <div class="client-panel-header">
            <div>
                <h2 class="client-panel-title" id="panelClientName">Cliente Nome</h2>
                <div style="font-size: 0.9rem; color: #5e6c84;" id="panelClientEmail">email@exemplo.com</div>
            </div>
            <div class="client-panel-close" onclick="closeClientPanel()">
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </div>
        </div>
        <div class="client-panel-content" style="padding: 0; display: block; overflow: hidden;">
            
            <!-- ABAS -->
            <div class="panel-tabs">
                <div class="panel-tab active" onclick="switchTab('tab-visao-geral')">
                    Visão Geral
                </div>
                <div class="panel-tab" onclick="switchTab('tab-fiscal')">
                    Fiscal (NFs)
                </div>
                <div class="panel-tab" onclick="switchTab('tab-financeiro')">
                    Financeiro
                </div>
                <div class="panel-tab" onclick="switchTab('tab-impostos')">
                    Impostos
                </div>
                 <div class="panel-tab" onclick="switchTab('tab-empresa')">
                    Minha Empresa
                </div>
                <div class="panel-tab" onclick="switchTab('tab-servicos-avulsos')">
                    Serv. Avulsos
                </div>
                <div class="panel-tab" onclick="switchTab('tab-atendimento')">
                    Atendimento
                </div>
            </div>

            <!-- CONTEÚDO DAS ABAS -->
            <div style="padding: 24px; overflow-y: auto; height: calc(100% - 60px);">
                
                <!-- TAB: VISÃO GERAL -->
                <div id="tab-visao-geral" class="tab-content active">
                     <!-- Card do Plano -->
                     <div class="panel-section">
                        <div class="panel-section-header">
                            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
                            Plano Atual
                        </div>
                        <div id="planInfoContainer" style="display: flex; justify-content: space-between; align-items: center;">
                            <div>Loading...</div>
                        </div>
                     </div>

                    <!-- Ações Rápidas -->
                    <div class="panel-section">
                        <div class="panel-section-header">
                            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                            Ações Rápidas
                        </div>
                        <div class="action-grid">
                            <div class="action-card" onclick="startAction('nf')">
                                <div style="font-size: 24px; margin-bottom: 8px;">📑</div>
                                <div style="font-weight: 500;">Enviar Nota Fiscal</div>
                            </div>
                            <div class="action-card" onclick="startAction('guia')">
                                <div style="font-size: 24px; margin-bottom: 8px;">💸</div>
                                <div style="font-weight: 500;">Enviar Guia</div>
                            </div>
                            <div class="action-card" onclick="startAction('doc')">
                                <div style="font-size: 24px; margin-bottom: 8px;">📁</div>
                                <div style="font-weight: 500;">Enviar Documento</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB: FISCAL (NFs) -->
                <div id="tab-fiscal" class="tab-content">
                    <div class="panel-section">
                        <div class="panel-section-header">
                            Notas Fiscais Enviadas/Recebidas
                            <button class="btn-primary" style="margin-left: auto; padding: 4px 12px; font-size: 0.8rem;" onclick="openNFModal(currentSelectedClientId)">Nova NF</button>
                        </div>
                        <div class="items-list" id="panelNFsList">Loading...</div>
                    </div>
                </div>

                <!-- TAB: FINANCEIRO -->
                <div id="tab-financeiro" class="tab-content">
                    <div class="panel-section">
                        <div class="panel-section-header">Extratos Bancários</div>
                        <div class="items-list" id="panelExtratosList">Loading...</div>
                    </div>
                     <div class="panel-section">
                        <div class="panel-section-header">Transmissões Mensais</div>
                        <div class="items-list" id="panelTransmissoesList">Loading...</div>
                    </div>
                </div>

                <!-- TAB: IMPOSTOS -->
                <div id="tab-impostos" class="tab-content">
                     <div class="panel-section">
                        <div class="panel-section-header">
                            Guias de Imposto
                             <button class="btn-primary" style="margin-left: auto; padding: 4px 12px; font-size: 0.8rem;" onclick="openGuiaModal(currentSelectedClientId)">Enviar Guia</button>
                        </div>
                        <div class="items-list" id="panelGuiasList">Loading...</div>
                    </div>
                     <div class="panel-section">
                        <div class="panel-section-header">
                            Certidões Negativas
                            <button class="btn-primary" style="margin-left: auto; padding: 4px 12px; font-size: 0.8rem;" onclick="openCertidaoModal(currentSelectedClientId)">Nova Certidão</button>
                        </div>
                        <div class="items-list" id="panelCertidoesList">Loading...</div>
                    </div>
                </div>

                <!-- TAB: EMPRESA -->
                <div id="tab-empresa" class="tab-content">
                    <div class="panel-section">
                        <div class="panel-section-header">Status de Abertura</div>
                        <div id="panelAberturaStatus">Loading...</div>
                    </div>
                    <div class="panel-section">
                        <div class="panel-section-header">
                            Documentos da Empresa
                            <button class="btn-primary" style="margin-left: auto; padding: 4px 12px; font-size: 0.8rem;" onclick="openDocumentoEmpresaModal(currentSelectedClientId)">Enviar Documento</button>
                        </div>
                         <div class="items-list" id="panelDocsEmpresaList">Loading...</div>
                    </div>
                </div>

                <!-- TAB: SERVIÇOS AVULSOS -->
                <div id="tab-servicos-avulsos" class="tab-content">
                    <div class="panel-section">
                        <div class="panel-section-header">
                            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                            </svg>
                            Serviços Avulsos Contratados
                        </div>
                        <div class="items-list" id="panelServicosAvulsosList">
                            <div style="text-align: center; padding: 20px; color: #6b7280;">
                                Carregando...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB: ATENDIMENTO -->
                <div id="tab-atendimento" class="tab-content">
                    <div class="panel-section">
                        <div class="panel-section-header">Chamados em Aberto</div>
                         <div class="items-list" id="panelChamadosList">Loading...</div>
                    </div>
                </div>
            
            </div>
        </div>
    </div>
</div>

<script>
    let currentModel = 'clientes'; // Mudança para Clientes
    let currentSelectedClientId = null;

    // === CLIENT BOARD FUNCTIONS ===

    function renderClientsBoard() {
        console.log('Rendering Clients Board', currentData);
        const container = document.getElementById('dataCard');
        container.innerHTML = '';
        container.classList.remove('data-card');
        container.style.background = 'transparent';
        container.style.boxShadow = 'none';
        
        if (currentData.length === 0) {
            container.innerHTML = `
                <div style="padding: 20px; text-align: center; background: #fff; border-radius: 8px;">
                    <h3>Nenhum cliente encontrado</h3>
                    <p>Verifique se os usuários estão ativos e não são superusuários.</p>
                </div>
            `;
            return;
        }

        // Definir colunas baseadas em Fase ou Status
        const columns = [
            { id: 'fase_1', title: 'Fase 1 - Planejamento', color: '#6B7280' },
            { id: 'fase_2', title: 'Fase 2 - Viabilidade', color: '#6B7280' },
            { id: 'fase_3', title: 'Fase 3 - Registro', color: '#6B7280' },
            { id: 'fase_4', title: 'Fase 4 - Inscrições', color: '#6B7280' },
            { id: 'ativos', title: 'Clientes Ativos', color: '#10B981' } // Fallback/Main
        ];

        const board = document.createElement('div');
        board.className = 'kanban-container';
        
        columns.forEach(col => {
            const colItems = currentData.filter(item => {
                const f = (item.fase || '').toString().toLowerCase();
                const cid = col.id.toLowerCase();
                
                if (cid === 'ativos') {
                     // Show in Ativos if it's NOT one of the specific phases, OR if it's explicitly actives/fase_7
                    const knownPhases = ['fase_1', 'fase_2', 'fase_3', 'fase_4'];
                    if (!knownPhases.includes(item.fase)) return true;
                    return false;
                }
                return item.fase === col.id;
            });
            
            // Show all columns for structure, or hide empty ones if preferred
            // if (colItems.length === 0 && col.id !== 'ativos') return;

            const colDiv = document.createElement('div');
            colDiv.className = 'kanban-column';
            
            colDiv.innerHTML = `
                <div class="kanban-column-header">
                    <h3 class="kanban-column-title">${col.title}</h3>
                    <span class="kanban-column-count">${colItems.length}</span>
                </div>
                <div class="kanban-column-content">
                    ${colItems.map(item => createClientCardHTML(item)).join('')}
                </div>
            `;
            board.appendChild(colDiv);
        });

        container.appendChild(board);
    }

    function createClientCardHTML(item) {
        const initials = (item.nome || '?').split(' ').map(n=>n[0]).join('').substring(0,2).toUpperCase();
        const safeName = (item.nome || '').replace(/'/g, "\\'");
        return `
            <div class="client-card" onclick="openClientPanel(${item.id}, '${safeName}', '${item.email}')">
                <div style="display: flex; gap: 10px; align-items: center;">
                    <div class="client-avatar">${initials}</div>
                    <div style="overflow: hidden;">
                        <div class="client-name">${item.nome}</div>
                        <div class="client-email">${item.email}</div>
                    </div>
                </div>
            </div>
        `;
    }

    // === CLIENT PANEL LOGIC ===
    
    function switchTab(tabId) {
        const tabs = document.querySelectorAll('.panel-tab');
        const contents = document.querySelectorAll('.tab-content');
        
        tabs.forEach(t => t.classList.remove('active'));
        contents.forEach(c => c.classList.remove('active'));
        
        // Find tab element (this might be called from onclick)
        const targetTab = Array.from(tabs).find(t => t.getAttribute('onclick').includes(tabId));
        if(targetTab) targetTab.classList.add('active');
        
        document.getElementById(tabId).classList.add('active');
    }

    async function openClientPanel(id, nome, email) {
        currentSelectedClientId = id;
        document.getElementById('panelClientName').textContent = nome;
        document.getElementById('panelClientEmail').textContent = email;
        document.getElementById('clientPanel').style.display = 'flex';
        
        // Reset Tab to first one
        document.querySelectorAll('.panel-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelector('.panel-tab').classList.add('active'); 
        document.getElementById('tab-visao-geral').classList.add('active');

        // Loaders
        const loaders = ['panelNFsList', 'panelChamadosList', 'panelExtratosList', 'panelGuiasList', 
                         'panelCertidoesList', 'panelDocsEmpresaList', 'planInfoContainer', 'panelServicosAvulsosList'];
        loaders.forEach(lId => {
            const el = document.getElementById(lId);
            if(el) el.innerHTML = '<div style="text-align: center; color: #5e6c84; padding: 20px;">Carregando...</div>';
        });
        
        // Setup Company Status from currentData cache
        const client = currentData.find(c => c.id === id);
        const statusDiv = document.getElementById('panelAberturaStatus');
        if(client && statusDiv) {
             statusDiv.innerHTML = `
                <div style="padding: 16px; background: #eff6ff; border-radius: 8px; border: 1px solid #dbeafe;">
                    <div style="color: #1e40af; font-weight: 600; margin-bottom: 4px;">Fase Atual</div>
                    <div style="font-size: 1.1rem; color: #1e3a8a; margin-bottom: 8px;">${client.fase_display || 'Não identificada'}</div>
                    
                    <div style="display: flex; gap: 8px; align-items: center; margin-top: 12px; border-top: 1px solid #dbeafe; padding-top: 12px;">
                        <div style="flex:1;">
                            <label style="font-size: 0.8rem; color: #5e6c84; display:block; margin-bottom: 4px;">Alterar Fase:</label>
                            <select id="changePhaseSelect" class="form-control" style="font-size: 0.9rem; padding: 6px;">
                                <option value="fase_1" ${client.fase=='fase_1'?'selected':''}>Fase 1 - Planejamento</option>
                                <option value="fase_2" ${client.fase=='fase_2'?'selected':''}>Fase 2 - Viabilidade</option>
                                <option value="fase_3" ${client.fase=='fase_3'?'selected':''}>Fase 3 - Registro</option>
                                <option value="fase_4" ${client.fase=='fase_4'?'selected':''}>Fase 4 - Inscrições</option>
                                <option value="fase_7" ${client.fase=='fase_7'?'selected':''}>Fase 7 - Ativa</option>
                            </select>
                        </div>
                        <button class="btn-primary" style="padding: 8px 16px; height: 38px; margin-top: 18px;" onclick="updateClientPhase(${client.id})">Salvar</button>
                    </div>
                </div>
             `;
        }

        // --- FETCH DATA ---
        
        // 1. Chamados
        fetch(`${API_BASE}/chamados/`)
            .then(r=>r.json())
            .then(d => {
                if(d.success) renderPanelChamados(d.data.filter(c => c.cliente_email === email));
            });

        // 2. NFs
        fetch(`${API_BASE}/notas-fiscais/`)
            .then(r=>r.json())
            .then(d => {
                if(d.success) renderPanelNFs(d.data.filter(n => n.cliente_email === email));
            });

        // 3. Extratos (Requires ID)
        fetch(`${API_BASE}/extratos-bancarios/clientes/${id}/`)
            .then(r=>r.json())
            .then(d => {
                if(d.success) renderPanelExtratos(d.data);
            });
            
        // 3b. Transmissões (Movimentações)
        fetch(`${API_BASE}/contabilidade/clientes/${id}/movimentacoes/`)
            .then(r=>r.json())
            .then(d => {
                 if(d.success) renderPanelTransmissoes(d.data);
            });

        // 4. Guias (New Endpoint)
        fetch(`${API_BASE}/guias/`)
            .then(r=>r.json())
            .then(d => {
                if(d.success) renderPanelGuias(d.data.filter(g => g.cliente_email === email));
            });

        // 5. Certidões
        fetch(`${API_BASE}/certidoes/`)
            .then(r=>r.json())
            .then(d => {
                if(d.success) renderPanelCertidoes(d.data.filter(c => c.cliente_email === email));
            });
            
        // 6. Docs Empresa
        fetch(`${API_BASE}/documentos-empresa/`)
            .then(r=>r.json())
            .then(d => {
                if(d.success) renderPanelDocsEmpresa(d.data.filter(d => d.cliente_email === email));
            });
            
        // 7. Plano Details
        fetch(`${API_BASE}/cliente-assinatura/${id}/`)
            .then(r=>r.json())
            .then(d => {
                if(d.success) renderPanelPlano(d.data, d.planos_disponiveis);
            });

        // 8. Serviços Avulsos
        fetch(`${API_BASE}/servicos-avulsos/?cliente_id=${id}`)
            .then(r=>r.json())
            .then(d => {
                if(d.success) renderPanelServicosAvulsos(d.contratacoes);
            });
    }

    function closeClientPanel() {
        document.getElementById('clientPanel').style.display = 'none';
        currentSelectedClientId = null;
    }
    
    // --- RENDER FUNCTIONS ---

    function renderPanelGuias(list) {
        const container = document.getElementById('panelGuiasList');
        if(!list || list.length === 0) {
            container.innerHTML = '<div class="empty-state">Nenhuma guia encontrada.</div>'; return;
        }
        container.innerHTML = list.map(item => `
            <div class="list-item">
                <div>
                     <div style="font-weight: 600;">${item.tipo} - ${item.competencia}</div>
                     <div style="font-size: 0.8rem; color: #5e6c84;">Venc: ${item.vencimento} | R$ ${item.valor}</div>
                </div>
                 <div style="display: flex; gap: 8px; align-items: center;">
                    <span class="status-badge status-${item.status_raw}">${item.status}</span>
                    ${item.arquivo_url ? `<a href="${item.arquivo_url}" target="_blank">PDF</a>` : ''}
                </div>
            </div>
        `).join('');
    }

    function renderPanelExtratos(list) {
         const container = document.getElementById('panelExtratosList');
        if(!list || list.length === 0) {
            container.innerHTML = '<div class="empty-state">Nenhum extrato encontrado.</div>'; return;
        }
        container.innerHTML = list.map(item => `
            <div class="list-item">
                <div>
                     <div style="font-weight: 600;">Extrato ${item.mes_ano || ''}</div>
                     <div style="font-size: 0.8rem; color: #5e6c84;">Enviado em: ${item.data_upload}</div>
                </div>
                ${item.arquivo_url ? `<a href="${item.arquivo_url}" target="_blank">Baixar</a>` : ''}
            </div>
        `).join('');
    }

    function renderPanelTransmissoes(list) {
        const container = document.getElementById('panelTransmissoesList');
        if(!list || list.length === 0) {
            container.innerHTML = '<div class="empty-state">Nenhuma movimentação/transmissão.</div>'; return;
        }
        container.innerHTML = list.map(item => `
            <div class="list-item">
                 <div>
                     <div style="font-weight: 600;">Competência ${item.mes_ano || ''}</div>
                     <div style="font-size: 0.8rem; color: #5e6c84;">Saldo: ${item.saldo_formatado}</div>
                </div>
               <div style="font-size: 0.8rem; font-weight: 500;">Rec: ${item.total_receitas_formatado} | Desp: ${item.total_despesas_formatado}</div>
            </div>
        `).join('');
    }
    
    function renderPanelCertidoes(list) {
         const container = document.getElementById('panelCertidoesList');
        if(!list || list.length === 0) {
            container.innerHTML = '<div class="empty-state">Nenhuma certidão.</div>'; return;
        }
        container.innerHTML = list.map(item => `
            <div class="list-item">
                 <div>
                     <div style="font-weight: 600;">${item.tipo}</div>
                     <div style="font-size: 0.8rem; color: #5e6c84;">${item.data_envio}</div>
                </div>
                <a href="${item.arquivo_url}" target="_blank">Ver</a>
            </div>
        `).join('');
    }

    function renderPanelDocsEmpresa(list) {
         const container = document.getElementById('panelDocsEmpresaList');
        if(!list || list.length === 0) {
            container.innerHTML = '<div class="empty-state">Nenhum documento.</div>'; return;
        }
        container.innerHTML = list.map(item => `
            <div class="list-item">
                 <div>
                     <div style="font-weight: 600;">${item.titulo}</div>
                     <div style="font-size: 0.8rem; color: #5e6c84;">${item.categoria}</div>
                </div>
                ${item.arquivo_url ? `<a href="${item.arquivo_url}" target="_blank">Baixar</a>` : ''}
            </div>
        `).join('');
    }

    function renderPanelServicosAvulsos(list) {
        const container = document.getElementById('panelServicosAvulsosList');
        if(!list || list.length === 0) {
            container.innerHTML = '<div class="empty-state" style="text-align: center; padding: 30px; color: #6b7280;">Nenhum serviço avulso contratado.</div>'; 
            return;
        }
        
        const statusColors = {
            'pendente': { bg: '#fef3c7', text: '#92400e' },
            'aguardando_pagamento': { bg: '#fef3c7', text: '#92400e' },
            'em_andamento': { bg: '#dbeafe', text: '#1e40af' },
            'concluido': { bg: '#d1fae5', text: '#065f46' },
            'cancelado': { bg: '#fee2e2', text: '#991b1b' }
        };
        
        container.innerHTML = list.map(item => {
            const statusStyle = statusColors[item.status] || { bg: '#f3f4f6', text: '#374151' };
            return `
            <div class="list-item" style="padding: 16px; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 8px;">
                <div style="flex: 1;">
                    <div style="font-weight: 600; font-size: 1rem; margin-bottom: 4px;">${item.servico_titulo}</div>
                    <div style="font-size: 0.85rem; color: #6b7280; margin-bottom: 6px;">
                        R$ ${item.valor_contratado.toFixed(2).replace('.', ',')} • ${item.criado_em}
                    </div>
                    ${item.observacoes_cliente ? `<div style="font-size: 0.8rem; color: #9ca3af; margin-top: 4px; font-style: italic;">"${item.observacoes_cliente}"</div>` : ''}
                </div>
                <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 8px;">
                    <span style="display: inline-flex; align-items: center; padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; font-weight: 500; background: ${statusStyle.bg}; color: ${statusStyle.text};">
                        ${item.status_display}
                    </span>
                    <select onchange="updateServicoAvulsoStatus(${item.id}, this.value)" style="font-size: 0.8rem; padding: 4px 8px; border-radius: 4px; border: 1px solid #d1d5db;">
                        <option value="pendente" ${item.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                        <option value="em_andamento" ${item.status === 'em_andamento' ? 'selected' : ''}>Em Andamento</option>
                        <option value="concluido" ${item.status === 'concluido' ? 'selected' : ''}>Concluído</option>
                        <option value="cancelado" ${item.status === 'cancelado' ? 'selected' : ''}>Cancelado</option>
                    </select>
                </div>
            </div>
        `;
        }).join('');
    }

    async function updateServicoAvulsoStatus(id, newStatus) {
        try {
            const res = await fetch(`${API_BASE}/servicos-avulsos/${id}/update/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify({ status: newStatus })
            });
            const data = await res.json();
            if (data.success) {
                showNotification('Status atualizado!', 'success');
                // Reload serviços avulsos
                if (currentSelectedClientId) {
                    fetch(`${API_BASE}/servicos-avulsos/?cliente_id=${currentSelectedClientId}`)
                        .then(r=>r.json())
                        .then(d => {
                            if(d.success) renderPanelServicosAvulsos(d.contratacoes);
                        });
                }
            } else {
                showNotification(data.error || 'Erro ao atualizar', 'error');
            }
        } catch(e) {
            showNotification('Erro de conexão', 'error');
        }
    }
    
    function renderPanelPlano(currentPlan, availablePlans) {
        const container = document.getElementById('planInfoContainer');
        window.availablePlans = availablePlans; // Store for context
        
        // Helper to generate options
        const getOptions = (selectedId) => {
             if(!availablePlans || availablePlans.length === 0) return '<option value="">Nenhum plano cadastrado</option>';
             return availablePlans.map(p => 
                `<option value="${p.id}" ${(selectedId && p.id == selectedId) ? 'selected' : ''}>${p.nome} (R$ ${p.preco})</option>`
             ).join('');
        };

        let html = '';

        if(!currentPlan) {
            // Caso: Sem plano ativo
            html = `
                <div style="margin-bottom: 12px;">
                     <div style="font-weight: 600; color: #EF4444; margin-bottom: 4px;">Sem plano ativo</div>
                     <div style="font-size: 0.85rem; color: #5e6c84;">Selecione um plano para ativar:</div>
                </div>
                <div style="display:flex; flex-direction: column; gap: 8px;">
                    <select id="newPlanSelect" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #dfe1e6; background: white;">
                        <option value="">-- Selecione o Plano --</option>
                        ${getOptions(null)}
                    </select>
                    <button class="btn-primary" style="width: 100%; justify-content: center; padding: 8px;" onclick="submitPlanChange(false)">
                        Ativar Plano
                    </button>
                </div>
            `;
        } else {
            // Caso: Plano Ativo (Mostrar info e botão alterar)
            html = `
                <div id="planDisplayMode">
                    <div style="margin-bottom: 12px;">
                         <div style="font-weight: 700; color: #10B981; font-size: 1.1rem; margin-bottom: 4px;">${currentPlan.plano_nome}</div>
                         <div style="font-size: 0.85rem; color: #5e6c84; display: flex; flex-direction: column; gap: 2px;">
                            <span>📅 Ativo desde ${currentPlan.data_inicio}</span>
                            <span>💰 R$ ${currentPlan.valor}/mês</span>
                            <span>STATUS: <strong style="color: #10B981;">${currentPlan.status || 'ATIVO'}</strong></span>
                         </div>
                    </div>
                    <button class="btn-secondary" style="width: 100%; padding: 8px; font-size: 0.9rem;" onclick="togglePlanEditMode(true)">Alterar Plano</button>
                </div>
                
                <div id="planEditMode" style="display:none;">
                    <div style="font-size: 0.9rem; font-weight: 600; color: #172b4d; margin-bottom: 8px;">Alterar Plano</div>
                    <div style="display:flex; flex-direction: column; gap: 8px;">
                        <select id="changePlanSelect" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #dfe1e6; background: white;">
                             ${getOptions(currentPlan.plano_id)}
                        </select>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn-primary" style="flex: 1; justify-content: center; padding: 8px;" onclick="submitPlanChange(true)">Salvar</button>
                            <button class="btn-secondary" style="flex: 1; padding: 8px;" onclick="togglePlanEditMode(false)">Cancelar</button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        container.innerHTML = html;
    }
    
    function togglePlanEditMode(show) {
        document.getElementById('planDisplayMode').style.display = show ? 'none' : 'block';
        document.getElementById('planEditMode').style.display = show ? 'block' : 'none';
    }

    function submitPlanChange(isEdit) {
        const selectId = isEdit ? 'changePlanSelect' : 'newPlanSelect';
        const selectEl = document.getElementById(selectId);
        const newPlanId = selectEl.value;
        const button = isEdit ? document.querySelector('#planEditMode .btn-primary') : document.querySelector('#planInfoContainer .btn-primary');
        
        if(!newPlanId) {
            alert('Por favor, selecione um plano da lista.');
            return;
        }

        const originalText = button.textContent;
        button.textContent = 'Salvando...';
        button.disabled = true;

        const formData = new FormData();
        formData.append('cliente_id', currentSelectedClientId);
        formData.append('plano_id', newPlanId);
        
        fetch(`${API_BASE}/cliente-assinatura/update/`, {
            method: 'POST',
            headers: {'X-CSRFToken': csrftoken},
            body: formData
        }).then(r=>r.json()).then(d => {
            if(d.success) {
                // Reload plan info
                 fetch(`${API_BASE}/cliente-assinatura/${currentSelectedClientId}/`)
                    .then(r=>r.json()).then(newData => renderPanelPlano(newData.data, newData.planos_disponiveis));
                 // showAlert('Plano atualizado com sucesso!'); // Optional
            } else {
                alert('Erro: ' + (d.error || 'Erro desconhecido'));
                button.textContent = originalText;
                button.disabled = false;
            }
        }).catch(err => {
            console.error(err);
            alert('Erro de conexão ao atualizar plano.');
            button.textContent = originalText;
            button.disabled = false;
        });
    }

    /* REMOVED promptUpdatePlan OLD FUNCTION */

    function renderPanelChamados(list) {
        const container = document.getElementById('panelChamadosList');
        if(!list || list.length === 0) {
            container.innerHTML = '<div style="text-align: center; color: #5e6c84; padding: 10px;">Nenhum chamado recente.</div>';
            return;
        }
        
        container.innerHTML = list.slice(0, 10).map(c => `
            <div class="list-item" onclick="viewChamado(${c.id})" style="cursor: pointer; transition: background 0.2s;">
                <div>
                     <div style="font-weight: 600; font-size: 0.9rem; color: #172b4d;">${c.titulo}</div>
                     <div style="font-size: 0.8rem; color: #5e6c84;">${c.protocolo} - <span class="status-badge status-${c.status_raw || 'aberto'}">${c.status}</span></div>
                </div>
                <div style="font-size: 0.8rem; color: #5e6c84;">${c.data_criacao}</div>
            </div>
        `).join('');
    }

    function renderPanelNFs(list) {
         const container = document.getElementById('panelNFsList');
        if(!list || list.length === 0) {
            container.innerHTML = '<div style="text-align: center; color: #5e6c84; padding: 10px;">Nenhuma nota fiscal recente.</div>';
            return;
        }

        container.innerHTML = list.slice(0, 5).map(n => `
            <div class="list-item">
                 <div>
                     <div style="font-weight: 500; font-size: 0.9rem;">Nota Fiscal</div>
                     <div style="font-size: 0.8rem; color: #5e6c84;">${n.data_envio}</div>
                </div>
                 <a href="${n.arquivo_url}" target="_blank" style="text-decoration: none; color: #0079bf; font-weight: 600; font-size: 0.85rem;">Baixar XML/PDF</a>
            </div>
        `).join('');
    }

    function startAction(type) {
        if(!currentSelectedClientId) return;
        
        // Setup modals with client pre-selected
        if(type === 'nf') {
            document.getElementById('nfCliente').value = currentSelectedClientId;
            openNFModal(); // Reuse existing
            document.getElementById('nfModal').style.zIndex = '2100'; // Higher than panel
        } else if (type === 'certidao') {
            document.getElementById('certidaoCliente').value = currentSelectedClientId;
            openCertidaoModal(); 
            document.getElementById('certidaoModal').style.zIndex = '2100';
        } else if (type === 'doc') {
             document.getElementById('docEmpresaCliente').value = currentSelectedClientId;
             openDocumentoEmpresaModal();
             document.getElementById('documentoEmpresaModal').style.zIndex = '2100';
        }
    }
    let currentData = [];
    let calendar = null; 
    let currentChamadoId = null;
    let currentActiveRegime = 'all'; // For the modal

    const API_BASE = '/support/api';

    // Navegação do Menu
    document.querySelectorAll('.menu-item').forEach(item => {
        item.addEventListener('click', function(e) {
             e.preventDefault();
             document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
             this.classList.add('active');
             currentModel = this.dataset.model;
             loadModelData(currentModel);
        });
    });

    // Função para obter o CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // Mostrar alert
    function showAlert(message, type = 'success') {
        const alertContainer = document.getElementById('alertContainer');
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type}`;
        alertDiv.innerHTML = `
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${type === 'success' ? 'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z' : 'M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z'}"/>
            </svg>
            <span>${message}</span>
        `;
        alertContainer.appendChild(alertDiv);
        
        setTimeout(() => {
            alertDiv.remove();
        }, 5000);
    }

    // Configurações dos modelos
    const modelConfig = {
        clientes: {
            title: 'Gestão de Clientes',
            subtitle: 'Visualize e gerencie seus clientes ativos',
            endpoint: `${API_BASE}/clientes/`, // Backend updated previously
            btnText: 'Novo Cliente (Manual)',
            headers: []
        },
        leads: {
            title: 'Leads',
            subtitle: 'Gerencie todos os leads capturados do site',
            endpoint: `${API_BASE}/leads/`,
            btnText: 'Adicionar Novo Lead',
            headers: ['Nome', 'Email', 'Telefone', 'Cidade/Estado', 'Serviço', 'Origem', 'Status', 'Data', 'Ações']
        },
        chamados: {
            title: 'Tickets de Suporte',
            subtitle: 'Gerencie os tickets de suporte dos clientes',
            endpoint: `${API_BASE}/chamados/`,
            btnText: null,
            headers: ['Protocolo', 'Cliente', 'Assunto', 'Status', 'Prioridade', 'Mensagens', 'Data', 'Ações']
        },
        abertura: {
            title: 'Abertura de Empresa',
            subtitle: 'Gerencie os processos de abertura de empresa em andamento',
            endpoint: `${API_BASE}/processos-abertura/`,
            btnText: null,
            headers: ['ID', 'Cliente', 'Email', 'Telefone', 'Etapa', 'Status', 'Data Início', 'Ações']
        },
        'notas-fiscais': {
            title: 'Enviar Notas Fiscais',
            subtitle: 'Envie notas fiscais para os clientes',
            endpoint: null,
            btnText: 'Enviar Nova Nota Fiscal',
            headers: []
        },
        contabilidade: {
            title: 'Contabilidade',
            subtitle: 'Visualize as movimentações financeiras dos clientes',
            endpoint: null,
            btnText: null,
            headers: []
        },
        certidoes: {
            title: 'Certidões Negativas',
            subtitle: 'Envie certidões negativas para os clientes',
            endpoint: null,
            btnText: 'Enviar Nova Certidão',
            headers: []
        },
        agenda: {
            title: 'Agenda',
            subtitle: 'Gerencie compromissos e tarefas',
            endpoint: `${API_BASE}/agenda/`,
            btnText: 'Adicionar Agenda',
            headers: ['Data', 'Título', 'Descrição', 'Responsável', 'Recorrente', 'Status', 'Ações']
        },
        'documentos-empresa': {
            title: 'Documentos da Empresa',
            subtitle: 'Envie documentos da empresa para os clientes',
            endpoint: null,
            btnText: 'Enviar Novo Documento',
            headers: []
        },
        'dados-empresa': {
            title: 'Dados da Empresa',
            subtitle: 'Gerencie os dados cadastrais das empresas dos clientes',
            endpoint: `${API_BASE}/clientes/`,
            btnText: null,
            headers: ['Cliente', 'CNPJ', 'Razão Social', 'Fase', 'End. Virtual', 'Certificado', 'Ações']
        },
        'extratos-bancarios': {
            title: 'Extratos Bancários',
            subtitle: 'Visualize os extratos bancários enviados pelos clientes',
            endpoint: null,
            btnText: null,
            headers: []
        },
        'staff-tasks': {
            title: 'Tarefas Internas',
            subtitle: 'Gerencie tarefas internas da equipe',
            endpoint: `${API_BASE}/staff-tasks/`,
            btnText: 'Nova Tarefa',
            headers: []
        },
        'servicos-avulsos': {
            title: 'Serviços Avulsos',
            subtitle: 'Visualize e gerencie contratações de serviços avulsos',
            endpoint: `${API_BASE}/servicos-avulsos/`,
            btnText: null,
            headers: ['Cliente', 'Serviço', 'Valor', 'Status', 'Data', 'Ações']
        },
        'servicos-mei': {
            title: 'Serviços MEI',
            subtitle: 'Solicitações de Baixa do MEI e Declaração Anual MEI (DASN-SIMEI)',
            endpoint: `${API_BASE}/servicos-mei/`,
            btnText: null,
            headers: ['Nome', 'Email', 'Telefone', 'Tipo Serviço', 'Valor', 'Pagamento', 'Detalhes', 'Status', 'Data', 'Ações']
        },

        testimonials: {
            title: 'Depoimentos',
            subtitle: 'Gerencie os depoimentos dos clientes',
            endpoint: `${API_BASE}/testimonials/`,
            btnText: 'Adicionar Depoimento',
            headers: ['Nome', 'Cargo', 'Conteúdo', 'Status', 'Ordem', 'Ações']
        },
        posts: {
            title: 'Posts do Blog',
            subtitle: 'Gerencie os artigos do blog',
            endpoint: `${API_BASE}/posts/`,
            btnText: 'Adicionar Post',
            headers: ['Título', 'Categoria', 'Autor', 'Status', 'Destaque', 'Data', 'Ações']
        },
        planos: {
            title: 'Planos',
            subtitle: 'Gerencie os planos de serviço',
            endpoint: `${API_BASE}/planos/`,
            btnText: 'Adicionar Plano',
            headers: ['Nome', 'Categoria', 'Preço', 'Preço Antigo', 'Status', 'Destaque', 'Ações']
        },
        documents: {
            title: 'Documentos',
            subtitle: 'Gerencie os documentos dos clientes',
            endpoint: `${API_BASE}/documents/`,
            btnText: 'Enviar Documento',
            headers: ['Título', 'Cliente', 'Categoria', 'Visível', 'Data', 'Ações']
        }
    };

    let currentRegimeFilter = 'all';

    // Função auxiliar para atualizar badge do menu
    function updateMenuBadge(model, count) {
        const menuItem = document.querySelector(`a[data-model="${model}"]`);
        if (!menuItem) return;
        
        let badge = menuItem.querySelector('.notification-badge');
        if (count > 0) {
            if (!badge) {
                badge = document.createElement('span');
                badge.className = 'notification-badge';
                badge.style.cssText = 'background: #EF4444; color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 10px; margin-left: auto;';
                menuItem.appendChild(badge);
            }
            badge.innerText = count;
            badge.style.display = 'inline-block';
        } else {
            if (badge) badge.style.display = 'none';
        }
    }
    
    // Função para atualizar status do Lead
    function formatStatus(status) {
        if (!status) return '-';
        // Map common status codes to labels
        const labels = {
            'pendente': 'Pendente',
            'em_progresso': 'Em Progresso',
            'concluido': 'Concluído',
            'cancelado': 'Cancelado',
            'atrasado': 'Atrasado'
        };
        return labels[status] || status.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    }

    async function updateLeadStatus(id, newStatus) {
        try {
            const response = await fetch(`/support/api/leads/${id}/update/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ status: newStatus })
            });
            const result = await response.json();
            if (result.success) {
                // Atualizar dados locais
                const lead = currentData.find(l => l.id === id);
                if (lead) lead.status = newStatus;
                
                // Recarregar estatísticas para atualizar o badge
                loadDashboardStats();

                // Feedback visual
                const selectElement = document.getElementById(`status-select-${id}`);
                if(selectElement) {
                    selectElement.style.border = '1px solid green';
                    setTimeout(() => { selectElement.style.border = '1px solid #dfe1e6'; }, 1000);
                }
            } else {
                alert('Erro ao atualizar status: ' + (result.error || 'Erro desconhecido'));
            }
        } catch (error) {
            console.error('Erro na requisição:', error);
            alert('Erro ao conectar com o servidor.');
        }
    }

    async function loadDashboardStats() {
        try {
            const res = await fetch('/support/api/dashboard/stats/');
            const result = await res.json();
            if (result.success) {
                const d = result.data;
                const setTxt = (id, val) => { const el = document.getElementById(id); if(el) el.innerText = val; };
                setTxt('stat-total', d.clientes_ativos || 0);
                setTxt('stat-mei', d.regimes.MEI || 0);
                setTxt('stat-simples', d.regimes['Simples Nacional'] || d.regimes.SN || 0);
                setTxt('stat-presumido', d.regimes['Lucro Presumido'] || d.regimes.LP || 0);
                setTxt('stat-real', d.regimes['Lucro Real'] || d.regimes.LR || 0);
                
                // Atualizar badge de leads pendentes
                updateMenuBadge('leads', d.leads_pendentes || 0);
                
                const plansContainer = document.getElementById('stat-planos');
                if(plansContainer) {
                    let plansHtml = '';
                    if (Array.isArray(d.planos)) {
                         plansHtml = d.planos.map(p => 
                            `<div style="display:flex; justify-content:space-between; margin-bottom:2px;"><span>${p.nome}</span> <strong>${p.total}</strong></div>`
                        ).join('');
                    } else {
                        plansHtml = Object.entries(d.planos || {}).map(([k,v]) => 
                            `<div style="display:flex; justify-content:space-between; margin-bottom:2px;"><span>${k}</span> <strong>${v}</strong></div>`
                        ).join('');
                    }
                    plansContainer.innerHTML = plansHtml || 'Sem planos ativos';
                }
            }
            
            // Carregar contagem de serviços avulsos pendentes
            loadServicosAvulsosCount();
            // Carregar contagem de serviços MEI pendentes
            loadServicosMeiCount();
        } catch(e) { console.error(e); }
    }

    // Carregar contagem de serviços avulsos pendentes
    async function loadServicosAvulsosCount() {
        try {
            const res = await fetch('/support/api/servicos-avulsos/contagem/');
            const result = await res.json();
            if (result.success) {
                const badge = document.getElementById('badge-servicos-avulsos');
                if (badge) {
                    if (result.pendentes > 0) {
                        badge.textContent = result.pendentes;
                        badge.style.display = 'inline';
                    } else {
                        badge.style.display = 'none';
                    }
                }
            }
        } catch(e) { console.error(e); }
    }

    // Atualizar status de serviço avulso (na tabela global)
    async function updateServicoAvulsoStatusGlobal(id, newStatus) {
        try {
            const res = await fetch(`${API_BASE}/servicos-avulsos/${id}/update/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify({ status: newStatus })
            });
            const data = await res.json();
            if (data.success) {
                showNotification('Status atualizado!', 'success');
                // Recarregar dados
                loadModelData('servicos-avulsos');
                loadServicosAvulsosCount();
            } else {
                showNotification(data.error || 'Erro ao atualizar', 'error');
            }
        } catch(e) {
            showNotification('Erro de conexão', 'error');
        }
    }

    // ========== Serviços MEI ==========
    async function loadServicosMeiCount() {
        try {
            const res = await fetch('/support/api/servicos-mei/contagem/');
            const result = await res.json();
            if (result.success) {
                const badge = document.getElementById('badge-servicos-mei');
                if (badge) {
                    if (result.pendentes > 0) {
                        badge.textContent = result.pendentes;
                        badge.style.display = 'inline';
                    } else {
                        badge.style.display = 'none';
                    }
                }
                // Também atualiza via updateMenuBadge
                updateMenuBadge('servicos-mei', result.pendentes || 0);
            }
        } catch(e) { console.error('Erro ao carregar contagem MEI:', e); }
    }

    async function updateServicoMeiStatus(compositeId, newStatus, modelType, realId) {
        try {
            // Extrair o real_id numérico do composite id (ex: 'baixa-5' -> 5, 'lead-3' -> 3)
            let updateId = realId || compositeId;
            if (typeof compositeId === 'string' && compositeId.includes('-')) {
                updateId = compositeId.split('-').pop();
            }

            const res = await fetch(`${API_BASE}/servicos-mei/${updateId}/update/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify({ status: newStatus, model: modelType || 'Lead', real_id: realId || updateId })
            });
            const data = await res.json();
            if (data.success) {
                showNotification('Status do serviço MEI atualizado!', 'success');
                loadModelData('servicos-mei');
                loadServicosMeiCount();
            } else {
                showNotification(data.error || 'Erro ao atualizar', 'error');
            }
        } catch(e) {
            showNotification('Erro de conexão', 'error');
        }
    }

    function viewServicoMeiDetails(id) {
        const item = currentData.find(d => d.id === id);
        if (!item) return;
        
        const detalhes = item.servico_interesse || 'Sem detalhes adicionais';
        const obs = item.observacoes || 'Nenhuma observação';
        
        // Modal simples com detalhes
        const modal = document.createElement('div');
        modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;';
        modal.innerHTML = `
            <div style="background:white;border-radius:12px;padding:32px;max-width:550px;width:90%;max-height:80vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                    <h3 style="margin:0;font-size:1.25rem;color:#1a237e;">Detalhes do Serviço MEI</h3>
                    <button onclick="this.closest('div[style*=fixed]').remove()" style="background:none;border:none;font-size:1.5rem;cursor:pointer;color:#6b7280;">&times;</button>
                </div>
                <div style="display:grid;gap:12px;">
                    <div><strong>Nome:</strong> ${item.nome_completo}</div>
                    <div><strong>Email:</strong> ${item.email}</div>
                    <div><strong>Telefone:</strong> ${item.telefone}</div>
                    <div><strong>Tipo:</strong> <span style="padding:3px 10px;border-radius:8px;font-size:0.85rem;font-weight:600;background:${item.tipo_servico === 'Baixa do MEI' ? '#fce7f3' : '#d1fae5'};color:${item.tipo_servico === 'Baixa do MEI' ? '#9d174d' : '#065f46'};">${item.tipo_servico}</span></div>
                    <div><strong>Detalhes do Formulário:</strong><br><div style="background:#f9fafb;padding:12px;border-radius:8px;margin-top:6px;font-size:0.9rem;white-space:pre-wrap;">${detalhes}</div></div>
                    <div><strong>Observações:</strong><br><div style="background:#f9fafb;padding:12px;border-radius:8px;margin-top:6px;font-size:0.9rem;white-space:pre-wrap;">${obs}</div></div>
                    <div><strong>Data:</strong> ${new Date(item.criado_em).toLocaleString('pt-BR')}</div>
                    <div><strong>Status:</strong> ${item.status === 'pendente' ? 'Pendente' : item.status === 'em_atendimento' ? 'Em Atendimento' : 'Finalizado'}</div>
                </div>
                <div style="margin-top:20px;text-align:right;">
                    <button onclick="this.closest('div[style*=fixed]').remove()" style="padding:8px 20px;background:#0c63d1;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600;">Fechar</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
    }

    function filterByRegime(regime, card) {
        currentRegimeFilter = regime;
        document.querySelectorAll('.stat-card').forEach(el => {
             el.style.borderColor = 'transparent';
             el.style.backgroundColor = 'white';
        });
        if(card) {
             card.style.borderColor = 'var(--primary-color)';
             card.style.backgroundColor = '#eff6ff';
        }
        renderTable();
    }

    function viewClient(id) {
        alert('Visualização de detalhes do cliente ' + id + ' em desenvolvimento.');
    }

    // Carregar dados do modelo
    async function loadModelData(model) {
        currentModel = model;
        
        // Hide/Show correct containers
        const dataCard = document.getElementById('dataCard');
        const calContainer = document.getElementById('calendarContainer');
        
        if (model === 'agenda') {
             if(dataCard) dataCard.style.display = 'none';
             if(calContainer) calContainer.style.display = 'block';
             // Render calendar later after fetching
        } else {
             if(dataCard) dataCard.style.display = 'block';
             if(calContainer) calContainer.style.display = 'none';
        }

        // Toggle Stats
        const statsContainer = document.getElementById('dashboardStats');
        if (statsContainer) {
            if (model === 'clientes') {
                statsContainer.style.display = 'grid';
                loadDashboardStats();
            } else {
                statsContainer.style.display = 'none';
            }
        }
        currentRegimeFilter = 'all';
        document.querySelectorAll('.stat-card').forEach(el => {
             el.style.borderColor = 'transparent';
             el.style.backgroundColor = 'white';
        });

        const config = modelConfig[model];
        if (!config) return;

        document.getElementById('content-title').textContent = config.title;
        document.getElementById('content-subtitle').textContent = config.subtitle;
        
        const btnAddNew = document.getElementById('btnAddNew');
        
        // Configurar botão de ação
        if (config.btnText) {
            document.getElementById('btnAddNewText').textContent = config.btnText;
            btnAddNew.style.display = 'inline-flex';
            
            if (model === 'notas-fiscais') {
                btnAddNew.onclick = openNFModal;
            } else if (model === 'certidoes') {
                btnAddNew.onclick = openCertidaoModal;
            } else if (model === 'documentos-empresa') {
                btnAddNew.onclick = openDocumentoEmpresaModal;
            } else if (model === 'staff-tasks') {
                btnAddNew.onclick = openStaffTaskModal;
            } else if (model === 'agenda') {
                 // Pass null explicitly to avoid passing execution Event as ID
                 btnAddNew.onclick = () => openAgendaModal(null);
                 
                 // Adicionar botão de Sincronizar (HACK: inserir dinamicamente se não existir)
                 if (!document.getElementById('btnSyncGoogle')) {
                     const btnSync = document.createElement('button');
                     btnSync.id = 'btnSyncGoogle';
                     btnSync.className = 'btn-secondary';
                     btnSync.style.marginLeft = '10px';
                     btnSync.innerHTML = `
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        Sync Google
                     `;
                     btnSync.onclick = syncGoogleCalendar;
                     btnAddNew.parentNode.insertBefore(btnSync, btnAddNew.nextSibling);
                 } else {
                     document.getElementById('btnSyncGoogle').style.display = 'inline-flex';
                 }
                 
            } else {
                btnAddNew.onclick = () => alert('Funcionalidade em desenvolvimento');
                if(document.getElementById('btnSyncGoogle')) document.getElementById('btnSyncGoogle').style.display = 'none';
            }
        } else {
            btnAddNew.style.display = 'none';
            if(document.getElementById('btnSyncGoogle')) document.getElementById('btnSyncGoogle').style.display = 'none';
        }

        // Para notas fiscais, mostrar interface customizada
        if (model === 'notas-fiscais') {
            renderNotasFiscaisInterface();
            return;
        }

        // Para clientes, buscar dados para os Modals mas não exibir tabela principal
        if (model === 'clientes') {
            const container = document.getElementById('dataCard');
            if(container) {
                container.innerHTML = ''; // Limpar tabela
                container.style.display = 'none'; // Esconder container
            }
            
            try {
                // Fetch data quietly for popups
                const response = await fetch(config.endpoint);
                const result = await response.json();
                
                if (result.success) {
                    currentData = result.data;
                    // Não chamamos renderTable() nem renderClientsBoard() pois a visualização é via Cards/Popups
                } else {
                    console.error('Erro na API Clientes:', result);
                }
            } catch (error) {
                console.error('Erro ao carregar dados de clientes:', error);
            }
            return;
        }
        
        // Para contabilidade, mostrar interface customizada
        if (model === 'contabilidade') {
            renderContabilidadeInterface();
            return;
        }
        
        // Para certidões, mostrar interface customizada
        if (model === 'certidoes') {
            renderCertidoesInterface();
            return;
        }
        
        // Para documentos da empresa, mostrar interface customizada
        if (model === 'documentos-empresa') {
            renderDocumentosEmpresaInterface();
            return;
        }
        
        // Para extratos bancários, mostrar interface customizada
        if (model === 'extratos-bancarios') {
            renderExtratosBancariosInterface();
            return;
        }

        // Para tarefas internas (staff-tasks)
        if (model === 'staff-tasks') {
            const container = document.getElementById('dataCard');
            if(container) container.style.display = 'block';

            container.innerHTML = `<div style="text-align:center; padding: 40px;">Carregando tarefas...</div>`;
            try {
                const response = await fetch(config.endpoint);
                const result = await response.json();
                if (result.success) {
                    currentData = result.data;
                    renderStaffTasksBoard();
                } else {
                    container.innerHTML = `<div style="color:red; padding:20px;">Erro: ${result.error}</div>`;
                }
            } catch (error) {
                console.error(error);
                container.innerHTML = `<div style="color:red; padding:20px;">Erro de conexão</div>`;
            }
            return;
        }

        // Para agenda (FullCalendar)
        if (model === 'agenda') {
            const dataCard = document.getElementById('dataCard');
            if(dataCard) {
                dataCard.style.display = 'none';
                dataCard.innerHTML = '';
            }

            const calContainer = document.getElementById('calendarContainer');
            if(calContainer) {
                calContainer.style.display = 'block';
                calContainer.style.height = 'auto'; // Ensure visibility
                calContainer.style.minHeight = '700px';
                calContainer.style.visibility = 'visible';
            }
            
            // Clear current data to avoid showing wrong data
            currentData = [];

            // Show loading if needed, or just wait for fetch
            try {
                const response = await fetch(config.endpoint);
                const result = await response.json();
                if (result.success) {
                    currentData = result.data || [];
                } else {
                    console.error('Erro ao carregar agenda:', result);
                    alert('Não foi possível carregar os dados da agenda: ' + (result.error || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('Erro ao buscar agenda:', error);
                alert('Erro de conexão ao buscar agenda.');
            } finally {
                // Always render the calendar, even if empty, so the user sees the grid
                setTimeout(renderFullCalendar, 100);
            }
            return;
        }

        // Para chamados (Tickets), usar renderChamadosBoard
        if (model === 'chamados') {
            const container = document.getElementById('dataCard');
            if(container) container.style.display = 'block';

            container.innerHTML = `<div style="text-align:center; padding: 40px;">Carregando chamados...</div>`;
            try {
                const response = await fetch(config.endpoint);
                const result = await response.json();
                if (result.success) {
                    currentData = result.data;
                    renderChamadosBoard();
                    // Update count in sidebar if element exists (optional)
                    if(document.getElementById('chamados-count')) {
                         document.getElementById('chamados-count').textContent = currentData.length;
                    }
                } else {
                    container.innerHTML = `<div style="color:red; padding:20px;">Erro na API: ${result.error}</div>`;
                }
            } catch (error) {
                console.error(error);
                container.innerHTML = `<div style="color:red; padding:20px;">Erro de conexão ao buscar chamados.</div>`;
            }
            return;
        }

        // Para serviços avulsos, mostrar tabela
        if (model === 'servicos-avulsos') {
            const container = document.getElementById('dataCard');
            if(container) container.style.display = 'block';
            
            // Restaurar estrutura da tabela
            let thead = document.getElementById('tableHead');
            if (!thead) {
                container.innerHTML = `
                    <table class="data-table" id="dataTable">
                        <thead id="tableHead"></thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                `;
                container.className = 'data-card';
                container.style.display = 'block';
                thead = document.getElementById('tableHead');
            }
            
            thead.innerHTML = `<tr>${config.headers.map(h => `<th>${h}</th>`).join('')}</tr>`;
            
            container.innerHTML = `<div style="text-align:center; padding: 40px;">Carregando serviços avulsos...</div>`;
            try {
                const response = await fetch(config.endpoint);
                const result = await response.json();
                if (result.success) {
                    // Dados vêm em 'contratacoes' não 'data'
                    currentData = result.contratacoes || [];
                    
                    // Restaurar tabela
                    container.innerHTML = `
                        <table class="data-table" id="dataTable">
                            <thead id="tableHead"><tr>${config.headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                    `;
                    
                    renderTable();
                } else {
                    container.innerHTML = `<div style="color:red; padding:20px;">Erro: ${result.error}</div>`;
                }
            } catch (error) {
                console.error(error);
                container.innerHTML = `<div style="color:red; padding:20px;">Erro de conexão</div>`;
            }
            return;
        }

        // --- FIX FOR AGENDA ---
        // Se chegamos aqui e o modelo é agenda, nao fazemos nada (o bloco acima ja tratou e retornou)
        // Porem, se por algum motivo o bloco acima nao retornou, vamos garantir
        if (model === 'agenda') return;


        // Restaurar tabela se necessário (caso tenha vindo de uma view customizada como Kanban ou Notas Fiscais)
        let thead = document.getElementById('tableHead');
        if (!thead) {
             const dataCard = document.getElementById('dataCard');
             dataCard.innerHTML = `
                <table class="data-table" id="dataTable">
                    <thead id="tableHead"></thead>
                    <tbody id="tableBody"></tbody>
                </table>
             `;
             dataCard.className = 'data-card';
             dataCard.style.background = '';
             dataCard.style.boxShadow = '';
             dataCard.style.display = 'block'; // Ensure it's visible
             thead = document.getElementById('tableHead');
        }

        // Renderizar headers
        thead.innerHTML = `<tr>${config.headers.map(h => `<th>${h}</th>`).join('')}</tr>`;

        try {
            console.log(`Fetching ${config.endpoint}...`);
            const response = await fetch(config.endpoint);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const result = await response.json();
            
            if (result.success) {
                currentData = result.data;
                renderTable();
                updateCounts();
            } else {
                throw new Error(result.error || 'Erro desconhecido na API');
            }
        } catch (error) {
            console.error('Erro ao carregar dados:', error);
            const tbody = document.getElementById('tableBody');
            if (tbody) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="${config.headers.length}" style="text-align: center; color: red; padding: 20px;">
                            <strong>Erro ao carregar dados:</strong> ${error.message}
                            <br><small>Verifique o console para mais detalhes.</small>
                        </td>
                    </tr>
                `;
            }
            currentData = [];
        }
    }

    // Renderizar interface de Notas Fiscais
    function renderNotasFiscaisInterface() {
        const dataCard = document.getElementById('dataCard');
        if(dataCard) dataCard.style.display = 'block';
        
        // Buscar histórico de notas fiscais
        fetch('/support/api/notas-fiscais/')
            .then(response => response.json())
            .then(result => {
                const notas = result.data || [];
                
                dataCard.innerHTML = `
                    <div style="padding: 32px;">
                        <!-- Card de Instrução -->
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 16px; padding: 32px; margin-bottom: 32px; color: white;">
                            <div style="display: flex; align-items: center; gap: 24px;">
                                <svg width="80" height="80" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="flex-shrink: 0; opacity: 0.9;">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                                <div>
                                    <h3 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 8px;">Gerenciar Notas Fiscais</h3>
                                    <p style="opacity: 0.95; line-height: 1.6;">Clique em "Enviar Nova Nota Fiscal" no canto superior direito para fazer o upload de uma NF para um cliente. Os clientes poderão visualizar e baixar em suas áreas.</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Histórico de NFs -->
                        <div style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <h4 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 20px; color: var(--text-primary);">
                                📄 Histórico de Notas Fiscais Enviadas
                            </h4>
                            
                            ${notas.length === 0 ? `
                                <div style="text-align: center; padding: 48px 24px;">
                                    <svg width="80" height="80" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin: 0 auto 16px; opacity: 0.2;">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                    </svg>
                                    <p style="color: var(--text-secondary); font-size: 1.125rem;">Nenhuma nota fiscal enviada ainda</p>
                                </div>
                            ` : `
                                <div style="overflow-x: auto;">
                                    <table style="width: 100%; border-collapse: collapse;">
                                        <thead>
                                            <tr style="border-bottom: 2px solid var(--border-color);">
                                                <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-secondary);">Data/Hora</th>
                                                <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-secondary);">Cliente</th>
                                                <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-secondary);">Arquivo</th>
                                                <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-secondary);">Enviado Por</th>
                                                <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-secondary);">Observações</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${notas.map(nota => `
                                                <tr style="border-bottom: 1px solid var(--border-color);">
                                                    <td style="padding: 12px; color: var(--text-primary);">
                                                        <strong>${nota.data_upload}</strong>
                                                    </td>
                                                    <td style="padding: 12px;">
                                                        <div><strong style="color: var(--text-primary);">${nota.cliente}</strong></div>
                                                        <div style="font-size: 0.875rem; color: var(--text-secondary);">${nota.cliente_email}</div>
                                                    </td>
                                                    <td style="padding: 12px;">
                                                        <span style="background: #F3F4F6; padding: 4px 12px; border-radius: 6px; font-size: 0.875rem; font-family: monospace; color: var(--text-primary);">
                                                            ${nota.arquivo}
                                                        </span>
                                                    </td>
                                                    <td style="padding: 12px; color: var(--text-primary);">
                                                        ${nota.enviado_por}
                                                    </td>
                                                    <td style="padding: 12px; color: var(--text-secondary); font-size: 0.875rem;">
                                                        ${nota.observacoes || '<em>Sem observações</em>'}
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            `}
                        </div>
                    </div>
                `;
            })
            .catch(error => {
                console.error('Erro ao carregar histórico de notas fiscais:', error);
                dataCard.innerHTML = `
                    <div style="padding: 48px; text-align: center;">
                        <p style="color: var(--danger-color);">Erro ao carregar histórico de notas fiscais</p>
                    </div>
                `;
            });
    }

    // Renderizar interface de Contabilidade
    function renderContabilidadeInterface() {
        const dataCard = document.getElementById('dataCard');
        if(dataCard) dataCard.style.display = 'block';
        
        // Buscar clientes com movimentações
        fetch('/support/api/contabilidade/clientes/')
            .then(response => response.json())
            .then(result => {
                const clientes = result.data || [];
                
                dataCard.innerHTML = `
                    <div style="padding: 32px;">
                        <!-- Card de Seleção de Cliente -->
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 16px; padding: 32px; margin-bottom: 32px; color: white;">
                            <div style="display: flex; align-items: center; gap: 24px;">
                                <svg width="80" height="80" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="flex-shrink: 0; opacity: 0.9;">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                                </svg>
                                <div style="flex: 1;">
                                    <h3 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 8px;">Contabilidade - Movimentações Financeiras</h3>
                                    <p style="opacity: 0.95; line-height: 1.6; margin-bottom: 24px;">Selecione um cliente e opcionalmente filtre por mês específico.</p>
                                    
                                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 12px;">
                                        <select id="clienteContabilidade" style="width: 100%; padding: 12px 16px; border-radius: 8px; border: none; font-size: 1rem; color: #1F2937;">
                                            <option value="">Selecione um cliente...</option>
                                            ${clientes.map(c => `<option value="${c.id}">${c.nome} - ${c.cpf_cnpj} (${c.total_movimentacoes} movimentações)</option>`).join('')}
                                        </select>
                                        
                                        <select id="filtroMes" style="width: 100%; padding: 12px 16px; border-radius: 8px; border: none; font-size: 1rem; color: #1F2937;" disabled>
                                            <option value="">Todos os meses</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Área de Movimentações -->
                        <div id="movimentacoesArea"></div>
                    </div>
                `;
                
                // Adicionar evento de mudança no select de cliente
                document.getElementById('clienteContabilidade').addEventListener('change', function() {
                    const clienteId = this.value;
                    const filtroMes = document.getElementById('filtroMes');
                    
                    if (clienteId) {
                        filtroMes.disabled = false;
                        carregarMovimentacoes(clienteId);
                    } else {
                        filtroMes.disabled = true;
                        filtroMes.innerHTML = '<option value="">Todos os meses</option>';
                        document.getElementById('movimentacoesArea').innerHTML = '';
                    }
                });
                
                // Adicionar evento de mudança no filtro de mês
                document.getElementById('filtroMes').addEventListener('change', function() {
                    const clienteId = document.getElementById('clienteContabilidade').value;
                    if (clienteId) {
                        carregarMovimentacoes(clienteId);
                    }
                });
            })
            .catch(error => {
                console.error('Erro ao carregar clientes:', error);
                dataCard.innerHTML = `
                    <div style="padding: 48px; text-align: center;">
                        <p style="color: var(--danger-color);">Erro ao carregar lista de clientes</p>
                    </div>
                `;
            });
    }

    // Carregar movimentações de um cliente
    function carregarMovimentacoes(clienteId) {
        const movimentacoesArea = document.getElementById('movimentacoesArea');
        movimentacoesArea.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="spinner"></div><p style="margin-top: 16px; color: var(--text-secondary);">Carregando movimentações...</p></div>';
        
        fetch(`/support/api/contabilidade/clientes/${clienteId}/movimentacoes/`)
            .then(response => response.json())
            .then(result => {
                if (!result.success) {
                    movimentacoesArea.innerHTML = '<p style="color: var(--danger-color); text-align: center;">Erro ao carregar movimentações</p>';
                    return;
                }
                
                const cliente = result.cliente;
                const todosMeses = result.data;
                
                // Atualizar o filtro de meses na primeira carga
                const filtroMes = document.getElementById('filtroMes');
                const mesAtualSelecionado = filtroMes.value;
                
                if (filtroMes.options.length === 1) { // Primeira carga
                    filtroMes.innerHTML = '<option value="">Todos os meses</option>' +
                        todosMeses.map(m => `<option value="${m.mes_ano}">${m.mes_ano_formatado}</option>`).join('');
                }
                
                // Filtrar meses se houver filtro selecionado
                const mesFiltrado = filtroMes.value;
                const meses = mesFiltrado ? todosMeses.filter(m => m.mes_ano === mesFiltrado) : todosMeses;
                
                if (meses.length === 0) {
                    const mensagem = mesFiltrado ? 'Nenhuma movimentação encontrada para este mês' : 'Nenhuma movimentação encontrada para este cliente';
                    movimentacoesArea.innerHTML = `
                        <div style="text-align: center; padding: 48px; background: white; border-radius: 12px;">
                            <svg width="80" height="80" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin: 0 auto 16px; opacity: 0.2;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                            </svg>
                            <p style="color: var(--text-secondary); font-size: 1.125rem;">${mensagem}</p>
                        </div>
                    `;
                    return;
                }
                
                // Calcular totais gerais (considerando o filtro)
                const totaisGerais = meses.reduce((acc, mes) => {
                    acc.receitas += mes.total_receitas;
                    acc.despesas += mes.total_despesas;
                    acc.saldo += mes.saldo;
                    return acc;
                }, { receitas: 0, despesas: 0, saldo: 0 });
                
                const formatarValor = (valor) => `R$ ${valor.toFixed(2)}`.replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                
                // Renderizar movimentações agrupadas por mês
                movimentacoesArea.innerHTML = `
                    <!-- Informações do Cliente -->
                    <div style="background: white; border-radius: 12px; padding: 24px; margin-bottom: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
                            <div>
                                <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 12px; color: var(--text-primary);">
                                    👤 ${cliente.nome}
                                </h3>
                                <div style="display: flex; gap: 32px; color: var(--text-secondary);">
                                    <div><strong>Email:</strong> ${cliente.email}</div>
                                    <div><strong>CPF/CNPJ:</strong> ${cliente.cpf_cnpj}</div>
                                </div>
                            </div>
                            ${mesFiltrado ? '' : `
                                <div style="background: #F9FAFB; border-radius: 12px; padding: 16px; min-width: 280px;">
                                    <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 8px; text-align: center;">💰 Resumo Geral</div>
                                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; text-align: center;">
                                        <div>
                                            <div style="font-size: 0.75rem; color: var(--text-secondary);">Receitas</div>
                                            <div style="font-weight: 700; color: #10B981; font-size: 0.875rem;">${formatarValor(totaisGerais.receitas)}</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 0.75rem; color: var(--text-secondary);">Despesas</div>
                                            <div style="font-weight: 700; color: #EF4444; font-size: 0.875rem;">${formatarValor(totaisGerais.despesas)}</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 0.75rem; color: var(--text-secondary);">Saldo</div>
                                            <div style="font-weight: 700; color: ${totaisGerais.saldo >= 0 ? '#10B981' : '#EF4444'}; font-size: 0.875rem;">${formatarValor(totaisGerais.saldo)}</div>
                                        </div>
                                    </div>
                                </div>
                            `}
                        </div>
                    </div>
                    
                    <!-- Movimentações por Mês -->
                    ${meses.map((mes, index) => `
                        <div style="background: white; border-radius: 12px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden;">
                            <!-- Header do Mês -->
                            <div style="background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%); padding: 20px 24px; cursor: pointer;" onclick="toggleMes('mes-${index}')">
                                <div style="display: flex; justify-content: space-between; align-items: center; color: white;">
                                    <div>
                                        <h4 style="font-size: 1.125rem; font-weight: 700; margin-bottom: 8px;">📅 ${mes.mes_ano_formatado}</h4>
                                        <div style="opacity: 0.95; font-size: 0.875rem;">
                                            ${mes.movimentacoes.length} movimentações
                                        </div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 4px;">Saldo do Mês</div>
                                        <div style="font-size: 1.5rem; font-weight: 700;" class="${mes.saldo >= 0 ? 'text-success' : 'text-danger'}">
                                            ${mes.saldo_formatado}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Conteúdo do Mês -->
                            <div id="mes-${index}" style="display: block;">
                                <!-- Resumo -->
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; padding: 20px 24px; background: #F9FAFB; border-bottom: 1px solid var(--border-color);">
                                    <div>
                                        <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 4px;">Total Receitas</div>
                                        <div style="font-size: 1.25rem; font-weight: 700; color: #10B981;">${mes.total_receitas_formatado}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 4px;">Total Despesas</div>
                                        <div style="font-size: 1.25rem; font-weight: 700; color: #EF4444;">${mes.total_despesas_formatado}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 4px;">Saldo</div>
                                        <div style="font-size: 1.25rem; font-weight: 700; color: ${mes.saldo >= 0 ? '#10B981' : '#EF4444'};">${mes.saldo_formatado}</div>
                                    </div>
                                </div>
                                
                                <!-- Tabela de Movimentações -->
                                <div style="padding: 24px;">
                                    <table style="width: 100%; border-collapse: collapse;">
                                        <thead>
                                            <tr style="border-bottom: 2px solid var(--border-color);">
                                                <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-secondary);">Tipo</th>
                                                <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-secondary);">Descrição</th>
                                                <th style="padding: 12px; text-align: right; font-weight: 600; color: var(--text-secondary);">Valor</th>
                                                <th style="padding: 12px; text-align: center; font-weight: 600; color: var(--text-secondary);">Status</th>
                                                <th style="padding: 12px; text-align: center; font-weight: 600; color: var(--text-secondary);">Anexo</th>
                                                <th style="padding: 12px; text-align: center; font-weight: 600; color: var(--text-secondary);">Data Envio</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${mes.movimentacoes.map(mov => `
                                                <tr style="border-bottom: 1px solid var(--border-color);">
                                                    <td style="padding: 12px;">
                                                        <span class="badge ${mov.tipo_raw === 'receita' ? 'badge-success' : 'badge-danger'}">
                                                            ${mov.tipo_raw === 'receita' ? '⬆️' : '⬇️'} ${mov.tipo}
                                                        </span>
                                                    </td>
                                                    <td style="padding: 12px; font-weight: 600; color: var(--text-primary);">${mov.nome}</td>
                                                    <td style="padding: 12px; text-align: right; font-weight: 700; color: ${mov.tipo_raw === 'receita' ? '#10B981' : '#EF4444'};">
                                                        ${mov.valor_formatado}
                                                    </td>
                                                    <td style="padding: 12px; text-align: center;">
                                                        <span class="badge badge-info">${mov.status}</span>
                                                    </td>
                                                    <td style="padding: 12px; text-align: center;">
                                                        ${mov.anexo_url ? `<a href="${mov.anexo_url}" target="_blank" style="color: var(--primary-color);">📎 Ver</a>` : '<span style="color: var(--text-secondary);">-</span>'}
                                                    </td>
                                                    <td style="padding: 12px; text-align: center; color: var(--text-secondary); font-size: 0.875rem;">
                                                        ${mov.data_criacao}
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                `;
            })
            .catch(error => {
                console.error('Erro ao carregar movimentações:', error);
                movimentacoesArea.innerHTML = '<p style="color: var(--danger-color); text-align: center;">Erro ao carregar movimentações</p>';
            });
    }

    // Toggle accordion de mês
    function toggleMes(mesId) {
        const elemento = document.getElementById(mesId);
        if (elemento.style.display === 'none') {
            elemento.style.display = 'block';
        } else {
            elemento.style.display = 'none';
        }
    }

    // Renderizar interface de Extratos Bancários
    function renderExtratosBancariosInterface() {
        const dataCard = document.getElementById('dataCard');
        if(dataCard) dataCard.style.display = 'block';
        
        // Buscar clientes com extratos
        fetch('/support/api/extratos-bancarios/clientes/')
            .then(response => response.json())
            .then(result => {
                const clientes = result.data || [];
                
                dataCard.innerHTML = `
                    <div style="padding: 32px;">
                        <!-- Card de Seleção de Cliente -->
                        <div style="background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%); border-radius: 16px; padding: 32px; margin-bottom: 32px; color: white;">
                            <div style="display: flex; align-items: center; gap: 24px;">
                                <svg width="80" height="80" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="flex-shrink: 0; opacity: 0.9;">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
                                </svg>
                                <div style="flex: 1;">
                                    <h3 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 8px;">Extratos Bancários dos Clientes</h3>
                                    <p style="opacity: 0.95; line-height: 1.6; margin-bottom: 24px;">Selecione um cliente abaixo para visualizar todos os extratos bancários que ele enviou.</p>
                                    
                                    <select id="clienteExtrato" style="width: 100%; padding: 12px 16px; border-radius: 8px; border: none; font-size: 1rem; color: #1F2937;">
                                        <option value="">Selecione um cliente...</option>
                                        ${clientes.map(c => `<option value="${c.id}">${c.nome} - ${c.email} (${c.total_extratos} extrato${c.total_extratos !== 1 ? 's' : ''})</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Área de Extratos -->
                        <div id="extratosArea"></div>
                    </div>
                `;
                
                // Adicionar evento de mudança no select
                document.getElementById('clienteExtrato').addEventListener('change', function() {
                    const clienteId = this.value;
                    if (clienteId) {
                        carregarExtratos(clienteId);
                    } else {
                        document.getElementById('extratosArea').innerHTML = '';
                    }
                });
            })
            .catch(error => {
                console.error('Erro ao carregar clientes:', error);
                dataCard.innerHTML = `
                    <div style="padding: 48px; text-align: center;">
                        <p style="color: var(--danger-color);">Erro ao carregar lista de clientes</p>
                    </div>
                `;
            });
    }

    // Carregar extratos de um cliente
    function carregarExtratos(clienteId) {
        const extratosArea = document.getElementById('extratosArea');
        extratosArea.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="spinner"></div><p style="margin-top: 16px; color: var(--text-secondary);">Carregando extratos...</p></div>';
        
        fetch(`/support/api/extratos-bancarios/clientes/${clienteId}/`)
            .then(response => response.json())
            .then(result => {
                if (!result.success) {
                    extratosArea.innerHTML = '<p style="color: var(--danger-color); text-align: center;">Erro ao carregar extratos</p>';
                    return;
                }
                
                const cliente = result.cliente;
                const extratos = result.data;
                
                if (extratos.length === 0) {
                    extratosArea.innerHTML = `
                        <div style="text-align: center; padding: 48px; background: white; border-radius: 12px;">
                            <svg width="80" height="80" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin: 0 auto 16px; opacity: 0.2;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
                            </svg>
                            <p style="color: var(--text-secondary); font-size: 1.125rem;">Nenhum extrato bancário enviado por este cliente</p>
                        </div>
                    `;
                    return;
                }
                
                // Renderizar extratos
                extratosArea.innerHTML = `
                    <!-- Informações do Cliente -->
                    <div style="background: white; border-radius: 12px; padding: 24px; margin-bottom: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 12px; color: var(--text-primary);">
                            👤 ${cliente.nome}
                        </h3>
                        <div style="display: flex; gap: 32px; color: var(--text-secondary);">
                            <div><strong>Email:</strong> ${cliente.email}</div>
                            <div><strong>Total de Extratos:</strong> ${extratos.length}</div>
                        </div>
                    </div>
                    
                    <!-- Lista de Extratos -->
                    <div style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <h4 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 20px; color: var(--text-primary);">
                            💳 Extratos Bancários Enviados
                        </h4>
                        
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="border-bottom: 2px solid var(--border-color);">
                                        <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-secondary);">Data Upload</th>
                                        <th style="padding: 12px; text-align: center; font-weight: 600; color: var(--text-secondary);">Mês/Ano</th>
                                        <th style="padding: 12px; text-align: center; font-weight: 600; color: var(--text-secondary);">Período</th>
                                        <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-secondary);">Arquivo</th>
                                        <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-secondary);">Observações</th>
                                        <th style="padding: 12px; text-align: center; font-weight: 600; color: var(--text-secondary);">Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${extratos.map(extrato => `
                                        <tr style="border-bottom: 1px solid var(--border-color);">
                                            <td style="padding: 12px; color: var(--text-primary);">
                                                <strong>${extrato.data_upload}</strong>
                                            </td>
                                            <td style="padding: 12px; text-align: center;">
                                                <span class="badge badge-info" style="font-size: 0.875rem;">${extrato.mes_ano}</span>
                                            </td>
                                            <td style="padding: 12px; text-align: center; font-size: 0.875rem; color: var(--text-secondary);">
                                                ${extrato.start_date && extrato.end_date 
                                                    ? `${extrato.start_date} a ${extrato.end_date}` 
                                                    : '-'
                                                }
                                            </td>
                                            <td style="padding: 12px;">
                                                <div style="display: flex; align-items: center; gap: 8px;">
                                                    <span class="badge badge-secondary" style="font-size: 0.75rem;">${extrato.extensao}</span>
                                                    <span style="font-size: 0.875rem; color: var(--text-primary);">${extrato.nome_arquivo}</span>
                                                </div>
                                                <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 4px;">${extrato.tamanho}</div>
                                            </td>
                                            <td style="padding: 12px; font-size: 0.875rem; color: var(--text-secondary); max-width: 200px;">
                                                ${extrato.observacoes || '<em style="color: var(--text-secondary);">Sem observações</em>'}
                                            </td>
                                            <td style="padding: 12px; text-align: center;">
                                                ${extrato.arquivo_url ? `
                                                    <a href="${extrato.arquivo_url}" target="_blank" 
                                                       style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; background: var(--primary-color); color: white; text-decoration: none; border-radius: 6px; font-size: 0.875rem;">
                                                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                                        </svg>
                                                        Visualizar
                                                    </a>
                                                    <a href="${extrato.arquivo_url}" download 
                                                       style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; background: var(--success-color); color: white; text-decoration: none; border-radius: 6px; font-size: 0.875rem; margin-left: 8px;">
                                                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                                                        </svg>
                                                        Baixar
                                                    </a>
                                                ` : '<span style="color: var(--text-secondary);">-</span>'}
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            })
            .catch(error => {
                console.error('Erro ao carregar extratos:', error);
                extratosArea.innerHTML = '<p style="color: var(--danger-color); text-align: center;">Erro ao carregar extratos</p>';
            });
    }

    // Renderizar interface de Documentos da Empresa
    function renderDocumentosEmpresaInterface() {
        const dataCard = document.getElementById('dataCard');
        if(dataCard) dataCard.style.display = 'block';
        
        // Buscar histórico de documentos e clientes
        Promise.all([
            fetch('/support/api/documentos-empresa/').then(r => r.json()),
            fetch('/support/api/clientes-fase/').then(r => r.json())
        ])
        .then(([docsResult, clientesResult]) => {
            const documentos = docsResult.data || [];
            const clientes = clientesResult.data || [];
            
            dataCard.innerHTML = `
                <div style="padding: 32px;">
                    <!-- Card de Instrução -->
                    <div style="background: linear-gradient(135deg, #6366F1 0%, #4F46E5 100%); border-radius: 16px; padding: 32px; margin-bottom: 32px; color: white;">
                        <div style="display: flex; align-items: center; gap: 24px;">
                            <svg width="80" height="80" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="flex-shrink: 0; opacity: 0.9;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2"/>
                            </svg>
                            <div>
                                <h3 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 8px;">Gerenciar Documentos da Empresa</h3>
                                <p style="opacity: 0.95; line-height: 1.6;">Envie documentos importantes como Contratos, Alvarás, Certidões e outros para os clientes. Eles visualizam em "Minha Empresa".</p>
                            </div>
                        </div>
                    </div>

                    <!-- Gerenciar Fase de Abertura -->
                    <div style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 32px;">
                        <h4 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 20px; color: var(--text-primary);">
                            🚀 Gerenciar Fase de Abertura
                        </h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 16px; align-items: end;">
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-secondary);">Cliente</label>
                                <select id="faseClienteSelect" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px;">
                                    <option value="">Selecione um cliente...</option>
                                    ${clientes.map(c => `<option value="${c.id}" data-fase="${c.fase_abertura}">${c.nome} (${c.email})</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-secondary);">Fase Atual</label>
                                <select id="faseSelect" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px;">
                                    <option value="fase_1">Fase 1 — Planejamento e Análise Inicial</option>
                                    <option value="fase_2">Fase 2 — Consulta de Viabilidade</option>
                                    <option value="fase_3">Fase 3 — Registro Jurídico</option>
                                    <option value="fase_4">Fase 4 — Inscrições Fiscais</option>
                                    <option value="fase_5">Fase 5 — Licenças e Autorizações</option>
                                    <option value="fase_6">Fase 6 — Enquadramento Tributário</option>
                                    <option value="fase_7">Fase 7 — Empresa Aberta</option>
                                </select>
                            </div>
                            <button onclick="updateFaseAbertura()" style="padding: 10px 24px; background-color: var(--primary-color); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                                Atualizar Fase
                            </button>
                        </div>
                    </div>
                    
                    <!-- Histórico de Documentos -->
                    <div style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <h4 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 20px; color: var(--text-primary);">
                            📄 Histórico de Documentos Enviados
                        </h4>
                        
                        ${documentos.length === 0 ? `
                            <div style="text-align: center; padding: 48px 24px;">
                                <svg width="80" height="80" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin: 0 auto 16px; opacity: 0.2;">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2"/>
                                </svg>
                                <p style="color: var(--text-secondary); font-size: 1.125rem;">Nenhum documento enviado ainda</p>
                            </div>
                        ` : `
                            <div style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="border-bottom: 2px solid var(--border-color);">
                                            <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-secondary);">Data/Hora</th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-secondary);">Cliente</th>
                                                <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-secondary);">Título</th>
                                                <th style="padding: 12px; text-align: center; font-weight: 600; color: var(--text-secondary);">Categoria</th>
                                                <th style="padding: 12px; text-align: center; font-weight: 600; color: var(--text-secondary);">Arquivo</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${documentos.map(doc => `
                                                <tr style="border-bottom: 1px solid var(--border-color);">
                                                    <td style="padding: 12px; color: var(--text-primary);">
                                                        <strong>${doc.data_upload}</strong>
                                                    </td>
                                                    <td style="padding: 12px;">
                                                        <div><strong style="color: var(--text-primary);">${doc.cliente}</strong></div>
                                                        <div style="font-size: 0.875rem; color: var(--text-secondary);">${doc.cliente_email}</div>
                                                    </td>
                                                    <td style="padding: 12px;">
                                                        <div style="font-weight: 600; color: var(--text-primary);">${doc.titulo}</div>
                                                        ${doc.descricao ? `<div style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 4px;">${doc.descricao}</div>` : ''}
                                                    </td>
                                                    <td style="padding: 12px; text-align: center;">
                                                        <span class="badge badge-info">${doc.categoria}</span>
                                                    </td>
                                                    <td style="padding: 12px; text-align: center;">
                                                        <div style="margin-bottom: 4px;">
                                                            <span style="background: #F3F4F6; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-family: monospace;">
                                                                ${doc.nome_arquivo}
                                                            </span>
                                                        </div>
                                                        <div style="font-size: 0.75rem; color: var(--text-secondary);">${doc.tamanho}</div>
                                                        ${doc.arquivo_url ? `<a href="${doc.arquivo_url}" target="_blank" style="color: var(--primary-color); text-decoration: none; font-size: 0.875rem;">📥 Baixar</a>` : ''}
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            `}
                        </div>
                    </div>
                `;
                
                // Add event listener for client select
                const faseClienteSelect = document.getElementById('faseClienteSelect');
                const faseSelect = document.getElementById('faseSelect');
                
                if (faseClienteSelect && faseSelect) {
                    faseClienteSelect.addEventListener('change', function() {
                        const selectedOption = this.options[this.selectedIndex];
                        const currentFase = selectedOption.getAttribute('data-fase');
                        if (currentFase) {
                            faseSelect.value = currentFase;
                        }
                    });
                }
            })
            .catch(error => {
                console.error('Erro ao carregar histórico de documentos:', error);
                dataCard.innerHTML = `
                    <div style="padding: 48px; text-align: center;">
                        <p style="color: var(--danger-color);">Erro ao carregar histórico de documentos</p>
                    </div>
                `;
            });
    }

    // Função para atualizar a fase de abertura
    function updateFaseAbertura() {
        const clienteId = document.getElementById('faseClienteSelect').value;
        const fase = document.getElementById('faseSelect').value;
        
        if (!clienteId) {
            alert('Por favor, selecione um cliente.');
            return;
        }
        
        fetch('/support/api/clientes-fase/update/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                cliente_id: clienteId,
                fase: fase
            })
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                alert(result.message);
                // Atualizar o atributo data-fase no select
                const option = document.querySelector(`#faseClienteSelect option[value="${clienteId}"]`);
                if (option) {
                    option.setAttribute('data-fase', fase);
                }
            } else {
                alert('Erro ao atualizar fase: ' + result.error);
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao atualizar fase.');
        });
    }

    // Renderizar interface de Certidões Negativas
    function renderCertidoesInterface() {
        const dataCard = document.getElementById('dataCard');
        if(dataCard) dataCard.style.display = 'block';
        
        // Buscar histórico de certidões
        fetch('/support/api/certidoes/')
            .then(response => response.json())
            .then(result => {
                const certidoes = result.data || [];
                
                dataCard.innerHTML = `
                    <div style="padding: 32px;">
                        <!-- Card de Instrução -->
                        <div style="background: linear-gradient(135deg, #10B981 0%, #059669 100%); border-radius: 16px; padding: 32px; margin-bottom: 32px; color: white;">
                            <div style="display: flex; align-items: center; gap: 24px;">
                                <svg width="80" height="80" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="flex-shrink: 0; opacity: 0.9;">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                                </svg>
                                <div>
                                    <h3 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 8px;">Gerenciar Certidões Negativas</h3>
                                    <p style="opacity: 0.95; line-height: 1.6;">Clique em "Enviar Nova Certidão" para selecionar um cliente e enviar uma certidão (Federal, Estadual, Trabalhista ou FGTS). Os clientes visualizam as certidões em sua área de pendências.</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Histórico de Certidões -->
                        <div style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <h4 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 20px; color: var(--text-primary);">
                                🛡️ Histórico de Certidões Enviadas
                            </h4>
                            
                            ${certidoes.length === 0 ? `
                                <div style="text-align: center; padding: 48px 24px;">
                                    <svg width="80" height="80" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin: 0 auto 16px; opacity: 0.2;">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                                    </svg>
                                    <p style="color: var(--text-secondary); font-size: 1.125rem;">Nenhuma certidão enviada ainda</p>
                                </div>
                            ` : `
                                <div style="overflow-x: auto;">
                                    <table style="width: 100%; border-collapse: collapse;">
                                        <thead>
                                            <tr style="border-bottom: 2px solid var(--border-color);">
                                                <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-secondary);">Data/Hora</th>
                                                <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-secondary);">Cliente</th>
                                                <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-secondary);">Tipo de Certidão</th>
                                                <th style="padding: 12px; text-align: center; font-weight: 600; color: var(--text-secondary);">Status</th>
                                                <th style="padding: 12px; text-align: center; font-weight: 600; color: var(--text-secondary);">Arquivo</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${certidoes.map(cert => `
                                                <tr style="border-bottom: 1px solid var(--border-color);">
                                                    <td style="padding: 12px; color: var(--text-primary);">
                                                        <strong>${cert.data_envio}</strong>
                                                    </td>
                                                    <td style="padding: 12px;">
                                                        <div><strong style="color: var(--text-primary);">${cert.cliente}</strong></div>
                                                        <div style="font-size: 0.875rem; color: var(--text-secondary);">${cert.cliente_email}</div>
                                                    </td>
                                                    <td style="padding: 12px;">
                                                        <span class="badge ${
                                                            cert.tipo_raw === 'federal' ? 'badge-primary' : 
                                                            cert.tipo_raw === 'estadual' ? 'badge-info' :
                                                            cert.tipo_raw === 'trabalhista' ? 'badge-warning' :
                                                            'badge-success'
                                                        }">
                                                            ${cert.tipo}
                                                        </span>
                                                    </td>
                                                    <td style="padding: 12px; text-align: center;">
                                                        <span class="badge ${
                                                            cert.status_raw === 'negativa' ? 'badge-success' :
                                                            cert.status_raw === 'positiva' ? 'badge-danger' :
                                                            'badge-secondary'
                                                        }">
                                                            ${cert.status}
                                                        </span>
                                                    </td>
                                                    <td style="padding: 12px; text-align: center;">
                                                        ${cert.arquivo_url ? `<a href="${cert.arquivo_url}" target="_blank" style="color: var(--primary-color); text-decoration: none;">📄 Baixar</a>` : '-'}
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            `}
                        </div>
                    </div>
                `;
            })
            .catch(error => {
                console.error('Erro ao carregar histórico de certidões:', error);
                dataCard.innerHTML = `
                    <div style="padding: 48px; text-align: center;">
                        <p style="color: var(--danger-color);">Erro ao carregar histórico de certidões</p>
                    </div>
                `;
            });
    }

    // Renderizar tabela
    // === KANBAN FUNCTIONS ===
    
    function renderChamadosBoard() {
        const container = document.getElementById('dataCard');
        container.innerHTML = '';
        container.classList.remove('data-card');
        container.style.background = 'transparent';
        container.style.boxShadow = 'none';

        // Add refresh button to header
        const headerActions = document.querySelector('.actions-bar');
        if(headerActions && !document.getElementById('btnRefreshBoard')) {
             const btn = document.createElement('button');
             btn.id = 'btnRefreshBoard';
             btn.className = 'btn-secondary';
             btn.innerHTML = '🔄 Atualizar';
             btn.onclick = () => loadModelData(currentModel);
             btn.style.marginLeft = '8px';
             headerActions.appendChild(btn);
        }

        const columns = [
            { id: 'aberto', title: 'Novos Chamados', color: '#EF4444' },
            { id: 'em_andamento', title: 'Em Análise', color: '#F59E0B' },
            { id: 'resolvido', title: 'Resolvido', color: '#10B981' },
            { id: 'fechado', title: 'Fechado', color: '#6B7280' }
        ];

        const board = document.createElement('div');
        board.className = 'kanban-container';

        columns.forEach(col => {
            // Filter items for this column
            const colItems = currentData.filter(item => {
                 // Try strict match on value
                 if (item.status_value && item.status_value === col.id) return true;
                 
                 // Try header match or loose match on display text
                 const s = (item.status || item.status_value || '').toLowerCase();
                 if (col.id === 'aberto' && (s === 'aberto' || s.includes('novo'))) return true;
                 if (col.id === 'em_andamento' && (s.includes('andamento') || s.includes('análise'))) return true;
                 if (col.id === 'resolvido' && (s.includes('resolvido') || s.includes('concluído'))) return true;
                 if (col.id === 'fechado' && (s.includes('fechado') || s.includes('encerrado'))) return true;
                 
                 return false;
            });
            
            const colDiv = document.createElement('div');
            colDiv.className = 'kanban-column';
            colDiv.dataset.status = col.id;
            
            colDiv.innerHTML = `
                <div class="kanban-column-header" style="border-top-color: ${col.color}">
                    <h3 class="kanban-column-title">${col.title}</h3>
                    <span class="kanban-column-count">${colItems.length}</span>
                </div>
                <div class="kanban-column-content" ondrop="kanbanDrop(event)" ondragover="kanbanAllowDrop(event)" data-status="${col.id}">
                    ${colItems.map(item => createCardHTML(item)).join('')}
                </div>
            `;
            board.appendChild(colDiv);
        });

        container.appendChild(board);
        
        document.querySelectorAll('.kanban-card').forEach(card => {
            card.addEventListener('dragstart', kanbanDrag);
            card.addEventListener('click', (e) => {
                viewChamado(card.dataset.id);
            });
        });
    }

    function createCardHTML(item) {
        let priorityClass = 'media';
        if (item.prioridade_value) priorityClass = item.prioridade_value;
        else if (item.prioridade) {
             const p = item.prioridade.toLowerCase();
             if (p.includes('baixa')) priorityClass = 'baixa';
             if (p.includes('alta')) priorityClass = 'alta';
             if (p.includes('urgente')) priorityClass = 'urgente';
        }

        const dateStr = item.data_criacao ? item.data_criacao.split(' ')[0] : '';

        return `
            <div class="kanban-card" id="card-${item.id}" draggable="true" data-id="${item.id}">
                <div class="kanban-card-header">
                    <span class="kanban-card-protocol">${item.protocolo || '#' + item.id}</span>
                    <span class="kanban-card-priority ${priorityClass}">${item.prioridade || 'Média'}</span>
                </div>
                <div class="kanban-card-title">${item.titulo}</div>
                <div class="kanban-card-client">
                    <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                    </svg>
                    ${item.cliente || 'Desconhecido'}
                </div>
                <div class="kanban-card-footer">
                    <span class="kanban-card-date">
                        <svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                        ${dateStr}
                    </span>
                    <span class="kanban-card-msgs" style="display: flex; align-items: center; gap: 4px;">
                        <svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/>
                        </svg>
                        ${item.mensagens_count || 0}
                    </span>
                </div>
            </div>
        `;
    }

    function kanbanAllowDrop(ev) {
        ev.preventDefault();
        ev.dataTransfer.dropEffect = "move";
    }

    function kanbanDrag(ev) {
        ev.dataTransfer.setData("text/plain", ev.target.id);
        ev.target.classList.add('dragging');
    }

    async function kanbanDrop(ev) {
        ev.preventDefault();
        const data = ev.dataTransfer.getData("text/plain");
        const card = document.getElementById(data);
        if (!card) return;
        
        card.classList.remove('dragging');
        
        let target = ev.target;
        while (target && !target.classList.contains('kanban-column-content')) {
            target = target.parentElement;
        }
        
        if (target && target !== card.parentElement) {
            target.appendChild(card);
            const newStatus = target.dataset.status;
            const cardId = card.dataset.id;
            
            updateColumnCounts();

            try {
                const response = await fetch(`${API_BASE}/chamados/${cardId}/update-status/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({ status: newStatus })
                });
                const result = await response.json();
                
                if (result.success) {
                    const item = currentData.find(i => i.id == cardId);
                    if(item) {
                        item.status_value = newStatus;
                        item.status = result.status_display; 
                    }
                } else {
                    showAlert('Erro ao atualizar status: ' + (result.error || 'Erro desconhecido'), 'error');
                    loadModelData('chamados');
                }
            } catch (e) {
                console.error(e);
                showAlert('Erro de conexão', 'error');
                loadModelData('chamados');
            }
        }
    }

    function updateColumnCounts() {
        document.querySelectorAll('.kanban-column').forEach(col => {
            const count = col.querySelectorAll('.kanban-card').length;
            col.querySelector('.kanban-column-count').textContent = count;
        });
    }

    function renderTable() {
        const calendarContainer = document.getElementById('calendarContainer');
        const dataCard = document.getElementById('dataCard');

        // Toggle Calendar Visibility
        if (currentModel === 'agenda') {
            if(calendarContainer) calendarContainer.style.display = 'block';
            if(dataCard) dataCard.style.display = 'none';
            renderFullCalendar();
            return;
        } else {
            if(calendarContainer) calendarContainer.style.display = 'none';
            // Reset dataCard if it was hidden by agenda
            if(dataCard && currentModel !== 'clientes') dataCard.style.display = 'block';
        }

        if (currentModel === 'chamados') {
            renderChamadosBoard();
            return;
        }
        const tbody = document.getElementById('tableBody');
        const config = modelConfig[currentModel];
        
        if (currentData.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="${config.headers.length}">
                        <div class="empty-state">
                            <svg class="empty-state-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/>
                            </svg>
                            <h3 class="empty-state-title">Nenhum registro encontrado</h3>
                            <p class="empty-state-text">Clique em "${config.btnText}" para criar o primeiro registro</p>
                        </div>
                    </td>
                </tr>
            `;
            return;
        }

        // Renderizar baseado no modelo atual
        if (currentModel === 'clientes') {
             // Dynamic headers for Clients
             if(modelConfig.clientes.headers.length === 0) {
                 modelConfig.clientes.headers = ['Nome', 'Email', 'CPF/CNPJ', 'Regime', 'Plano', 'Fase', 'Ações'];
                  document.getElementById('tableHead').innerHTML = `<tr>${modelConfig.clientes.headers.map(h => `<th>${h}</th>`).join('')}</tr>`;
            }

            let filtered = currentData;
            if (typeof currentRegimeFilter !== 'undefined' && currentRegimeFilter !== 'all') {
                filtered = currentData.filter(c => c.regime === currentRegimeFilter);
            }
            
            if (filtered.length === 0) {
                 tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding:20px;">Nenhum cliente encontrado com este filtro.</td></tr>`;
            } else {
                tbody.innerHTML = filtered.map(item => `
                    <tr>
                        <td>
                            <div style="font-weight: 600; color: var(--text-primary);">${item.nome}</div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">${item.responsavel_nome ? 'Contador: ' + item.responsavel_nome : ''}</div>
                        </td>
                        <td>${item.email}</td>
                        <td>${item.cpf_cnpj}</td>
                        <td>
                            <span class="badge" style="background-color: #DBEAFE; color: #1E40AF;">
                                ${item.regime || 'N/A'}
                            </span>
                        </td>
                        <td>${item.plano_nome || '-'}</td>
                        <td>
                            <span class="badge badge-secondary" style="font-size: 0.75rem;">
                                ${item.fase ? item.fase.replace('fase_', 'Fase ').replace('_', ' ') : '-'}
                            </span>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-action btn-edit" onclick="openClienteEmpresaModal(${item.id}, '${(item.nome || '').replace(/'/g, "\\'")}', '${item.email || ''}')" title="Editar Dados da Empresa">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            }
        } else if (currentModel === 'leads') {
            tbody.innerHTML = currentData.map(item => `
                <tr>
                    <td>${item.nome_completo}</td>
                    <td>${item.email}</td>
                    <td>${item.telefone}</td>
                    <td>${item.cidade}/${item.estado}</td>
                    <td>${item.servico_interesse}</td>
                    <td><span class="badge badge-info">${item.origem}</span></td>
                    <td>
                        <select id="status-select-${item.id}" onchange="updateLeadStatus(${item.id}, this.value)" style="padding: 4px 8px; border-radius: 4px; border: 1px solid #dfe1e6; background-color: #f4f5f7;">
                            <option value="pendente" ${!item.status || item.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                            <option value="em_atendimento" ${item.status === 'em_atendimento' ? 'selected' : ''}>Em Atendimento</option>
                            <option value="finalizado" ${item.status === 'finalizado' ? 'selected' : ''}>Finalizado</option>
                        </select>
                    </td>
                    <td>${new Date(item.criado_em).toLocaleDateString('pt-BR')}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-action btn-whatsapp" onclick="sendWhatsApp('${item.nome_completo}', '${item.telefone}', '${item.servico_interesse}')" title="Abrir WhatsApp Web">
                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                                </svg>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        } else if (currentModel === 'agenda') {
            tbody.innerHTML = currentData.map(item => `
                <tr>
                    <td>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            ${item.titulo}
                            ${item.google_link ? `
                                <a href="${item.google_link}" target="_blank" title="Ver no Google Calendar" style="color: #4285F4;">
                                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zm0-12H5V6h14v2zm-7 5h5v5h-5v-5z"/>
                                    </svg>
                                </a>
                            ` : ''}
                        </div>
                    </td>
                    <td>${item.data_inicio ? new Date(item.data_inicio).toLocaleString('pt-BR') : '-'}</td>
                    <td>${item.data_fim ? new Date(item.data_fim).toLocaleString('pt-BR') : '-'}</td>
                    <td>Staff ID: ${item.responsavel_id || '-'}</td>
                    <td>
                        <span class="badge" style="background-color: ${item.recorrente ? '#DBEAFE' : '#F3F4F6'}; color: ${item.recorrente ? '#1E40AF' : '#4B5563'};">
                            ${item.recorrente ? 'Mensal' : 'Única'}
                        </span>
                    </td>
                    <td>
                       <span class="badge" style="background-color: ${item.status === 'concluido' ? '#D1FAE5' : '#FEF3C7'}; color: ${item.status === 'concluido' ? '#065F46' : '#D97706'};">
                            ${formatStatus(item.status)}
                        </span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-action btn-edit" onclick="openAgendaModal(${item.id})">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                            </button>
                            <button class="btn-action btn-delete" onclick="deleteItem(${item.id})">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        } else if (currentModel === 'chamados') {
            tbody.innerHTML = currentData.map(item => `
                <tr>
                    <td><strong>${item.protocolo}</strong></td>
                    <td>
                        <div><strong>${item.cliente}</strong></div>
                        <div style="font-size: 0.875rem; color: var(--text-secondary);">${item.cliente_email}</div>
                    </td>
                    <td>${item.titulo}</td>
                    <td><span class="badge badge-info">${item.status}</span></td>
                    <td><span class="badge badge-warning">${item.prioridade}</span></td>
                    <td><span class="badge badge-success">${item.mensagens_count}</span></td>
                    <td>${item.data_criacao}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-action btn-view" onclick="viewChamado(${item.id})">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                </svg>
                                Ver Detalhes
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        } else if (currentModel === 'abertura') {
            tbody.innerHTML = currentData.map(item => `
                <tr>
                    <td><strong>#${item.id}</strong></td>
                    <td>
                        <div style="font-weight: 600;">${item.cliente || 'Não Informado'}</div>
                    </td>
                    <td>${item.email || '-'}</td>
                    <td>${item.telefone || '-'}</td>
                    <td>
                        <span class="badge badge-info">${item.etapa}</span>
                    </td>
                    <td>
                        <span class="badge" style="background-color: ${item.status_code === 'concluido' ? '#D1FAE5' : '#FEF3C7'}; color: ${item.status_code === 'concluido' ? '#065F46' : '#D97706'};">
                            ${item.status}
                        </span>
                    </td>
                    <td>${item.criado_em}</td>
                    <td>
                        <div class="action-buttons">
                           <button class="btn-action btn-view" onclick="openProcessoDetails('${item.id}')" title="Ver Detalhes">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                </svg>
                           </button>
                           <button class="btn-action btn-whatsapp" onclick="sendWhatsApp('${(item.cliente || '').replace(/'/g, "\\'")}', '${item.telefone || ''}', 'Abertura de Empresa')" title="Abrir WhatsApp">
                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                                     <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                                </svg>
                            </button>
                            <!-- Futuro: Botão de detalhes completos do processo -->
                        </div>
                    </td>
                </tr>
            `).join('');
        } else if (currentModel === 'posts') {
            tbody.innerHTML = currentData.map(item => `
                <tr>
                    <td>${item.title}</td>
                    <td>${item.category}</td>
                    <td>${item.author}</td>
                    <td><span class="badge badge-info">${item.status}</span></td>
                    <td>${item.is_featured ? '<span class="badge badge-success">Sim</span>' : 'Não'}</td>
                    <td>${new Date(item.created_at).toLocaleDateString('pt-BR')}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-action btn-edit">Editar</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        } else if (currentModel === 'testimonials') {
            tbody.innerHTML = currentData.map(item => `
                <tr>
                    <td>${item.name}</td>
                    <td>${item.position}</td>
                    <td>${item.content}</td>
                    <td>${item.is_active ? '<span class="badge badge-success">Ativo</span>' : '<span class="badge badge-danger">Inativo</span>'}</td>
                    <td>${item.order}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-action btn-edit">Editar</button>
                            <button class="btn-action btn-delete">Excluir</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        } else if (currentModel === 'planos') {
            tbody.innerHTML = currentData.map(item => `
                <tr>
                    <td>${item.nome}</td>
                    <td>${item.categoria}</td>
                    <td>R$ ${item.preco}</td>
                    <td>${item.preco_antigo ? 'R$ ' + item.preco_antigo : 'N/A'}</td>
                    <td>${item.ativo ? '<span class="badge badge-success">Ativo</span>' : '<span class="badge badge-danger">Inativo</span>'}</td>
                    <td>${item.destaque ? '<span class="badge badge-warning">Sim</span>' : 'Não'}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-action btn-edit">Editar</button>
                            <button class="btn-action btn-delete">Excluir</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        } else if (currentModel === 'documents') {
            tbody.innerHTML = currentData.map(item => `
                <tr>
                    <td>${item.titulo}</td>
                    <td>${item.usuario}</td>
                    <td><span class="badge badge-info">${item.categoria}</span></td>
                    <td>${item.visivel_para_cliente ? '<span class="badge badge-success">Sim</span>' : 'Não'}</td>
                    <td>${new Date(item.criado_em).toLocaleDateString('pt-BR')}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-action btn-view">Ver</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        } else if (currentModel === 'servicos-avulsos') {
            // Serviços Avulsos: dados vêm em formato diferente (contratacoes)
            const contratacoes = currentData.contratacoes || currentData;
            
            const statusColors = {
                'pendente': { bg: '#fef3c7', text: '#92400e' },
                'aguardando_pagamento': { bg: '#fef3c7', text: '#92400e' },
                'em_andamento': { bg: '#dbeafe', text: '#1e40af' },
                'concluido': { bg: '#d1fae5', text: '#065f46' },
                'cancelado': { bg: '#fee2e2', text: '#991b1b' }
            };
            
            tbody.innerHTML = contratacoes.map(item => {
                const sc = statusColors[item.status] || { bg: '#f3f4f6', text: '#374151' };
                return `
                <tr>
                    <td>
                        <div style="font-weight: 600;">${item.usuario_nome}</div>
                        <div style="font-size: 0.8rem; color: #6b7280;">${item.usuario_email}</div>
                    </td>
                    <td><strong>${item.servico_titulo}</strong></td>
                    <td>R$ ${item.valor_contratado.toFixed(2).replace('.', ',')}</td>
                    <td>
                        <span style="display: inline-flex; padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; font-weight: 500; background: ${sc.bg}; color: ${sc.text};">
                            ${item.status_display}
                        </span>
                    </td>
                    <td>${item.criado_em}</td>
                    <td>
                        <div class="action-buttons">
                            <select onchange="updateServicoAvulsoStatusGlobal(${item.id}, this.value)" style="font-size: 0.8rem; padding: 4px 8px; border-radius: 4px; border: 1px solid #d1d5db;">
                                <option value="pendente" ${item.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                                <option value="em_andamento" ${item.status === 'em_andamento' ? 'selected' : ''}>Em Andamento</option>
                                <option value="concluido" ${item.status === 'concluido' ? 'selected' : ''}>Concluído</option>
                                <option value="cancelado" ${item.status === 'cancelado' ? 'selected' : ''}>Cancelado</option>
                            </select>
                        </div>
                    </td>
                </tr>
            `;
            }).join('');
        } else if (currentModel === 'servicos-mei') {
            // Serviços MEI: Baixa do MEI e Declaração Anual
            const statusColors = {
                'pendente': { bg: '#fef3c7', text: '#92400e' },
                'pago': { bg: '#d1fae5', text: '#065f46' },
                'em_andamento': { bg: '#dbeafe', text: '#1e40af' },
                'concluido': { bg: '#d1fae5', text: '#065f46' },
                'cancelado': { bg: '#fee2e2', text: '#991b1b' },
                'em_atendimento': { bg: '#dbeafe', text: '#1e40af' },
                'finalizado': { bg: '#d1fae5', text: '#065f46' }
            };
            const pagColors = {
                'aprovado': { bg: '#d1fae5', text: '#065f46', label: '✅ Pago' },
                'pendente': { bg: '#fef3c7', text: '#92400e', label: '⏳ Pendente' },
                'rejeitado': { bg: '#fee2e2', text: '#991b1b', label: '❌ Rejeitado' },
                '': { bg: '#f3f4f6', text: '#6b7280', label: '—' }
            };
            const tipoColors = {
                'Baixa do MEI': { bg: '#fce7f3', text: '#9d174d' },
                'Declaração Anual (DASN)': { bg: '#d1fae5', text: '#065f46' }
            };
            
            tbody.innerHTML = currentData.map(item => {
                const sc = statusColors[item.status] || { bg: '#f3f4f6', text: '#374151' };
                const tc = tipoColors[item.tipo_servico] || { bg: '#f3f4f6', text: '#374151' };
                const pc = pagColors[item.pagamento_status] || pagColors[''];
                
                // Parse detalhes
                let detalhes = item.servico_interesse || item.observacoes || '-';
                if (detalhes.length > 60) detalhes = detalhes.substring(0, 60) + '...';
                
                // Status options dependem do model
                const isNewModel = item.model !== 'Lead';
                const statusOptions = isNewModel ? `
                    <option value="pendente" ${item.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                    <option value="pago" ${item.status === 'pago' ? 'selected' : ''}>Pago</option>
                    <option value="em_andamento" ${item.status === 'em_andamento' ? 'selected' : ''}>Em Andamento</option>
                    <option value="concluido" ${item.status === 'concluido' ? 'selected' : ''}>Concluído</option>
                    <option value="cancelado" ${item.status === 'cancelado' ? 'selected' : ''}>Cancelado</option>
                ` : `
                    <option value="pendente" ${item.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                    <option value="em_atendimento" ${item.status === 'em_atendimento' ? 'selected' : ''}>Em Atendimento</option>
                    <option value="finalizado" ${item.status === 'finalizado' ? 'selected' : ''}>Finalizado</option>
                `;
                
                return `
                <tr>
                    <td>
                        <div style="font-weight: 600;">${item.nome_completo}</div>
                    </td>
                    <td style="font-size: 0.85rem;">${item.email}</td>
                    <td>${item.telefone}</td>
                    <td>
                        <span style="display: inline-flex; padding: 4px 10px; border-radius: 12px; font-size: 0.78rem; font-weight: 600; background: ${tc.bg}; color: ${tc.text};">
                            ${item.tipo_servico}
                        </span>
                    </td>
                    <td style="font-size: 0.85rem; font-weight: 600;">
                        ${item.valor ? 'R$ ' + parseFloat(item.valor).toFixed(2).replace('.', ',') : '—'}
                    </td>
                    <td>
                        <span style="display: inline-flex; padding: 4px 10px; border-radius: 12px; font-size: 0.78rem; font-weight: 600; background: ${pc.bg}; color: ${pc.text};">
                            ${pc.label}
                        </span>
                    </td>
                    <td style="font-size: 0.82rem; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${(item.servico_interesse || '').replace(/"/g, '&quot;')}">${detalhes}</td>
                    <td>
                        <select onchange="updateServicoMeiStatus('${item.id}', this.value, '${item.model || 'Lead'}', ${item.real_id || 0})" style="font-size: 0.8rem; padding: 4px 8px; border-radius: 4px; border: 1px solid #d1d5db; background: ${sc.bg}; color: ${sc.text};">
                            ${statusOptions}
                        </select>
                    </td>
                    <td>${new Date(item.criado_em).toLocaleDateString('pt-BR')}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-action btn-whatsapp" onclick="sendWhatsApp('${item.nome_completo}', '${item.telefone}', '${item.tipo_servico}')" title="Abrir WhatsApp">
                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                                </svg>
                            </button>
                            <button class="btn-action btn-view" onclick="viewServicoMeiDetails('${item.id}')" title="Ver Detalhes">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
            }).join('');
        } else if (currentModel === 'dados-empresa') {
            // Dados da Empresa dos clientes
            const statusColors = {
                'nao_contratado': { bg: '#f3f4f6', text: '#6b7280', label: 'Não Contratado' },
                'ativo': { bg: '#d1fae5', text: '#065f46', label: 'Ativo' },
                'vencido': { bg: '#fee2e2', text: '#991b1b', label: 'Vencido' },
                'a_vencer': { bg: '#fef3c7', text: '#92400e', label: 'A Vencer' }
            };
            
            tbody.innerHTML = currentData.map(item => {
                const evStatus = statusColors[item.endereco_virtual_status] || statusColors['nao_contratado'];
                const cdStatus = statusColors[item.certificado_digital_status] || statusColors['nao_contratado'];
                
                return `
                <tr>
                    <td>
                        <div style="font-weight: 600; color: var(--text-primary);">${item.nome}</div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">${item.email}</div>
                    </td>
                    <td>${item.cnpj || '<span style="color: #9ca3af;">-</span>'}</td>
                    <td>${item.razao_social || '<span style="color: #9ca3af;">-</span>'}</td>
                    <td>
                        <span class="badge badge-secondary" style="font-size: 0.75rem;">
                            ${item.fase ? item.fase.replace('fase_', 'Fase ') : '-'}
                        </span>
                    </td>
                    <td>
                        <span style="display: inline-flex; padding: 3px 8px; border-radius: 10px; font-size: 0.7rem; font-weight: 500; background: ${evStatus.bg}; color: ${evStatus.text};">
                            ${evStatus.label}
                        </span>
                    </td>
                    <td>
                        <span style="display: inline-flex; padding: 3px 8px; border-radius: 10px; font-size: 0.7rem; font-weight: 500; background: ${cdStatus.bg}; color: ${cdStatus.text};">
                            ${cdStatus.label}
                        </span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-action btn-edit" onclick="openClienteEmpresaModal(${item.id}, '${(item.nome || '').replace(/'/g, "\\'")}', '${item.email || ''}')" title="Editar Dados">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
            }).join('');
        }
    }

    // Atualizar contadores
    function updateCounts() {
        if (currentModel === 'leads') {
            const pendingLeads = currentData.filter(l => !l.contatado).length;
            const el = document.getElementById('leads-count');
            if (el) el.textContent = pendingLeads;
        } else if (currentModel === 'chamados') {
            const el = document.getElementById('chamados-count');
            if (el) el.textContent = currentData.length;
        }
    }

    // Enviar mensagem via WhatsApp
    function sendWhatsApp(leadName, leadPhone, servicoInteresse) {
        const phone = leadPhone.replace(/\D/g, '');
        const message = `Olá ${leadName}! 👋\n\nSomos da Vetorial Contabilidade e vimos que você demonstrou interesse em nossos serviços de ${servicoInteresse}.\n\nEstamos à disposição para esclarecer qualquer dúvida e apresentar nossas soluções personalizadas para o seu negócio.\n\nPodemos agendar uma conversa?`;
        const whatsappUrl = `https://wa.me/55${phone}?text=${encodeURIComponent(message)}`;
        window.open(whatsappUrl, '_blank');
    }

    // Ver detalhes do chamado
    async function viewChamado(id) {
        currentChamadoId = id;
        try {
            const response = await fetch(`${API_BASE}/chamados/${id}/`);
            const result = await response.json();
            
            if (result.success) {
                const chamado = result.data;
                
                // Preencher título e informações
                document.getElementById('chamadoTitle').textContent = `${chamado.protocolo} - ${chamado.titulo}`;
                document.getElementById('chamadoInfo').innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; padding: 16px; background: #F9FAFB; border-radius: 12px;">
                        <div>
                            <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 4px;">Cliente</div>
                            <div style="font-weight: 600;">${chamado.cliente}</div>
                            <div style="font-size: 0.875rem; color: var(--text-secondary);">${chamado.cliente_email}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 8px;">Status do Ticket</div>
                            <select id="statusSelect" style="width: 100%; padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border-color); font-size: 0.875rem; margin-bottom: 8px;">
                                <option value="aberto" ${chamado.status_value === 'aberto' ? 'selected' : ''}>Aberto</option>
                                <option value="em_andamento" ${chamado.status_value === 'em_andamento' ? 'selected' : ''}>Em Atendimento</option>
                                <option value="resolvido" ${chamado.status_value === 'resolvido' ? 'selected' : ''}>Finalizado</option>
                            </select>
                            <span class="badge badge-warning">${chamado.prioridade}</span>
                        </div>
                        <div>
                            <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 4px;">Data de Abertura</div>
                            <div>${chamado.data_criacao}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 4px;">Última Atualização</div>
                            <div>${chamado.data_atualizacao}</div>
                        </div>
                        <div style="grid-column: 1 / -1;">
                            <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 4px;">Descrição</div>
                            <div style="line-height: 1.5;">${chamado.descricao}</div>
                        </div>
                    </div>
                `;
                
                // Renderizar mensagens
                const chatContainer = document.getElementById('chatContainer');
                chatContainer.innerHTML = chamado.mensagens.map(msg => `
                    <div class="chat-message">
                        <div class="message-avatar ${msg.autor_is_staff ? 'staff' : ''}">
                            ${msg.autor.charAt(0).toUpperCase()}
                        </div>
                        <div class="message-content">
                            <div class="message-header">
                                <span class="message-author">${msg.autor}</span>
                                ${msg.autor_is_staff ? '<span class="badge badge-success" style="font-size: 0.7rem;">Staff</span>' : ''}
                                <span class="message-time">${msg.criado_em}</span>
                            </div>
                            <div class="message-text">${msg.mensagem}</div>
                            ${msg.anexo_url ? `<a href="${msg.anexo_url}" target="_blank" style="font-size: 0.875rem; color: var(--primary-color);">📎 Anexo</a>` : ''}
                        </div>
                    </div>
                `).join('');
                
                // Scroll para o fim
                chatContainer.scrollTop = chatContainer.scrollHeight;
                
                // Abrir modal
                document.getElementById('chamadoModal').classList.add('active');
                
                // Adicionar listener para mudança de status
                document.getElementById('statusSelect').addEventListener('change', async function() {
                    const novoStatus = this.value;
                    await atualizarStatusChamado(currentChamadoId, novoStatus);
                });
            }
        } catch (error) {
            console.error('Erro ao carregar chamado:', error);
            showAlert('Erro ao carregar detalhes do chamado', 'error');
        }
    }

    // Atualizar status do chamado
    async function atualizarStatusChamado(chamadoId, novoStatus) {
        try {
            const response = await fetch(`${API_BASE}/chamados/${chamadoId}/update-status/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({ status: novoStatus })
            });
            
            const result = await response.json();
            
            if (result.success) {
                showAlert('Status atualizado com sucesso!');
                // Recarregar lista de chamados
                loadModelData('chamados');
            } else {
                showAlert(result.error || 'Erro ao atualizar status', 'error');
            }
        } catch (error) {
            console.error('Erro ao atualizar status:', error);
            showAlert('Erro ao atualizar status', 'error');
        }
    }

    // Enviar resposta
    async function sendResponse() {
        const message = document.getElementById('respondMessage').value.trim();
        
        if (!message) {
            showAlert('Digite uma mensagem antes de enviar', 'error');
            return;
        }
        
        if (!currentChamadoId) return;
        
        try {
            const response = await fetch(`${API_BASE}/chamados/${currentChamadoId}/respond/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({ mensagem: message })
            });
            
            const result = await response.json();
            
            if (result.success) {
                showAlert('Resposta enviada com sucesso!');
                document.getElementById('respondMessage').value = '';
                
                // Recarregar mensagens
                viewChamado(currentChamadoId);
            } else {
                showAlert(result.error || 'Erro ao enviar resposta', 'error');
            }
        } catch (error) {
            console.error('Erro ao enviar resposta:', error);
            showAlert('Erro ao enviar resposta', 'error');
        }
    }

    // Fechar modal de chamado
    function closeChamadoModal() {
        document.getElementById('chamadoModal').classList.remove('active');
        currentChamadoId = null;
        document.getElementById('respondMessage').value = '';
    }

    // Abrir modal de NF
    async function openNFModal(clientId = null) {
        // Carregar lista de clientes
        try {
            const response = await fetch(`${API_BASE}/clientes/`);
            const result = await response.json();
            
            if (result.success) {
                const select = document.getElementById('nfCliente');
                select.innerHTML = '<option value="">Selecione um cliente...</option>' + 
                    result.data.map(c => `<option value="${c.id}">${c.nome} (${c.email})</option>`).join('');
                
                if (clientId) {
                    select.value = clientId;
                }

                document.getElementById('nfModal').classList.add('active');
            }
        } catch (error) {
            console.error('Erro ao carregar clientes:', error);
            showAlert('Erro ao carregar lista de clientes', 'error');
        }
    }

    // Fechar modal de NF
    function closeNFModal() {
        document.getElementById('nfModal').classList.remove('active');
        document.getElementById('nfForm').reset();
    }

    // Enviar nota fiscal
    document.getElementById('nfForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData();
        formData.append('cliente_id', document.getElementById('nfCliente').value);
        formData.append('arquivo', document.getElementById('nfArquivo').files[0]);
        formData.append('observacoes', document.getElementById('nfObservacoes').value);
        
        try {
            const response = await fetch(`${API_BASE}/notas-fiscais/enviar/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken
                },
                body: formData
            });
            
            const result = await response.json();
            
            if (result.success) {
                showAlert(result.message);
                closeNFModal();
            } else {
                showAlert(result.error || 'Erro ao enviar nota fiscal', 'error');
            }
        } catch (error) {
            console.error('Erro ao enviar NF:', error);
            showAlert('Erro ao enviar nota fiscal', 'error');
        }
    });

    // Abrir modal de Documento da Empresa
    async function openDocumentoEmpresaModal(clientId = null) {
        // Carregar lista de clientes
        try {
            const response = await fetch(`${API_BASE}/clientes/`);
            const result = await response.json();
            
            if (result.success) {
                const select = document.getElementById('docEmpresaCliente');
                select.innerHTML = '<option value="">Selecione um cliente...</option>' + 
                    result.data.map(c => `<option value="${c.id}">${c.nome} (${c.email})</option>`).join('');
                
                if (clientId) {
                    select.value = clientId;
                }

                document.getElementById('documentoEmpresaModal').classList.add('active');
            }
        } catch (error) {
            console.error('Erro ao carregar clientes:', error);
            showAlert('Erro ao carregar lista de clientes', 'error');
        }
    }

    // Fechar modal de Documento da Empresa
    function closeDocumentoEmpresaModal() {
        document.getElementById('documentoEmpresaModal').classList.remove('active');
        document.getElementById('documentoEmpresaForm').reset();
    }

    // Enviar documento da empresa
    document.getElementById('documentoEmpresaForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData();
        formData.append('cliente_id', document.getElementById('docEmpresaCliente').value);
        formData.append('titulo', document.getElementById('docEmpresaTitulo').value);
        formData.append('categoria', document.getElementById('docEmpresaCategoria').value);
        formData.append('arquivo', document.getElementById('docEmpresaArquivo').files[0]);
        formData.append('descricao', document.getElementById('docEmpresaDescricao').value);
        
        try {
            const response = await fetch(`${API_BASE}/documentos-empresa/enviar/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken
                },
                body: formData
            });
            
            const result = await response.json();
            
            if (result.success) {
                showAlert(result.message);
                closeDocumentoEmpresaModal();
                // Recarregar a interface de documentos
                if (currentModel === 'documentos-empresa') {
                    renderDocumentosEmpresaInterface();
                }
            } else {
                showAlert(result.error || 'Erro ao enviar documento', 'error');
            }
        } catch (error) {
            console.error('Erro ao enviar documento:', error);
            showAlert('Erro ao enviar documento', 'error');
        }
    });

    // Abrir modal de Certidão
    async function openCertidaoModal(clientId = null) {
        // Carregar lista de clientes
        try {
            const response = await fetch(`${API_BASE}/clientes/`);
            const result = await response.json();
            
            if (result.success) {
                const select = document.getElementById('certidaoCliente');
                select.innerHTML = '<option value="">Selecione um cliente...</option>' + 
                    result.data.map(c => `<option value="${c.id}">${c.nome} (${c.email})</option>`).join('');
                
                if (clientId) {
                    select.value = clientId;
                }

                document.getElementById('certidaoModal').classList.add('active');
            }
        } catch (error) {
            console.error('Erro ao carregar clientes:', error);
            showAlert('Erro ao carregar lista de clientes', 'error');
        }
    }

    // Fechar modal de Certidão
    function closeCertidaoModal() {
        document.getElementById('certidaoModal').classList.remove('active');
        document.getElementById('certidaoForm').reset();
    }

    // Enviar certidão
    document.getElementById('certidaoForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData();
        formData.append('cliente_id', document.getElementById('certidaoCliente').value);
        formData.append('tipo_certidao', document.getElementById('certidaoTipo').value);
        formData.append('status', document.getElementById('certidaoStatus').value);
        formData.append('arquivo', document.getElementById('certidaoArquivo').files[0]);
        
        try {
            const response = await fetch(`${API_BASE}/certidoes/enviar/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken
                },
                body: formData
            });
            
            const result = await response.json();
            
            if (result.success) {
                showAlert(result.message);
                closeCertidaoModal();
                // Recarregar a interface de certidões
                if (currentModel === 'certidoes') {
                    renderCertidoesInterface();
                }
            } else {
                showAlert(result.error || 'Erro ao enviar certidão', 'error');
            }
        } catch (error) {
            console.error('Erro ao enviar certidão:', error);
            showAlert('Erro ao enviar certidão', 'error');
        }
    });

    // === GUIA MODAL FUNCTIONS ===
    function openGuiaModal(clientId = null) {
        document.getElementById('guiaModal').classList.add('active');
        const idToUse = clientId || currentSelectedClientId;
        if(idToUse) {
             document.getElementById('guiaClienteVal').value = idToUse;
        }
    }
    
    function closeGuiaModal() {
        document.getElementById('guiaModal').classList.remove('active');
        document.getElementById('guiaForm').reset();
    }
    
    document.getElementById('guiaForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        // Ensure cliente_id is set
        if(!formData.get('cliente_id') && currentSelectedClientId) {
            formData.set('cliente_id', currentSelectedClientId);
        }
        formData.append('arquivo', document.getElementById('guiaArquivo').files[0]);

        try {
            const resp = await fetch(`${API_BASE}/guias/enviar/`, {
                method: 'POST',
                headers: {'X-CSRFToken': csrftoken},
                body: formData
            });
            const d = await resp.json();
            if(d.success) {
                alert('Guia enviada com sucesso!');
                closeGuiaModal();
                // Refresh list logic if simple enough, else just close
            } else {
                alert('Erro: ' + d.error);
            }
        } catch(e) {
            console.error(e);
            alert('Erro ao enviar guia');
        }
    });

    // ==================== MODAL DADOS EMPRESA CLIENTE ====================
    
    async function openClienteEmpresaModal(clienteId, nome, email) {
        document.getElementById('clienteEmpresaModal').classList.add('active');
        document.getElementById('clienteEmpresaId').value = clienteId;
        document.getElementById('clienteEmpresaNome').textContent = nome || 'Cliente';
        document.getElementById('clienteEmpresaEmail').textContent = email || '';
        
        // Limpar formulário
        document.getElementById('clienteEmpresaForm').reset();
        
        // Buscar dados atuais do cliente
        try {
            const resp = await fetch(`${API_BASE}/cliente/${clienteId}/dados-empresa/`, {
                headers: {'X-CSRFToken': csrftoken}
            });
            const data = await resp.json();
            
            if (data.success) {
                const c = data.data;
                // Preencher campos
                document.getElementById('clienteCnpj').value = c.cnpj || '';
                document.getElementById('clienteTelefone').value = c.telefone || '';
                document.getElementById('clienteRazaoSocial').value = c.razao_social || '';
                document.getElementById('clienteNomeFantasia').value = c.nome_fantasia || '';
                document.getElementById('clienteEndereco').value = c.endereco || '';
                document.getElementById('clienteFase').value = c.fase_abertura || 'fase_1';
                document.getElementById('clienteRegime').value = c.regime_tributario || 'SN';
                
                // Endereço Virtual
                document.getElementById('clienteEndVirtualStatus').value = c.endereco_virtual_status || 'nao_contratado';
                document.getElementById('clienteEndVirtualEndereco').value = c.endereco_virtual_endereco || '';
                document.getElementById('clienteEndVirtualValidade').value = c.endereco_virtual_validade || '';
                
                // Certificado Digital
                document.getElementById('clienteCertStatus').value = c.certificado_digital_status || 'nao_contratado';
                document.getElementById('clienteCertTipo').value = c.certificado_digital_tipo || '';
                document.getElementById('clienteCertValidade').value = c.certificado_digital_validade || '';
            }
            
            // Carregar boletos
            await loadClienteBoletos(clienteId);
            
        } catch (e) {
            console.error('Erro ao carregar dados do cliente:', e);
        }
    }
    
    function closeClienteEmpresaModal() {
        document.getElementById('clienteEmpresaModal').classList.remove('active');
        document.getElementById('clienteEmpresaForm').reset();
    }
    
    document.getElementById('clienteEmpresaForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const clienteId = document.getElementById('clienteEmpresaId').value;
        
        const dados = {
            cliente_id: clienteId,
            cnpj: document.getElementById('clienteCnpj').value,
            telefone: document.getElementById('clienteTelefone').value,
            razao_social: document.getElementById('clienteRazaoSocial').value,
            nome_fantasia: document.getElementById('clienteNomeFantasia').value,
            endereco: document.getElementById('clienteEndereco').value,
            fase_abertura: document.getElementById('clienteFase').value,
            regime_tributario: document.getElementById('clienteRegime').value,
            endereco_virtual_status: document.getElementById('clienteEndVirtualStatus').value,
            endereco_virtual_endereco: document.getElementById('clienteEndVirtualEndereco').value,
            endereco_virtual_validade: document.getElementById('clienteEndVirtualValidade').value || null,
            certificado_digital_status: document.getElementById('clienteCertStatus').value,
            certificado_digital_tipo: document.getElementById('clienteCertTipo').value,
            certificado_digital_validade: document.getElementById('clienteCertValidade').value || null
        };
        
        try {
            const resp = await fetch(`${API_BASE}/cliente/${clienteId}/dados-empresa/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify(dados)
            });
            
            const data = await resp.json();
            
            if (data.success) {
                alert('Dados salvos com sucesso!');
                closeClienteEmpresaModal();
                loadData(); // Recarregar lista de clientes
            } else {
                alert('Erro: ' + (data.error || 'Erro ao salvar'));
            }
        } catch (e) {
            console.error('Erro ao salvar dados:', e);
            alert('Erro ao salvar dados do cliente');
        }
    });

    // ==================== FUNÇÕES BOLETOS CONTABILIDADE ====================
    
    async function loadClienteBoletos(clienteId) {
        const container = document.getElementById('boletosListContainer');
        container.innerHTML = '<div style="text-align: center; color: #9ca3af; padding: 16px 0;">Carregando boletos...</div>';
        
        try {
            const resp = await fetch(`${API_BASE}/cliente/${clienteId}/boletos/`, {
                headers: {'X-CSRFToken': csrftoken}
            });
            const data = await resp.json();
            
            if (data.success && data.boletos.length > 0) {
                let html = '<div style="max-height: 200px; overflow-y: auto;">';
                data.boletos.forEach(b => {
                    const statusColors = {
                        'pendente': 'background: #fef3c7; color: #d97706;',
                        'pago': 'background: #d1fae5; color: #047857;',
                        'vencido': 'background: #fee2e2; color: #dc2626;',
                        'cancelado': 'background: #f3f4f6; color: #6b7280;'
                    };
                    html += `
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px; border: 1px solid #f3f4f6; border-radius: 6px; margin-bottom: 8px;">
                            <div style="flex: 1;">
                                <div style="font-weight: 500; color: #374151; font-size: 0.9rem;">${b.referencia}</div>
                                <div style="font-size: 0.8rem; color: #6b7280;">R$ ${b.valor.toFixed(2).replace('.', ',')} | Venc: ${b.data_vencimento}</div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <select onchange="updateBoletoStatus(${b.id}, this.value)" style="padding: 4px 8px; border: 1px solid #e5e7eb; border-radius: 4px; font-size: 0.75rem; ${statusColors[b.status] || ''}">
                                    <option value="pendente" ${b.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                                    <option value="pago" ${b.status === 'pago' ? 'selected' : ''}>Pago</option>
                                    <option value="vencido" ${b.status === 'vencido' ? 'selected' : ''}>Vencido</option>
                                    <option value="cancelado" ${b.status === 'cancelado' ? 'selected' : ''}>Cancelado</option>
                                </select>
                                <a href="${b.arquivo_url}" target="_blank" style="color: #3b82f6; font-size: 0.85rem;" title="Ver boleto">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                    </svg>
                                </a>
                                <button onclick="deleteBoleto(${b.id})" style="background: none; border: none; color: #ef4444; cursor: pointer;" title="Remover boleto">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                container.innerHTML = html;
            } else {
                container.innerHTML = '<div style="text-align: center; color: #9ca3af; padding: 16px 0; font-size: 0.85rem;">Nenhum boleto enviado</div>';
            }
        } catch (e) {
            console.error('Erro ao carregar boletos:', e);
            container.innerHTML = '<div style="text-align: center; color: #ef4444; padding: 16px 0;">Erro ao carregar boletos</div>';
        }
    }
    
    function openEnviarBoletoModal() {
        const clienteId = document.getElementById('clienteEmpresaId').value;
        document.getElementById('boletoClienteId').value = clienteId;
        document.getElementById('enviarBoletoForm').reset();
        document.getElementById('enviarBoletoModal').classList.add('active');
    }
    
    function closeEnviarBoletoModal() {
        document.getElementById('enviarBoletoModal').classList.remove('active');
    }
    
    document.getElementById('enviarBoletoForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const clienteId = document.getElementById('boletoClienteId').value;
        const formData = new FormData(this);
        
        try {
            const resp = await fetch(`${API_BASE}/cliente/${clienteId}/boletos/`, {
                method: 'POST',
                headers: {'X-CSRFToken': csrftoken},
                body: formData
            });
            
            const data = await resp.json();
            
            if (data.success) {
                alert('Boleto enviado com sucesso!');
                closeEnviarBoletoModal();
                await loadClienteBoletos(clienteId);
            } else {
                alert('Erro: ' + (data.error || 'Erro ao enviar boleto'));
            }
        } catch (e) {
            console.error('Erro ao enviar boleto:', e);
            alert('Erro ao enviar boleto');
        }
    });
    
    async function updateBoletoStatus(boletoId, status) {
        try {
            const resp = await fetch(`${API_BASE}/boleto/${boletoId}/status/`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({ status })
            });
            
            const data = await resp.json();
            if (!data.success) {
                alert('Erro ao atualizar status');
            }
        } catch (e) {
            console.error('Erro ao atualizar status:', e);
        }
    }
    
    async function deleteBoleto(boletoId) {
        if (!confirm('Tem certeza que deseja remover este boleto?')) return;
        
        try {
            const resp = await fetch(`${API_BASE}/boleto/${boletoId}/status/`, {
                method: 'DELETE',
                headers: {'X-CSRFToken': csrftoken}
            });
            
            const data = await resp.json();
            if (data.success) {
                const clienteId = document.getElementById('clienteEmpresaId').value;
                await loadClienteBoletos(clienteId);
            } else {
                alert('Erro ao remover boleto');
            }
        } catch (e) {
            console.error('Erro ao remover boleto:', e);
        }
    }

    // calendar logic
    function renderFullCalendar() {
        const container = document.getElementById('calendarContainer');
        const dataCard = document.getElementById('dataCard');
        
        console.log('Rendering FullCalendar', currentData);

        if (container) {
            container.style.display = 'block';
            container.classList.remove('hidden'); 
        }
        if (dataCard) dataCard.style.display = 'none';

        const calendarEl = document.getElementById('calendar');
        if (!calendarEl) {
            console.error('Calendar element not found');
            return;
        }

        // Verify if FullCalendar is loaded
        if (typeof FullCalendar === 'undefined') {
            console.error('FullCalendar library not loaded');
            calendarEl.innerHTML = '<div style="color:red; padding:20px;">Erro: Biblioteca FullCalendar não carregada. Verifique a conexão com a internet.</div>';
            return;
        }

        // Ensure calendar element has height
        calendarEl.style.height = '100%';

        // Clear previous instance if exists to prevent duplicates
        if (calendar) {
            calendar.destroy();
        }

        try {
            // Define events from currentData
            const events = currentData.map(item => {
                let color = '#3B82F6'; // Default primary
                const statusKey = item.status_value || item.status; 
                
                if (statusKey === 'concluido') color = '#059669'; // Success
                else if (statusKey === 'cancelado') color = '#EF4444'; // Danger
                else if (item.recorrente) color = '#7C3AED'; // Purple for recurring

                // Handle date formatting 'YYYY-MM-DD HH:MM:SS' to ISO 'YYYY-MM-DDTHH:MM:SS'
                const start = item.data_inicio ? item.data_inicio.replace(' ', 'T') : null;
                const end = item.data_fim ? item.data_fim.replace(' ', 'T') : null;

                return {
                    id: item.id,
                    title: item.titulo,
                    start: start,
                    end: end,
                    backgroundColor: color,
                    borderColor: color,
                    extendedProps: {
                        raw: item
                    }
                };
            });

            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'pt-br',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                buttonText: {
                    today: 'Hoje',
                    month: 'Mês',
                    week: 'Semana',
                    day: 'Dia'
                },
                events: events,
                editable: true, 
                selectable: true,
                height: '100%',
                contentHeight: 'auto',
                select: function(info) {
                    // Open create modal with selected dates
                    document.getElementById('agendaForm').reset();
                    // Format to YYYY-MM-DDTHH:mm for input type datetime-local
                    let startStr = info.startStr;
                    let endStr = info.endStr;
                    
                    // If selecting multiple days in month view, end has no time. Add default times.
                    if(startStr.indexOf('T') === -1) startStr += 'T09:00';
                    if(endStr && endStr.indexOf('T') === -1) endStr += 'T10:00';

                    document.getElementById('agendaDataInicio').value = startStr;
                    document.getElementById('agendaDataFim').value = endStr;
                    
                    currentAgendaId = null;
                    document.getElementById('agendaModal').classList.add('active');
                },
                eventClick: function(info) {
                    // Open edit modal
                    openAgendaModal(info.event.id);
                },
                eventDrop: async function(info) {
                    // Update dates on drag
                    if (!confirm("Deseja mover este agendamento?")) {
                        info.revert();
                        return;
                    }
                    
                    const event = info.event;
                    const toLocalISO = (date) => {
                        const offset = date.getTimezoneOffset() * 60000;
                        return new Date(date - offset).toISOString().slice(0, 16).replace('T', ' ');
                    };

                    const newStart = event.start ? toLocalISO(event.start) : null;
                    const newEnd = event.end ? toLocalISO(event.end) : null;

                    // Call API to update
                    try {
                        const payload = {
                            titulo: event.extendedProps.raw.titulo, // Keep title
                            data_inicio: newStart, 
                            data_fim: newEnd,
                            descricao: event.extendedProps.raw.descricao,
                            recorrente: event.extendedProps.raw.recorrente
                        };

                        const response = await fetch(`${API_BASE}/agenda/${event.id}/update/`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrftoken},
                            body: JSON.stringify(payload)
                        });
                        
                        const res = await response.json();
                        if(!res.success) {
                            alert('Erro ao mover evento: ' + res.error);
                            info.revert();
                        } else {
                            // Update local data raw props
                            event.setExtendedProp('raw', { ...event.extendedProps.raw, data_inicio: payload.data_inicio, data_fim: payload.data_fim });
                        }
                    } catch(e) {
                        console.error(e);
                        alert('Erro de conexão ao mover evento');
                        info.revert();
                    }
                }
            });

            calendar.render();
            console.log('Calendar rendered successfully');
        
        } catch(e) {
            console.error('Error instantiating FullCalendar:', e);
            calendarEl.innerHTML = `<div style='color:red;'>Erro ao criar calendário: ${e.message}</div>`;
        }
    }

    // === STAFF TASKS FUNCTIONS ===

    function renderStaffTasksBoard() {
        const container = document.getElementById('dataCard');
        container.innerHTML = '';
        container.classList.remove('data-card');
        container.style.background = 'transparent';
        container.style.boxShadow = 'none';

        const columns = [
            { id: 'todo', title: 'A Fazer', color: '#EF4444' },
            { id: 'doing', title: 'Em Andamento', color: '#F59E0B' },
            { id: 'done', title: 'Concluído', color: '#10B981' }
        ];

        const board = document.createElement('div');
        board.className = 'kanban-container';

        columns.forEach(col => {
            const colItems = currentData
                .filter(item => item.status === col.id)
                .sort((a, b) => {
                     // Put items with due_date first
                     if(a.due_date && !b.due_date) return -1;
                     if(!a.due_date && b.due_date) return 1;
                     if(a.due_date && b.due_date) return new Date(a.due_date) - new Date(b.due_date);
                     return new Date(b.updated_at) - new Date(a.updated_at);
                });

            const colDiv = document.createElement('div');
            colDiv.className = 'kanban-column';
            colDiv.innerHTML = `
                <div class="kanban-column-header" style="border-top-color: ${col.color}">
                    <span class="kanban-column-title">${col.title}</span>
                    <span class="badge kanban-column-count">${colItems.length}</span>
                </div>
                <div class="kanban-column-content" id="col-${col.id}" ondrop="staffTaskDrop(event, '${col.id}')" ondragover="kanbanAllowDrop(event)">
                    ${colItems.map(item => createStaffTaskCardHTML(item)).join('')}
                </div>
            `;
            board.appendChild(colDiv);
        });

        container.appendChild(board);
    }

    function createStaffTaskCardHTML(item) {
        // Render clients as tags
        const clientsHtml = item.clients.map(c => 
            `<span style="background: #e5e7eb; color: #374151; font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; display: inline-block; margin-right: 4px; margin-bottom: 4px;">${c.nome.split(' ')[0]}</span>`
        ).join('');

        // Priority Badge
        let priorityBadge = '';
        if(item.priority === 'high') priorityBadge = '<span class="badge badge-danger" style="font-size: 0.65rem;">Alta</span>';
        else if(item.priority === 'medium') priorityBadge = '<span class="badge badge-warning" style="font-size: 0.65rem;">Média</span>';
        else priorityBadge = '<span class="badge badge-success" style="font-size: 0.65rem;">Baixa</span>';

        // Due Date
        let dueDateHtml = '';
        if(item.due_date) {
             const today = new Date();
             const due = new Date(item.due_date + 'T00:00:00'); // Assuming YYYY-MM-DD
             today.setHours(0,0,0,0);
             const diffTime = due - today;
             const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
             
             let dateColor = '#6b7280';
             let icon = '📅';
             
             if(diffDays < 0) { dateColor = '#EF4444'; icon = '⚠️'; } // Overdue
             else if(diffDays === 0) { dateColor = '#F59E0B'; icon = '🕒'; } // Today
             
             const formattedDate = new Date(item.due_date + 'T12:00:00').toLocaleDateString('pt-BR');
             dueDateHtml = `<span style="color: ${dateColor}; font-size: 0.75rem; display: flex; align-items: center; gap: 4px;">${icon} ${formattedDate}</span>`;
        }

        return `
        <div class="kanban-card" draggable="true" ondragstart="kanbanDrag(event)" id="task-${item.id}" data-id="${item.id}" data-status="${item.status}" onclick="openStaffTaskModal(${item.id})" style="cursor: pointer; position: relative;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 4px;">
                 <div style="font-weight: 600; color: #111827;">${item.title}</div>
                 ${priorityBadge}
            </div>
            ${item.description ? `<div style="font-size: 0.85rem; color: #6b7280; margin-bottom: 8px;">${item.description}</div>` : ''}
            <div style="margin-bottom: 8px;">${clientsHtml}</div>
            <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem; color: #9ca3af; border-top: 1px solid #f3f4f6; padding-top: 6px; margin-top: 6px;">
                ${dueDateHtml || '<span>' + item.updated_at + '</span>'}
                <button onclick="deleteStaffTask(event, ${item.id})" style="background: none; border: none; color: #ef4444; cursor: pointer; padding: 2px;">
                    🗑
                </button>
            </div>
        </div>
        `;
    }

    async function staffTaskDrop(ev, newStatus) {
        ev.preventDefault();
        const data = ev.dataTransfer.getData("text/plain");
        // Ensure we are dragging a task card
        if (!data.startsWith("task-")) return; 
        
        const card = document.getElementById(data);
        const cardId = card.dataset.id;
        
        // Optimistic update
        ev.currentTarget.appendChild(card);
        updateColumnCounts();

        try {
            const response = await fetch(`${API_BASE}/staff-tasks/${cardId}/update/`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrftoken},
                body: JSON.stringify({ status: newStatus })
            });
            const res = await response.json();
            if(!res.success) {
                alert("Erro ao atualizar status: " + res.error);
                loadModelData('staff-tasks'); // Revert
            }
        } catch(e) {
            console.error(e);
            alert("Erro de conexão");
            loadModelData('staff-tasks');
        }
    }

    async function deleteStaffTask(e, id) {
        e.stopPropagation();
        if(!confirm("Tem certeza que deseja excluir esta tarefa?")) return;
        
        try {
            const response = await fetch(`${API_BASE}/staff-tasks/${id}/delete/`, {
                method: 'DELETE',
                headers: {'X-CSRFToken': csrftoken}
            });
            if((await response.json()).success) {
                loadModelData('staff-tasks');
            } else {
                alert("Erro ao excluir");
            }
        } catch(e) {
            alert("Erro de conexão");
        }
    }

    // Modal Create/Edit Staff Task
    let currentEditingTaskId = null;

    async function openStaffTaskModal(taskId = null) {
        // Handle Event object being passed if called from button click
        if (taskId && (taskId instanceof Event || taskId.type === 'click')) {
            taskId = null;
        }

        currentEditingTaskId = taskId;
        document.getElementById('staffTaskForm').reset();
        const titleEl = document.querySelector('#staffTaskModal .modal-title');
        titleEl.textContent = taskId ? 'Editar Tarefa' : 'Nova Tarefa Interna';
        
        // Load clients for selection
        const select = document.getElementById('staffTaskClients');
        select.innerHTML = '<option>Carregando...</option>';
        document.getElementById('staffTaskModal').classList.add('active');
        
        try {
            // Load clients
            const resp = await fetch(`${API_BASE}/clientes/`);
            const res = await resp.json();
            if(res.success) {
                select.innerHTML = res.data.map(c => `<option value="${c.id}">${c.nome}</option>`).join('');
            } else {
                select.innerHTML = '<option>Erro ao carregar clientes</option>';
            }

            // If editing, load task details
            if (taskId) {
                // Find task in currentData (we have it in memory)
                const task = currentData.find(t => t.id === taskId);
                if (task) {
                    document.getElementById('staffTaskTitle').value = task.title;
                    document.getElementById('staffTaskDescription').value = task.description || '';
                    
                    // Priority and Due Date
                    document.getElementById('staffTaskPriority').value = task.priority || 'medium';
                    document.getElementById('staffTaskDueDate').value = task.due_date || '';

                    // Select clients
                    const clientIds = task.clients.map(c => c.id.toString());
                    Array.from(select.options).forEach(opt => {
                        if (clientIds.includes(opt.value)) {
                            opt.selected = true;
                        }
                    });
                }
            } else {
                 // Defaults for new task
                 document.getElementById('staffTaskPriority').value = 'medium';
            }
        } catch(e) {
            select.innerHTML = '<option>Erro ao carregar dados</option>';
        }
    }

    function closeStaffTaskModal() {
        document.getElementById('staffTaskModal').classList.remove('active');
        currentEditingTaskId = null;
    }

    document.getElementById('staffTaskForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const title = document.getElementById('staffTaskTitle').value;
        const description = document.getElementById('staffTaskDescription').value;
        const priority = document.getElementById('staffTaskPriority').value;
        const dueDate = document.getElementById('staffTaskDueDate').value;
        const select = document.getElementById('staffTaskClients');
        const clientIds = Array.from(select.selectedOptions).map(opt => opt.value);

        try {
            let url = `${API_BASE}/staff-tasks/`;
            let method = 'POST';
            
            if (currentEditingTaskId) {
                url = `${API_BASE}/staff-tasks/${currentEditingTaskId}/update/`;
                // method POST is used for update in my view implementation (api_staff_tasks_update)
            }

            const response = await fetch(url, {
                method: method,
                headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrftoken},
                body: JSON.stringify({
                    title: title,
                    description: description,
                    priority: priority,
                    due_date: dueDate,
                    client_ids: clientIds
                })
            });
            
            const res = await response.json();
            if(res.success) {
                closeStaffTaskModal();
                if(currentModel === 'staff-tasks') {
                    loadModelData('staff-tasks');
                } else {
                    alert('Tarefa salva com sucesso!');
                }
            } else {
                alert('Erro: ' + res.error);
            }
        } catch(e) {
            console.error(e);
            alert('Erro ao salvar tarefa');
        }
    });



    async function deleteItem(id) {
        if(!confirm('Tem certeza que deseja excluir este item?')) return;
        
        try {
            // Adjust endpoint format based on existing patterns
            // Patterns seen: /api/leads/<id>/delete/
            // My agenda urls: /api/agenda/<id>/delete/
            
            const url = `${API_BASE}/${currentModel}/${id}/delete/`;
            const response = await fetch(url, {
                method: 'POST', // Django views usually require POST for side-effects unless using DRF generic views with DELETE method enabled
                headers: {'X-CSRFToken': csrftoken}
            });
            // Note: My views usually return JsonResponse.
            
            if (response.ok) {
                 const res = await response.json();
                 if(res.success) {
                    loadModelData(currentModel);
                 } else {
                    alert('Erro ao excluir: ' + (res.error || 'Erro desconhecido'));
                 }
            } else {
                alert('Erro na requisição de exclusão');
            }
        } catch(e) {
            console.error(e);
            alert('Erro ao excluir item');
        }
    }

    // --- Funções de Agenda (Novo) ---

    async function syncGoogleCalendar() {
        const btn = document.getElementById('btnSyncGoogle');
        const originalText = btn.innerHTML;
        btn.innerHTML = 'Sincronizando...';
        btn.disabled = true;

        try {
            const response = await fetch(`${API_BASE}/agenda/sync/`);
            const res = await response.json();
            
            if(res.success) {
                alert(res.message);
                loadModelData('agenda');
            } else {
                alert('Erro: ' + (res.error || 'Erro desconhecido'));
            }
        } catch(e) {
            console.error(e);
            alert('Erro ao sincronizar com Google Calendar');
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    let currentAgendaId = null;

    async function openAgendaModal(id = null) {
        currentAgendaId = id;
        document.getElementById('agendaForm').reset();
        
        if (id) {
             // Find item in currentData
             const item = currentData.find(i => i.id == id);
             if(item) {
                 document.getElementById('agendaTitulo').value = item.titulo;
                 // Format date for datetime-local input: YYYY-MM-DDTHH:mm
                 // item.data_inicio comes as "2023-10-27 10:00" from backend strftime, or ISO?
                 // My view sends strftime('%Y-%m-%d %H:%M').
                 // datetime-local expects "YYYY-MM-DDTHH:mm". So replace ' ' with 'T'.
                 
                 document.getElementById('agendaDataInicio').value = item.data_inicio ? item.data_inicio.replace(' ', 'T') : '';
                 document.getElementById('agendaDataFim').value = item.data_fim ? item.data_fim.replace(' ', 'T') : '';
                 document.getElementById('agendaDescricao').value = item.descricao || '';
                 document.getElementById('agendaRecorrente').checked = item.recorrente;
             }
        } else {
             // Default values if needed
        }
        
        document.getElementById('agendaModal').classList.add('active');
    }

    function closeAgendaModal() {
        document.getElementById('agendaModal').classList.remove('active');
        currentAgendaId = null;
    }

    document.getElementById('agendaForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const titulo = document.getElementById('agendaTitulo').value;
        const dataInicio = document.getElementById('agendaDataInicio').value;
        const dataFim = document.getElementById('agendaDataFim').value;
        const descricao = document.getElementById('agendaDescricao').value;
        const recorrente = document.getElementById('agendaRecorrente').checked;
        
        const payload = {
            titulo: titulo,
            data_inicio: dataInicio,
            data_fim: dataFim,
            descricao: descricao,
            recorrente: recorrente
        };

        try {
            let url = `${API_BASE}/agenda/create/`; 
            
            if (currentAgendaId) {
                url = `${API_BASE}/agenda/${currentAgendaId}/update/`;
            }

            const response = await fetch(url, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrftoken},
                body: JSON.stringify(payload)
            });
            
            const res = await response.json();
            if(res.success) {
                if (res.warning) {
                    alert('Atenção: ' + res.warning);
                }
                closeAgendaModal();
                if(currentModel === 'agenda') {
                    loadModelData('agenda');
                }
                // Optional: Show success toast
            } else {
                alert('Erro: ' + (res.error || 'Erro desconhecido'));
            }
        } catch(e) {
            console.error(e);
            alert('Erro ao salvar agenda');
        }
    });

    // --- Funções de Processo Abertura ---
    async function openProcessoDetails(id) {
        const modal = document.getElementById('processoAberturaModal');
        const body = document.getElementById('processoBody');
        const title = document.getElementById('processoTitle');
        
        modal.classList.add('active');
        title.textContent = `Processo #${id}`;
        body.innerHTML = '<div style="text-align: center; padding: 20px;">Carregando detalhes...</div>';
        
        try {
            const response = await fetch(`${API_BASE}/processos-abertura/${id}/`);
            const res = await response.json();
            
            if (res.success) {
                const d = res.data;
                
                // Construir lista de documentos
                let docsHtml = '';
                if (Object.keys(d.documentos).length > 0) {
                    docsHtml = `<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; margin-top: 10px;">`;
                    for (const [docName, docUrl] of Object.entries(d.documentos)) {
                        docsHtml += `
                            <a href="${docUrl}" target="_blank" style="display: block; padding: 10px; border: 1px solid #dfe1e6; border-radius: 8px; text-decoration: none; color: inherit; text-align: center; transition: all 0.2s;">
                                <div style="font-size: 24px;">📄</div>
                                <div style="font-size: 0.85rem; font-weight: 500; margin-top: 5px;">${docName}</div>
                            </a>
                        `;
                    }
                    docsHtml += `</div>`;
                } else {
                    docsHtml = '<div style="color: #6b7280; font-style: italic;">Nenhum documento enviado ainda.</div>';
                }
                
                // Construir lista de sócios
                let sociosHtml = '';
                if (d.socios.length > 0) {
                    sociosHtml = `<ul style="list-style: none; padding: 0; margin-top: 10px;">`;
                    d.socios.forEach(socio => {
                        sociosHtml += `
                            <li style="padding: 12px; border-bottom: 1px solid #eee; font-size: 0.9rem; background: #f9fafb; border-radius: 6px; margin-bottom: 8px;">
                                <div style="font-weight: 600; color: #374151; margin-bottom: 6px; display: flex; justify-content: space-between;">
                                    ${socio.nome} 
                                    <span style="font-weight: 500; color: var(--primary-color); background: #e0e7ff; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem;">${socio.participacao}</span>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; color: #4b5563; font-size: 0.85rem;">
                                    <div><strong>CPF:</strong> ${socio.cpf}</div>
                                    <div><strong>RG:</strong> ${socio.rg || '-'}</div>
                                    <div style="grid-column: span 2;"><strong>Estado Civil:</strong> ${socio.estado_civil || '-'}</div>
                                </div>
                                <div style="margin-top: 6px; color: #4b5563; font-size: 0.85rem; border-top: 1px solid #eee; padding-top: 6px;">
                                    <strong>Endereço:</strong> ${socio.endereco || '-'}
                                </div>
                            </li>
                        `;
                    });
                    sociosHtml += `</ul>`;
                } else {
                    sociosHtml = '<div style="color: #6b7280;">Sem sócios cadastrados.</div>';
                }
                
                body.innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                        <div>
                            <h4 style="border-bottom: 2px solid #f3f4f6; padding-bottom: 8px; margin-bottom: 16px; color: var(--primary-color);">Dados Pessoais</h4>
                            <div style="margin-bottom: 12px;"><strong>Responsável:</strong> ${d.responsavel.nome || '-'}</div>
                            <div style="margin-bottom: 12px;"><strong>CPF:</strong> ${d.responsavel.cpf || '-'}</div>
                             <div style="margin-bottom: 12px;"><strong>RG:</strong> ${d.responsavel.rg || '-'}</div>
                            <div style="margin-bottom: 12px;"><strong>Email:</strong> ${d.responsavel.email || '-'}</div>
                            <div style="margin-bottom: 12px;"><strong>Telefone:</strong> ${d.responsavel.telefone || '-'}</div>
                             <div style="margin-bottom: 12px;">
                                <strong>Endereço:</strong><br>
                                <span style="color: #4b5563; font-size: 0.9rem;">${d.responsavel.endereco || 'Não informado'}</span>
                            </div>
                        </div>
                        
                        <div>
                            <h4 style="border-bottom: 2px solid #f3f4f6; padding-bottom: 8px; margin-bottom: 16px; color: var(--primary-color);">Dados da Empresa</h4>
                            <div style="margin-bottom: 12px;"><strong>Tipo:</strong> ${d.empresa.tipo || '-'}</div>
                            <div style="margin-bottom: 12px;"><strong>Nome Fantasia:</strong> ${d.empresa.nome_fantasia}</div>
                            ${d.empresa.razao_social !== '-' ? `<div style="margin-bottom: 12px;"><strong>Razão Social:</strong> ${d.empresa.razao_social}</div>` : ''}
                            <div style="margin-bottom: 12px;"><strong>Atividade Principal:</strong> ${d.empresa.atividade_principal}</div>
                            ${d.empresa.area_atuacao ? `<div style="margin-bottom: 12px;"><strong>Área de Atuação:</strong> ${d.empresa.area_atuacao}</div>` : ''}
                            <div style="margin-bottom: 12px;"><strong>Regime:</strong> ${d.empresa.regime_tributario}</div>
                            <div style="margin-bottom: 12px;">
                                <strong>Endereço Comercial:</strong><br>
                                <span style="color: #4b5563; font-size: 0.9rem;">${d.empresa.endereco_comercial}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-top: 24px;">
                         <div>
                            <h4 style="border-bottom: 2px solid #f3f4f6; padding-bottom: 8px; margin-bottom: 16px; color: var(--primary-color);">Dados Fiscais</h4>
                            <div style="margin-bottom: 8px;"><strong>Tipo Atividade:</strong> ${d.fiscal.tipo_atividade || '-'}</div>
                            <div style="margin-bottom: 8px;"><strong>Usa Nota Fiscal:</strong> ${d.fiscal.usa_nota_fiscal}</div>
                            <div style="margin-bottom: 8px;"><strong>Precisa Alvará:</strong> ${d.fiscal.precisa_alvara}</div>
                            <div style="margin-bottom: 8px;"><strong>Conta PJ:</strong> ${d.fiscal.deseja_conta_pj}</div>
                        </div>
                        <div>
                            <h4 style="border-bottom: 2px solid #f3f4f6; padding-bottom: 8px; margin-bottom: 16px; color: var(--primary-color);">Contratação</h4>
                             <div style="margin-bottom: 8px;"><strong>Plano:</strong> ${d.pagamento.plano}</div>
                             <div style="margin-bottom: 8px;"><strong>Valor Pago:</strong> ${d.pagamento.valor}</div>
                             <div style="margin-bottom: 8px;"><strong>Data:</strong> ${d.pagamento.data}</div>
                        </div>
                    </div>

                    <div style="margin-top: 24px;">
                        <h4 style="border-bottom: 2px solid #f3f4f6; padding-bottom: 8px; margin-bottom: 16px; color: var(--primary-color);">Documentos</h4>
                        ${docsHtml}
                    </div>
                    
                    <div style="margin-top: 24px;">
                        <h4 style="border-bottom: 2px solid #f3f4f6; padding-bottom: 8px; margin-bottom: 16px; color: var(--primary-color);">Sócios</h4>
                        ${sociosHtml}
                    </div>

                    <div style="margin-top: 24px; text-align: right; border-top: 1px solid #eee; padding-top: 16px;">
                        <span style="margin-right: 16px; font-weight: 600;">Status Atual: ${d.status} (Etapa ${d.etapa})</span>
                    </div>
                `;
            } else {
                body.innerHTML = `<div style="color: red; text-align: center;">Erro: ${res.error}</div>`;
            }
        } catch (e) {
            console.error(e);
            body.innerHTML = `<div style="color: red; text-align: center;">Erro de conexão ao buscar detalhes.</div>`;
        }
    }

    function closeProcessoAberturaModal() {
        document.getElementById('processoAberturaModal').classList.remove('active');
    }

    // Handle Quick Actions Override (Move startAction here or update existing)
    // Note: startAction was defined earlier in replace_string, but we can override or ensure logic matches.

    function openActiveClientsModal() {
        currentActiveRegime = 'all';
        document.getElementById('activeClientsModalTitle').textContent = 'Clientes Ativos';
        document.getElementById('activeClientsModal').classList.add('active');
        renderActiveClientsList();
    }

    function openRegimeModal(regimeCode, regimeTitle) {
        currentActiveRegime = regimeCode;
        document.getElementById('activeClientsModalTitle').textContent = regimeTitle;
        document.getElementById('activeClientsModal').classList.add('active');
        renderActiveClientsList();
    }

    function closeActiveClientsModal() {
        document.getElementById('activeClientsModal').classList.remove('active');
    }

    function renderActiveClientsList(filterText = '') {
        const list = document.getElementById('activeClientsList');
        if(!currentData) { list.innerHTML = '<div style="padding:20px; text-align:center;">Carregando...</div>'; return; }
        
        let filtered = currentData;
        
        // Filter by Regime if set
        if (currentActiveRegime !== 'all') {
            filtered = filtered.filter(c => c.regime === currentActiveRegime);
        }

        // Filter by search text
        if(filterText) {
            const ft = filterText.toLowerCase();
            filtered = filtered.filter(c => c.nome.toLowerCase().includes(ft));
        }
        
        if(filtered.length === 0) {
             list.innerHTML = '<div style="padding:20px; text-align:center;">Nenhum cliente encontrado.</div>';
             return;
        }

        list.innerHTML = filtered.map(c => `
            <div style="padding: 12px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <div style="font-weight: 600; color:#172b4d;">${c.nome}</div>
                    <div style="font-size: 0.85rem; color: #5e6c84;">${c.email}</div>
                </div>
                <div style="display:flex; align-items:center; gap: 8px;">
                    <span class="badge" style="background:#e0e7ff; color:#3730a3; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem;">${c.regime || '-'}</span>
                    <button class="btn button" style="background:var(--primary-color); color:white; border:none; border-radius:4px; padding:6px 12px; cursor:pointer;" onclick="openClientDetailFromModal(${c.id}, '${c.nome.replace(/'/g, "\\'")}', '${c.email}')">
                        Detalhes
                    </button>
                </div>
            </div>
        `).join('');
    }
    
    function openClientDetailFromModal(id, nome, email) {
        // Close modal first
        closeActiveClientsModal();
        // Open detailed panel
        openClientPanel(id, nome, email);
    }

    function filterActiveClientsList() {
        const val = document.getElementById('activeClientsSearch').value;
        renderActiveClientsList(val);
    }
    
    // Carregar dados iniciais e forçar modo Board
    loadModelData('clientes'); // Carregar clientes
    // document.querySelector('.menu-item[data-model="chamados"]').classList.add('active'); // Sidebar removed
</script>
</body>
</html>
