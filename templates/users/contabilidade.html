{% extends 'base_dashboard.html' %}
{% load static %}

{% block page_title %}Contabilidade - Meus Lançamentos{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/dashboard-modern.css' %}">
<style>
    /* Ajustes específicos para contabilidade */
    #summary-chart { max-height: 220px; width: 100%; }
    #transmissao-chart { max-height: 280px; width: 100%; }
    #months-list .list-group-item { 
        cursor: pointer; 
        margin-bottom: 8px; 
        border-radius: 8px;
        border: 1px solid #e2e8f0;
        transition: all 0.2s;
    }
    #months-list .list-group-item:hover {
        background-color: #f8fafc;
        border-color: #cbd5e1;
    }
    #drafts-table td, #drafts-table th { vertical-align: middle; }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-wrapper">
    <div class="dashboard-header">
        <h1 class="dashboard-title">Contabilidade</h1>
        <p class="dashboard-subtitle">Gerencie seus lançamentos e transmissões mensais</p>
    </div>

    <div class="dash-card mb-4">
        <div class="dash-card-body">
            <div class="row align-items-end">
                <div class="col-md-4">
                    <label for="select-month" class="form-label fw-bold">Selecione o mês</label>
                    <div class="d-flex gap-2">
                        <input type="month" id="select-month" class="form-control">
                        <button id="btn-select-month" class="btn-dash btn-dash-primary">Abrir</button>
                    </div>
                    <small class="text-muted mt-1 d-block">Escolha o mês/ano para lançar suas movimentações.</small>
                </div>
                <div class="col-md-8">
                    <div id="month-message" class="text-muted ms-md-3 mt-3 mt-md-0">Selecione um mês para começar.</div>
                </div>
            </div>
        </div>
    </div>

    <div id="work-area" class="d-none">
        <div class="row g-4">
            <div class="col-lg-8">
                <!-- Resumo Mensal -->
                <div class="dash-card mb-4">
                    <div class="dash-card-header">
                        <div>
                            <h3 class="dash-card-title">Resumo Mensal</h3>
                            <p class="dash-card-subtitle">Visão geral das receitas e despesas</p>
                        </div>
                        <div class="dash-card-icon icon-primary">
                            <i class="fas fa-chart-bar"></i>
                        </div>
                    </div>
                    <div class="dash-card-body">
                        <canvas id="summary-chart" height="120"></canvas>
                        <div class="mt-4 d-flex justify-content-around align-items-center p-3 bg-light rounded-3">
                            <div class="text-center">
                                <div class="small text-muted mb-1">Receitas</div>
                                <strong id="total-receitas" class="text-success fs-5">R$ 0,00</strong>
                            </div>
                            <div class="text-center border-start border-end px-4">
                                <div class="small text-muted mb-1">Despesas</div>
                                <strong id="total-despesas" class="text-danger fs-5">R$ 0,00</strong>
                            </div>
                            <div class="text-center">
                                <div class="small text-muted mb-1">Resultado</div>
                                <strong id="resultado-mes" class="fs-5">R$ 0,00</strong>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Lançamentos -->
                <div class="dash-card">
                    <div class="dash-card-header">
                        <div>
                            <h3 class="dash-card-title">Lançamentos do Mês <span id="current-month-label" class="text-primary"></span></h3>
                            <p class="dash-card-subtitle">Adicione ou edite seus lançamentos</p>
                        </div>
                        <div class="dash-card-icon icon-secondary">
                            <i class="fas fa-list-alt"></i>
                        </div>
                    </div>
                    <div class="dash-card-body">
                        <form id="mov-form" class="mb-4 p-3 bg-light rounded-3 border border-light">
                            {% csrf_token %}
                            <input type="hidden" id="mov-id" name="mov_id" value="">
                            <input type="hidden" id="current-month" name="current_month" value="">

                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label fw-bold small">Tipo</label>
                                    <select class="form-select" id="tipo" name="tipo">
                                        <option value="receita">Receita</option>
                                        <option value="despesa">Despesa</option>
                                    </select>
                                </div>
                                <div class="col-md-8">
                                    <label class="form-label fw-bold small">Nome / Descrição</label>
                                    <input class="form-control" id="nome" name="nome" required placeholder="Ex: Venda de serviço, Compra de material...">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold small">Data</label>
                                    <input class="form-control" id="data" name="data" type="date" required>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold small">Valor (R$)</label>
                                    <input class="form-control" id="valor" name="valor" type="number" step="0.01" required placeholder="0,00">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold small">Anexar Documento</label>
                                    <input class="form-control" id="anexo" name="anexo" type="file">
                                </div>
                                <div class="col-12 d-flex gap-2 justify-content-end mt-3">
                                    <button id="btn-reset" class="btn-dash btn-dash-outline btn-sm" type="button">Limpar</button>
                                    <button id="btn-save" class="btn-dash btn-dash-primary btn-sm" type="submit">
                                        <i class="fas fa-plus me-1"></i> Adicionar
                                    </button>
                                </div>
                            </div>
                        </form>

                        <div class="table-responsive mb-4">
                            <table class="table table-hover align-middle mb-0" id="drafts-table">
                                <thead class="bg-light">
                                    <tr>
                                        <th class="ps-3">Tipo</th>
                                        <th>Descrição</th>
                                        <th>Data</th>
                                        <th class="text-end">Valor</th>
                                        <th class="text-end pe-3">Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- preenchido por JS -->
                                </tbody>
                            </table>
                        </div>

                        <div class="d-flex justify-content-end border-top pt-3">
                            <button id="btn-transmit" class="btn-dash btn-dash-success">
                                <i class="fas fa-paper-plane me-2"></i> Transmitir Lançamentos
                            </button>
                        </div>
                        <small class="d-block text-muted text-end mt-2">Ao transmitir, seus lançamentos serão enviados para análise.</small>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="dash-card h-100">
                    <div class="dash-card-header">
                        <div>
                            <h3 class="dash-card-title">Histórico</h3>
                            <p class="dash-card-subtitle">Transmissões anteriores</p>
                        </div>
                        <div class="dash-card-icon icon-info">
                            <i class="fas fa-history"></i>
                        </div>
                    </div>
                    <div class="dash-card-body">
                        <div id="months-list" class="list-group list-group-flush">
                            <!-- preenchido por JS -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para detalhes do mês transmitido -->
<div class="modal fade" id="monthDetailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-light">
                <h5 class="modal-title fw-bold">Detalhes da Transmissão</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div id="transmissao-info" class="mb-4 p-3 bg-primary-subtle text-primary rounded-3 fw-medium"></div>
                <div class="mb-4">
                    <canvas id="transmissao-chart" height="100"></canvas>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle" id="transmissao-items">
                        <thead class="bg-light">
                            <tr><th>Tipo</th><th>Descrição</th><th>Competência</th><th>Status</th><th class="text-end">Valor</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn-dash btn-dash-outline" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(function(){
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    function q(sel, ctx=document){ return ctx.querySelector(sel); }
    function qa(sel, ctx=document){ return Array.from(ctx.querySelectorAll(sel)); }

    const state = { month: null, drafts: [], totals: {receitas: 0, despesas: 0} };

    function money(v){
        try{ return Number(v).toLocaleString('pt-BR', {minimumFractionDigits:2, maximumFractionDigits:2}); }catch(e){ return v; }
    }

    function showWorkAreaFor(month){
        state.month = month;
        q('#current-month').value = month;
        q('#current-month-label').textContent = month;
        q('#month-message').textContent = `Editando lançamentos para ${month}`;
        q('#work-area').classList.remove('d-none');
        loadDrafts(month);
        loadMonthsList();
    }

    // chart setup
    const ctx = document.getElementById('summary-chart').getContext('2d');
    const summaryChart = new Chart(ctx, {
        type: 'bar',
        data: { labels: ['Receitas','Despesas'], datasets: [{ label: 'Total', data: [0,0], backgroundColor: ['#198754','#dc3545'] }] },
        options: { responsive:true, scales:{ y: { beginAtZero:true } }, plugins:{ legend:{ display:false } } }
    });

    function updateSummary(totals){
        const r = Number(totals.receitas || 0);
        const d = Number(totals.despesas || 0);
        summaryChart.data.datasets[0].data = [r, d];
        summaryChart.update();
        q('#total-receitas').textContent = 'R$ ' + money(r);
        q('#total-despesas').textContent = 'R$ ' + money(d);
        const res = r - d;
        const el = q('#resultado-mes');
        el.textContent = 'R$ ' + money(res);
        el.style.color = res>0 ? '#198754' : res<0 ? '#dc3545' : '#6c757d';
    }

    function rowFromMov(mov){
        const tr = document.createElement('tr');
        tr.setAttribute('data-id', mov.id);
        
        let tipoBadge = '';
        if(mov.tipo === 'receita') {
            tipoBadge = '<span class="badge bg-success-subtle text-success">Receita</span>';
        } else {
            tipoBadge = '<span class="badge bg-danger-subtle text-danger">Despesa</span>';
        }

        tr.innerHTML = `
            <td class="ps-3">${tipoBadge}</td>
            <td class="fw-medium">${mov.nome}</td>
            <td class="text-muted">${mov.competencia}</td>
            <td class="text-end fw-bold">R$ ${money(mov.valor)}</td>
            <td class="text-end pe-3">
                <button class="btn btn-sm btn-link text-primary edit-mov p-0 me-2" title="Editar"><i class="fas fa-edit"></i></button>
                <button class="btn btn-sm btn-link text-danger delete-mov p-0" title="Excluir"><i class="fas fa-trash-alt"></i></button>
            </td>
        `;
        return tr;
    }

    function loadDrafts(month){
        fetch(`/users/contabilidade/drafts/?month=${encodeURIComponent(month)}`, {headers:{'X-CSRFToken': csrftoken}})
        .then(r=>r.json()).then(data=>{
            if(!data.success){ alert(data.error||'Erro'); return; }
            state.drafts = data.items || [];
            state.totals = { receitas: data.totals.receitas || 0, despesas: data.totals.despesas || 0 };
            const tbody = q('#drafts-table tbody'); tbody.innerHTML = '';
            if(state.drafts.length===0){ tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4">Nenhum lançamento neste mês.</td></tr>'; }
            state.drafts.forEach(m=> tbody.appendChild(rowFromMov(m)) );
            updateSummary(state.totals);
        }).catch(err=>{ console.error(err); alert('Erro de rede'); });
    }

    // months list
    function loadMonthsList(){
        fetch('/users/contabilidade/months/', {headers:{'X-CSRFToken': csrftoken}})
        .then(r=>r.json()).then(data=>{
            if(!data.success) return;
            const wrap = q('#months-list'); wrap.innerHTML = '';
            if(!data.items || data.items.length===0){ wrap.innerHTML = '<div class="text-muted text-center py-3">Nenhuma transmissão anterior.</div>'; return; }
            data.items.forEach(it=>{
                const btn = document.createElement('button');
                btn.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
                btn.innerHTML = `
                    <div>
                        <i class="fas fa-calendar-check text-success me-2"></i>
                        <span class="fw-medium">${it.competencia}</span>
                    </div>
                    <span class="badge bg-secondary rounded-pill">${it.count}</span>
                `;
                btn.addEventListener('click', ()=> loadMonthDetail(it.id));
                wrap.appendChild(btn);
            });
        }).catch(err=>{ console.error(err); });
    }

    let transmissaoChart = null;
    function loadMonthDetail(pk){
        fetch(`/users/contabilidade/month/${pk}/`, {headers:{'X-CSRFToken': csrftoken}})
        .then(r=>r.json()).then(data=>{
            if(!data.success){ alert(data.error||'Erro'); return; }
            q('#transmissao-info').innerHTML = `<i class="fas fa-info-circle me-2"></i>Competência: <strong>${data.transmissao.competencia}</strong> • Transmitido em: <strong>${new Date(data.transmissao.transmitted_at).toLocaleString()}</strong>`;
            const tbody = q('#transmissao-items tbody'); tbody.innerHTML = '';

            // calcular totais por tipo para o gráfico
            let totalR = 0, totalD = 0;
            data.items.forEach(it=>{
                const tr = document.createElement('tr');
                
                let tipoBadge = '';
                if(it.tipo === 'receita') {
                    tipoBadge = '<span class="badge bg-success-subtle text-success">Receita</span>';
                } else {
                    tipoBadge = '<span class="badge bg-danger-subtle text-danger">Despesa</span>';
                }

                tr.innerHTML = `<td>${tipoBadge}</td><td>${it.nome}</td><td>${it.competencia}</td><td>${it.status_display}</td><td class="text-end">R$ ${money(it.valor)}</td>`;
                tbody.appendChild(tr);
                if(it.tipo === 'receita') totalR += Number(it.valor);
                if(it.tipo === 'despesa') totalD += Number(it.valor);
            });

            // renderizar gráfico de colunas (Receitas x Despesas)
            const canvas = document.getElementById('transmissao-chart');
            if(transmissaoChart){ transmissaoChart.destroy(); transmissaoChart = null; }
            const ctx2 = canvas.getContext('2d');
            transmissaoChart = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: ['Receitas','Despesas'],
                    datasets: [{
                        label: 'Total (R$)',
                        data: [totalR, totalD],
                        backgroundColor: ['#198754', '#dc3545'],
                        borderColor: ['#155e3b', '#a71d2a'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, ticks: { callback: function(value){ return value.toLocaleString('pt-BR', {minimumFractionDigits:2, maximumFractionDigits:2}); } } } }
                }
            });

            const modalEl = document.getElementById('monthDetailModal');
            const bsModal = new bootstrap.Modal(modalEl);
            bsModal.show();
        }).catch(err=>{ console.error(err); alert('Erro de rede'); });
    }

    // select month
    q('#btn-select-month').addEventListener('click', function(){
        const m = q('#select-month').value;
        if(!m){ alert('Selecione um mês.'); return; }
        showWorkAreaFor(m);
    });

    // form submit add/edit
    q('#mov-form').addEventListener('submit', function(e){
        e.preventDefault();
        const movId = q('#mov-id').value;
        const fd = new FormData();
        fd.append('tipo', q('#tipo').value);
        fd.append('nome', q('#nome').value);
        // use selected month as competencia
        fd.append('competencia', q('#current-month').value);
        fd.append('valor', q('#valor').value);
        const file = q('#anexo').files[0]; if(file) fd.append('anexo', file);

        const url = movId ? `/users/contabilidade/edit/${movId}/` : '/users/contabilidade/add/';
        fetch(url, { method:'POST', headers:{'X-CSRFToken': csrftoken}, body: fd }).then(r=>r.json()).then(data=>{
            if(!data.success){ alert(data.error||'Erro'); return; }
            // refresh drafts
            loadDrafts(state.month);
            q('#mov-form').reset(); q('#mov-id').value = '';
        }).catch(err=>{ console.error(err); alert('Erro de rede'); });
    });

    q('#btn-reset').addEventListener('click', function(){ q('#mov-form').reset(); q('#mov-id').value = ''; });

    // delegate edit/delete
    q('#drafts-table').addEventListener('click', function(e){
        const tr = e.target.closest('tr'); if(!tr) return; const id = tr.getAttribute('data-id');
        if(e.target.classList.contains('edit-mov') || e.target.closest('.edit-mov')){
            // populate form with data from state
            const mov = state.drafts.find(x=>String(x.id)===String(id)); if(!mov) return;
            q('#mov-id').value = mov.id; q('#tipo').value = mov.tipo; q('#nome').value = mov.nome; q('#valor').value = mov.valor; q('#data').value = mov.competencia+'-01'; // approximate
            window.scrollTo({top:0, behavior:'smooth'});
        }
        if(e.target.classList.contains('delete-mov') || e.target.closest('.delete-mov')){
            if(!confirm('Excluir este rascunho?')) return;
            fetch(`/users/contabilidade/delete/${id}/`, { method:'POST', headers:{'X-CSRFToken': csrftoken} }).then(r=>r.json()).then(data=>{
                if(!data.success){ alert(data.error||'Erro'); return; }
                loadDrafts(state.month);
            }).catch(err=>{ console.error(err); alert('Erro de rede'); });
        }
    });

    q('#btn-transmit').addEventListener('click', function(){
        if(!confirm('Transmitir todos os rascunhos deste mês para a contabilidade?')) return;
        const fd = new FormData(); fd.append('month', state.month);
        fetch('/users/contabilidade/transmit/', { method:'POST', headers:{'X-CSRFToken': csrftoken}, body: fd }).then(r=>r.json()).then(data=>{
            if(!data.success){ alert(data.error||'Erro'); return; }
            alert(`${data.transmitted} lançamentos transmitidos.`);
            loadDrafts(state.month); loadMonthsList();
        }).catch(err=>{ console.error(err); alert('Erro de rede'); });
    });

    // initial load of months
    loadMonthsList();

})();
</script>
{% endblock %}
