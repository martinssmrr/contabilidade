{% extends 'base.html' %}
{% load static %}

{% block title %}Pagamento - {{ plano.nome }} | Vetorial Contabilidade{% endblock %}

{% block extra_css %}
<style>
    .checkout-container {
        max-width: 900px;
        margin: 0 auto;
        padding: 2rem 1rem;
    }
    
    .checkout-header {
        text-align: center;
        margin-bottom: 2rem;
    }
    
    .checkout-header h1 {
        color: var(--secondary-color);
        font-weight: 700;
        margin-bottom: 0.5rem;
    }
    
    .checkout-header p {
        color: #6b7280;
        font-size: 1.1rem;
    }
    
    .checkout-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
    }
    
    @media (max-width: 768px) {
        .checkout-grid {
            grid-template-columns: 1fr;
        }
    }
    
    .order-summary {
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        padding: 2rem;
        height: fit-content;
        position: sticky;
        top: 100px;
    }
    
    .order-summary h2 {
        font-size: 1.25rem;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .plan-info {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .plan-icon {
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, var(--secondary-color), #582e9b);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-size: 1.5rem;
    }
    
    .plan-details h3 {
        font-size: 1.1rem;
        font-weight: 600;
        color: #1f2937;
        margin: 0;
    }
    
    .plan-details p {
        color: #6b7280;
        font-size: 0.9rem;
        margin: 0.25rem 0 0;
    }
    
    .plan-features {
        list-style: none;
        padding: 0;
        margin: 0 0 1.5rem;
    }
    
    .plan-features li {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 0;
        color: #4b5563;
        font-size: 0.9rem;
    }
    
    .plan-features li svg {
        color: var(--primary-color);
        flex-shrink: 0;
    }
    
    .price-breakdown {
        border-top: 1px solid #e5e7eb;
        padding-top: 1rem;
    }
    
    .price-row {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 0;
    }
    
    .price-row.total {
        border-top: 2px solid #e5e7eb;
        margin-top: 0.5rem;
        padding-top: 1rem;
        font-weight: 700;
        font-size: 1.25rem;
        color: var(--secondary-color);
    }
    
    .payment-section {
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        padding: 2rem;
    }
    
    .payment-section h2 {
        font-size: 1.25rem;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 1.5rem;
    }
    
    #payment-brick-container {
        min-height: 400px;
    }
    
    .security-badges {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1rem;
        margin-top: 1.5rem;
        padding-top: 1.5rem;
        border-top: 1px solid #e5e7eb;
    }
    
    .security-badge {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: #6b7280;
        font-size: 0.85rem;
    }
    
    .security-badge svg {
        color: var(--primary-color);
    }
    
    .loading-spinner {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 300px;
        color: #6b7280;
    }
    
    .loading-spinner .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid #e5e7eb;
        border-top-color: var(--secondary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    .error-message {
        background: #fef2f2;
        border: 1px solid #fecaca;
        border-radius: 8px;
        padding: 1rem;
        color: #dc2626;
        margin-bottom: 1rem;
    }
    
    .back-link {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        color: #6b7280;
        text-decoration: none;
        margin-bottom: 1.5rem;
        transition: color 0.2s;
    }
    
    .back-link:hover {
        color: var(--secondary-color);
    }
</style>
{% endblock %}

{% block content %}
<section class="checkout-page py-5 bg-light">
    <div class="checkout-container">
        <a href="{% url 'services:planos' %}" class="back-link">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/>
            </svg>
            Voltar aos planos
        </a>
        
        <div class="checkout-header">
            <h1>Finalizar Contratação</h1>
            <p>Complete seu pagamento de forma segura</p>
        </div>
        
        <div class="checkout-grid">
            <!-- Seção de Pagamento -->
            <div class="payment-section">
                <h2>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="me-2" viewBox="0 0 16 16">
                        <path d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V4zm2-1a1 1 0 0 0-1 1v1h14V4a1 1 0 0 0-1-1H2zm13 4H1v5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V7z"/>
                        <path d="M2 10a1 1 0 0 1 1-1h1a1 1 0 0 1 1 1v1a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1v-1z"/>
                    </svg>
                    Dados de Pagamento
                </h2>
                
                <div id="payment-brick-container">
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                        <p class="mt-3">Carregando formas de pagamento...</p>
                    </div>
                </div>
                
                <div class="security-badges">
                    <div class="security-badge">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8 0c-.69 0-1.843.265-2.928.56-1.11.3-2.229.655-2.887.87a1.54 1.54 0 0 0-1.044 1.262c-.596 4.477.787 7.795 2.465 9.99a11.777 11.777 0 0 0 2.517 2.453c.386.273.744.482 1.048.625.28.132.581.24.829.24s.548-.108.829-.24a7.159 7.159 0 0 0 1.048-.625 11.775 11.775 0 0 0 2.517-2.453c1.678-2.195 3.061-5.513 2.465-9.99a1.541 1.541 0 0 0-1.044-1.263 62.467 62.467 0 0 0-2.887-.87C9.843.266 8.69 0 8 0zm0 5a1.5 1.5 0 0 1 .5 2.915l.385 1.99a.5.5 0 0 1-.491.595h-.788a.5.5 0 0 1-.49-.595l.384-1.99A1.5 1.5 0 0 1 8 5z"/>
                        </svg>
                        Pagamento Seguro
                    </div>
                    <div class="security-badge">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"/>
                        </svg>
                        Criptografia SSL
                    </div>
                    <div class="security-badge">
                        <img src="https://www.mercadopago.com/org-img/Manual/ManualMP/imgs/logo-mp-100.png" alt="Mercado Pago" height="24">
                    </div>
                </div>
            </div>
            
            <!-- Resumo do Pedido -->
            <div class="order-summary">
                <h2>Resumo do Pedido</h2>
                
                <div class="plan-info">
                    <div class="plan-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M6.5 1A1.5 1.5 0 0 0 5 2.5V3H1.5A1.5 1.5 0 0 0 0 4.5v1.384l7.614 2.03a1.5 1.5 0 0 0 .772 0L16 5.884V4.5A1.5 1.5 0 0 0 14.5 3H11v-.5A1.5 1.5 0 0 0 9.5 1h-3zm0 1h3a.5.5 0 0 1 .5.5V3H6v-.5a.5.5 0 0 1 .5-.5z"/>
                            <path d="M0 12.5A1.5 1.5 0 0 0 1.5 14h13a1.5 1.5 0 0 0 1.5-1.5V6.85L8.129 8.947a.5.5 0 0 1-.258 0L0 6.85v5.65z"/>
                        </svg>
                    </div>
                    <div class="plan-details">
                        <h3>Plano {{ plano.nome }}</h3>
                        <p>{{ plano.get_categoria_display }}</p>
                    </div>
                </div>
                
                {% if plano.features %}
                <ul class="plan-features">
                    {% for feature in plano.features %}
                    <li>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"/>
                        </svg>
                        {{ feature }}
                    </li>
                    {% endfor %}
                </ul>
                {% endif %}
                
                <div class="price-breakdown">
                    <div class="price-row">
                        <span>Plano {{ plano.nome }} (mensal)</span>
                        <span>R$ {{ plano.preco|floatformat:2 }}</span>
                    </div>
                    {% if plano.tem_desconto %}
                    <div class="price-row" style="color: #10b981;">
                        <span>Desconto {{ plano.percentual_desconto|floatformat:0 }}%</span>
                        <span>- R$ {{ plano.preco_antigo|floatformat:2 }}</span>
                    </div>
                    {% endif %}
                    <div class="price-row total">
                        <span>Total</span>
                        <span>R$ {{ plano.preco|floatformat:2 }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<!-- SDK do Mercado Pago -->
<script src="https://sdk.mercadopago.com/js/v2"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Configurações
    const publicKey = "{{ mp_public_key }}";
    const preferenceId = "{{ preference_id }}";
    const externalReference = "{{ pagamento.external_reference }}";
    const amount = parseFloat("{{ plano.preco|stringformat:'f' }}".replace(',', '.'));
    
    if (!publicKey) {
        document.getElementById('payment-brick-container').innerHTML = `
            <div class="error-message">
                <strong>Erro de configuração:</strong> Chave pública do Mercado Pago não configurada.
            </div>
        `;
        return;
    }
    
    // Inicializar Mercado Pago
    const mp = new MercadoPago(publicKey, {
        locale: 'pt-BR'
    });
    
    // Renderizar Payment Brick
    const bricksBuilder = mp.bricks();
    
    // Dados do usuário logado (se existirem)
    const userEmail = "{{ request.user.email|default:'' }}";
    const userFirstName = "{{ request.user.first_name|default:'' }}";
    const userLastName = "{{ request.user.last_name|default:'' }}";
    
    const renderPaymentBrick = async () => {
        // Configurar payer apenas com dados válidos
        const payerConfig = {};
        if (userEmail) payerConfig.email = userEmail;
        if (userFirstName) payerConfig.firstName = userFirstName;
        if (userLastName) payerConfig.lastName = userLastName;
        // entityType deve ser 'individual' para pessoa física
        payerConfig.entityType = 'individual';
        // Forçar solicitação de identificação (CPF) - essencial para aprovação no Brasil
        payerConfig.identification = {
            type: 'CPF',
            number: ''
        };
        
        const settings = {
            initialization: {
                amount: amount,
                payer: payerConfig,
            },
            customization: {
                visual: {
                    style: {
                        theme: 'default',
                        customVariables: {
                            formBackgroundColor: '#ffffff',
                            baseColor: '#0c63d1',
                        }
                    },
                    hideFormTitle: true,
                    hidePaymentButton: false,
                },
                paymentMethods: {
                    creditCard: 'all',
                    debitCard: 'all',
                    ticket: 'all',
                    bankTransfer: ['pix'],
                    maxInstallments: 12,
                },
            },
            callbacks: {
                onReady: () => {
                    // Brick carregado
                    console.log('Payment Brick carregado');
                },
                onSubmit: async (formData) => {
                    // Processar pagamento
                    console.log('Processando pagamento...', formData);
                    
                    // Tentar capturar o nome do titular do cartão do DOM
                    let cardholderName = '';
                    const cardholderInput = document.querySelector('input[name="cardholderName"]') || 
                                           document.querySelector('[data-cy="cardholderName"]') ||
                                           document.querySelector('.card-holder-name input');
                    if (cardholderInput) {
                        cardholderName = cardholderInput.value;
                    }
                    
                    // Adicionar dados extras ao formData (usando variáveis do escopo superior)
                    const enrichedData = {
                        ...formData,
                        cardholderName: cardholderName,
                        userInfo: {
                            firstName: userFirstName,
                            lastName: userLastName,
                            email: userEmail,
                        }
                    };
                    
                    try {
                        const response = await fetch("{% url 'payments:processar_pagamento' %}", {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                external_reference: externalReference,
                                payment_data: enrichedData,
                            }),
                        });
                        
                        const result = await response.json();
                        console.log('Resultado do pagamento:', result);
                        
                        if (result.status === 'approved') {
                            // Pagamento aprovado - redirecionar
                            window.location.href = result.redirect_url || "{% url 'obrigado' %}";
                        } else if (result.status === 'pending' || result.status === 'in_process') {
                            // Pagamento pendente - verificar se é PIX
                            if (result.redirect_url) {
                                window.location.href = result.redirect_url;
                            } else if (result.payment_method_id === 'pix' && result.pix_data) {
                                window.location.href = "{% url 'payments:pagamento_pix' %}?external_reference=" + externalReference;
                            } else {
                                window.location.href = "{% url 'payments:pagamento_pendente' %}?external_reference=" + externalReference;
                            }
                        } else {
                            // Mostrar mensagem de erro amigável
                            const errorMessages = {
                                'cc_rejected_bad_filled_card_number': 'Número do cartão inválido',
                                'cc_rejected_bad_filled_date': 'Data de validade inválida',
                                'cc_rejected_bad_filled_other': 'Dados do cartão inválidos',
                                'cc_rejected_bad_filled_security_code': 'Código de segurança inválido',
                                'cc_rejected_blacklist': 'Cartão não autorizado',
                                'cc_rejected_call_for_authorize': 'Ligue para autorizar',
                                'cc_rejected_card_disabled': 'Cartão desabilitado',
                                'cc_rejected_duplicated_payment': 'Pagamento duplicado',
                                'cc_rejected_high_risk': 'Pagamento recusado por segurança',
                                'cc_rejected_insufficient_amount': 'Saldo insuficiente',
                                'cc_rejected_invalid_installments': 'Parcelas inválidas',
                                'cc_rejected_max_attempts': 'Tentativas excedidas',
                                'cc_rejected_other_reason': 'Pagamento recusado',
                            };
                            const errorMsg = errorMessages[result.status_detail] || result.status_detail || 'Pagamento não aprovado';
                            alert('Erro no pagamento: ' + errorMsg);
                        }
                        
                    } catch (error) {
                        console.error('Erro:', error);
                        alert('Erro ao processar pagamento. Tente novamente.');
                    }
                },
                onError: (error) => {
                    console.error('Erro no Brick:', error);
                },
            },
        };
        
        window.paymentBrickController = await bricksBuilder.create(
            'payment',
            'payment-brick-container',
            settings
        );
    };
    
    renderPaymentBrick();
});
</script>
{% endblock %}
