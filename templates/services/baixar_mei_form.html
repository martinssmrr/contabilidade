{% extends 'base.html' %}
{% load static %}

{% block title %}Baixar MEI - Cancelar CNPJ MEI | Vetorial Contabilidade{% endblock %}

{% block extra_css %}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
    .section-title-blue { color: #1A237E; font-weight: 700; }

    .form-section { background: linear-gradient(180deg, #f8f9fa 0%, #fff 100%); padding: 80px 0; }

    .form-card {
        background: #fff;
        border-radius: 20px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.08);
        padding: 40px;
        border: 1px solid rgba(0,0,0,0.05);
    }

    .form-card-header {
        text-align: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid #f0f0f0;
    }

    .form-card-header h2 { color: #1A237E; font-weight: 700; margin-bottom: 10px; }

    .form-section-title {
        color: #1A237E;
        font-weight: 600;
        font-size: 1.1rem;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #db2777;
        display: inline-block;
    }

    .form-section-title i { margin-right: 8px; color: #db2777; }

    .form-control, .form-select {
        border-radius: 10px;
        padding: 12px 15px;
        border: 1px solid #e0e0e0;
        transition: all 0.3s ease;
    }

    .form-control:focus, .form-select:focus {
        border-color: #db2777;
        box-shadow: 0 0 0 3px rgba(219, 39, 119, 0.15);
    }

    .form-label { font-weight: 500; color: #333; margin-bottom: 6px; }
    .required-field::after { content: " *"; color: #dc3545; }

    .btn-submit-mei {
        background: linear-gradient(135deg, #db2777 0%, #9d174d 100%);
        color: #fff;
        padding: 15px 50px;
        font-size: 1.1rem;
        font-weight: 600;
        border-radius: 50px;
        border: none;
        transition: all 0.3s ease;
        box-shadow: 0 5px 20px rgba(219, 39, 119, 0.3);
    }

    .btn-submit-mei:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 30px rgba(219, 39, 119, 0.4);
        color: #fff;
    }

    .btn-submit-mei:disabled { opacity: 0.7; cursor: not-allowed; }

    .form-progress {
        display: flex;
        justify-content: center;
        margin-bottom: 30px;
        flex-wrap: wrap;
        gap: 10px;
    }

    .progress-step {
        display: flex;
        align-items: center;
        padding: 8px 16px;
        background: #f0f0f0;
        border-radius: 50px;
        font-size: 0.9rem;
        color: #666;
    }

    .progress-step.active {
        background: linear-gradient(135deg, #db2777 0%, #9d174d 100%);
        color: white;
    }

    .progress-step i { margin-right: 6px; }

    .success-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.6);
        z-index: 9999;
        align-items: center;
        justify-content: center;
    }

    .success-overlay.active { display: flex; }

    .success-box {
        background: #fff;
        border-radius: 20px;
        padding: 48px;
        max-width: 480px;
        text-align: center;
        box-shadow: 0 20px 60px rgba(0,0,0,0.2);
        animation: slideUp 0.4s ease;
    }

    @keyframes slideUp {
        from { opacity: 0; transform: translateY(30px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .success-icon {
        width: 80px; height: 80px;
        background: linear-gradient(135deg, #059669, #10b981);
        border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        margin: 0 auto 20px;
        color: #fff; font-size: 2rem;
    }

    @media (max-width: 768px) {
        .form-card { padding: 25px; }
    }
</style>
{% endblock %}

{% block content %}

<!-- Formulário Section -->
<section id="formulario-baixar" class="form-section">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-10 col-xl-9">
                <div class="form-card">
                    <!-- Header do Formulário -->
                    <div class="form-card-header">
                        <h2><i class="bi bi-file-earmark-x me-2" style="color: #db2777;"></i>Solicitação de Baixa do MEI</h2>
                        <p class="text-muted mb-0">Preencha os dados abaixo para solicitar o cancelamento do seu CNPJ MEI</p>
                    </div>

                    <!-- Progress Steps -->
                    <div class="form-progress">
                        <span class="progress-step active"><i class="bi bi-1-circle-fill"></i> Dados Pessoais</span>
                        <span class="progress-step"><i class="bi bi-2-circle"></i> Dados do MEI</span>
                        <span class="progress-step"><i class="bi bi-3-circle"></i> Confirmação</span>
                    </div>

                    <!-- Formulário -->
                    <form id="form-baixar-mei" novalidate>
                        {% csrf_token %}

                        <!-- SEÇÃO 1: Dados Pessoais -->
                        <div class="mb-5">
                            <h5 class="form-section-title">
                                <i class="bi bi-person-fill"></i>Dados Pessoais
                            </h5>
                            <div class="row g-3">
                                <div class="col-12">
                                    <label for="nome_completo" class="form-label required-field">Nome Completo</label>
                                    <input type="text" class="form-control" id="nome_completo" name="nome_completo" placeholder="Seu nome completo" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="email" class="form-label required-field">E-mail</label>
                                    <input type="email" class="form-control" id="email" name="email" placeholder="seuemail@exemplo.com" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="telefone" class="form-label required-field">Telefone / WhatsApp</label>
                                    <input type="tel" class="form-control" id="telefone" name="telefone" placeholder="(11) 99999-9999" required>
                                </div>
                            </div>
                        </div>

                        <!-- SEÇÃO 2: Dados do MEI -->
                        <div class="mb-5">
                            <h5 class="form-section-title">
                                <i class="bi bi-building"></i>Dados do MEI
                            </h5>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="cnpj" class="form-label required-field">CNPJ do MEI</label>
                                    <input type="text" class="form-control" id="cnpj" name="cnpj" placeholder="00.000.000/0001-00" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="cpf" class="form-label required-field">CPF do Responsável</label>
                                    <input type="text" class="form-control" id="cpf" name="cpf" placeholder="000.000.000-00" required>
                                </div>
                                <div class="col-12">
                                    <label for="motivo" class="form-label">Motivo da Baixa</label>
                                    <select class="form-select" id="motivo" name="motivo">
                                        <option value="" selected>Selecione o motivo...</option>
                                        <option value="nao_utilizo">Não utilizo mais o MEI</option>
                                        <option value="migrar_me">Vou migrar para ME/EPP</option>
                                        <option value="emprego_clt">Consegui emprego CLT</option>
                                        <option value="dividas">MEI com dívidas acumuladas</option>
                                        <option value="aposentadoria">Aposentadoria</option>
                                        <option value="outro">Outro motivo</option>
                                    </select>
                                </div>
                                <div class="col-12">
                                    <label for="observacoes" class="form-label">Observações Adicionais</label>
                                    <textarea class="form-control" id="observacoes" name="observacoes" rows="3" placeholder="Conte-nos mais detalhes sobre sua situação (pendências, dívidas, etc.)"></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Submit -->
                        <div class="text-center pt-4 border-top">
                            <p class="text-muted mb-4">
                                <i class="bi bi-shield-lock me-2"></i>
                                Seus dados estão protegidos. Utilizaremos apenas para entrar em contato e iniciar o processo de baixa do MEI.
                            </p>
                            <button type="submit" class="btn btn-submit-mei" id="btn-submit">
                                <span class="btn-text">
                                    <i class="bi bi-credit-card me-2"></i>SOLICITAR BAIXA DO MEI
                                </span>
                                <span class="btn-loading d-none">
                                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                    Enviando...
                                </span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Success Overlay -->
<div class="success-overlay" id="successOverlay">
    <div class="success-box">
        <div class="success-icon">
            <i class="bi bi-check-lg"></i>
        </div>
        <h3 class="fw-bold mb-2" style="color: #1A237E;">Solicitação Enviada!</h3>
        <p class="text-muted mb-4">Recebemos sua solicitação de baixa do MEI. Nossa equipe entrará em contato via WhatsApp em breve para iniciar o processo.</p>
        <a href="{% url 'contabilidade_mei' %}" class="btn btn-submit-mei px-4">Voltar para Contabilidade MEI</a>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Máscara de telefone
    const telInput = document.getElementById('telefone');
    if (telInput) {
        telInput.addEventListener('input', function(e) {
            let v = e.target.value.replace(/\D/g, '');
            if (v.length > 11) v = v.slice(0, 11);
            if (v.length > 6) v = '(' + v.slice(0,2) + ') ' + v.slice(2,7) + '-' + v.slice(7);
            else if (v.length > 2) v = '(' + v.slice(0,2) + ') ' + v.slice(2);
            e.target.value = v;
        });
    }

    // Máscara de CNPJ
    const cnpjInput = document.getElementById('cnpj');
    if (cnpjInput) {
        cnpjInput.addEventListener('input', function(e) {
            let v = e.target.value.replace(/\D/g, '');
            if (v.length > 14) v = v.slice(0, 14);
            if (v.length > 12) v = v.slice(0,2) + '.' + v.slice(2,5) + '.' + v.slice(5,8) + '/' + v.slice(8,12) + '-' + v.slice(12);
            else if (v.length > 8) v = v.slice(0,2) + '.' + v.slice(2,5) + '.' + v.slice(5,8) + '/' + v.slice(8);
            else if (v.length > 5) v = v.slice(0,2) + '.' + v.slice(2,5) + '.' + v.slice(5);
            else if (v.length > 2) v = v.slice(0,2) + '.' + v.slice(2);
            e.target.value = v;
        });
    }

    // Máscara de CPF
    const cpfInput = document.getElementById('cpf');
    if (cpfInput) {
        cpfInput.addEventListener('input', function(e) {
            let v = e.target.value.replace(/\D/g, '');
            if (v.length > 11) v = v.slice(0, 11);
            if (v.length > 9) v = v.slice(0,3) + '.' + v.slice(3,6) + '.' + v.slice(6,9) + '-' + v.slice(9);
            else if (v.length > 6) v = v.slice(0,3) + '.' + v.slice(3,6) + '.' + v.slice(6);
            else if (v.length > 3) v = v.slice(0,3) + '.' + v.slice(3);
            e.target.value = v;
        });
    }

    // Submit do formulário
    const form = document.getElementById('form-baixar-mei');
    const btnSubmit = document.getElementById('btn-submit');

    form.addEventListener('submit', async function(e) {
        e.preventDefault();

        const nome = document.getElementById('nome_completo').value.trim();
        const email = document.getElementById('email').value.trim();
        const telefone = document.getElementById('telefone').value.trim();
        const cnpj = document.getElementById('cnpj').value.trim();
        const cpf = document.getElementById('cpf').value.trim();

        if (!nome || !email || !telefone || !cnpj || !cpf) {
            alert('Por favor, preencha todos os campos obrigatórios.');
            return;
        }

        btnSubmit.querySelector('.btn-text').classList.add('d-none');
        btnSubmit.querySelector('.btn-loading').classList.remove('d-none');
        btnSubmit.disabled = true;

        const motivo = document.getElementById('motivo').value;
        const obs = document.getElementById('observacoes').value.trim();

        try {
            const response = await fetch('/services/baixar-mei/solicitar/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    nome_completo: nome,
                    email: email,
                    telefone: telefone.replace(/\D/g, ''),
                    cnpj: cnpj,
                    cpf: cpf,
                    motivo: motivo,
                    observacoes: obs
                })
            });

            const data = await response.json();

            if (data.success && data.redirect_url) {
                window.location.href = data.redirect_url;
            } else {
                alert(data.message || 'Erro ao enviar. Tente novamente.');
                btnSubmit.querySelector('.btn-text').classList.remove('d-none');
                btnSubmit.querySelector('.btn-loading').classList.add('d-none');
                btnSubmit.disabled = false;
            }
        } catch (err) {
            alert('Erro de conexão. Tente novamente.');
            btnSubmit.querySelector('.btn-text').classList.remove('d-none');
            btnSubmit.querySelector('.btn-loading').classList.add('d-none');
            btnSubmit.disabled = false;
        }
    });
});
</script>
{% endblock %}
