{% extends 'admin/base.html' %}
{% load static %}

{% block title %}{{ cliente.get_full_name|default:cliente.username }} - Painel Staff{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>
            <i class="fas fa-user-circle me-2"></i>
            {{ cliente.get_full_name|default:cliente.username }}
        </h1>
        <a href="{% url 'documents:client_list' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-2"></i>Voltar à Lista
        </a>
    </div>

    <!-- Informações do Cliente -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Informações do Cliente</h5>
                </div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-sm-4">ID:</dt>
                        <dd class="col-sm-8"><strong>#{{ cliente.id }}</strong></dd>
                        
                        <dt class="col-sm-4">Nome:</dt>
                        <dd class="col-sm-8">{{ cliente.get_full_name|default:"-" }}</dd>
                        
                        <dt class="col-sm-4">Email:</dt>
                        <dd class="col-sm-8">{{ cliente.email }}</dd>
                        
                        <dt class="col-sm-4">Username:</dt>
                        <dd class="col-sm-8">{{ cliente.username }}</dd>
                        
                        <dt class="col-sm-4">Cadastro:</dt>
                        <dd class="col-sm-8">{{ cliente.date_joined|date:"d/m/Y \à\s H:i" }}</dd>
                        
                        <dt class="col-sm-4">Status:</dt>
                        <dd class="col-sm-8">
                            {% if cliente.is_active %}
                                <span class="badge bg-success">Ativo</span>
                            {% else %}
                                <span class="badge bg-danger">Inativo</span>
                            {% endif %}
                        </dd>
                    </dl>
                </div>
            </div>
        </div>

        <!-- Estatísticas -->
        <div class="col-md-6">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Estatísticas</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-around align-items-center h-100">
                        <div class="text-center">
                            <i class="fas fa-building fa-3x text-primary mb-2"></i>
                            <h2 class="mb-0">{{ total_documentos }}</h2>
                            <p class="text-muted mb-0">Documento{{ total_documentos|pluralize:"s" }} da Empresa</p>
                        </div>
                        <div class="text-center">
                            <i class="fas fa-file-invoice-dollar fa-3x text-success mb-2"></i>
                            <h2 class="mb-0">{{ total_notas }}</h2>
                            <p class="text-muted mb-0">Nota{{ total_notas|pluralize:"s" }} Fiscal{{ total_notas|pluralize:"is" }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload de Documento da Empresa -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="fas fa-building me-2"></i>Enviar Novo Documento da Empresa</h5>
        </div>
        <div class="card-body">
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="hidden" name="form_type" value="documento_empresa">
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="{{ form_doc.titulo.id_for_label }}" class="form-label">
                            <i class="fas fa-heading me-2"></i>{{ form_doc.titulo.label }}
                        </label>
                        {{ form_doc.titulo }}
                        {% if form_doc.titulo.errors %}
                            <div class="text-danger mt-1">{{ form_doc.titulo.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label for="{{ form_doc.categoria.id_for_label }}" class="form-label">
                            <i class="fas fa-tags me-2"></i>{{ form_doc.categoria.label }}
                        </label>
                        {{ form_doc.categoria }}
                        {% if form_doc.categoria.errors %}
                            <div class="text-danger mt-1">{{ form_doc.categoria.errors }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-8 mb-3">
                        <label for="{{ form_doc.arquivo.id_for_label }}" class="form-label">
                            <i class="fas fa-file me-2"></i>{{ form_doc.arquivo.label }}
                        </label>
                        {{ form_doc.arquivo }}
                        {% if form_doc.arquivo.errors %}
                            <div class="text-danger mt-1">{{ form_doc.arquivo.errors }}</div>
                        {% endif %}
                        <div class="form-text">
                            Formatos aceitos: PDF, DOC, DOCX, XLS, XLSX, etc. | Tamanho máximo: 10MB
                        </div>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <label class="form-label">&nbsp;</label>
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-paper-plane me-2"></i>Enviar Documento
                        </button>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="{{ form_doc.descricao.id_for_label }}" class="form-label">
                        {{ form_doc.descricao.label }}
                    </label>
                    {{ form_doc.descricao }}
                    {% if form_doc.descricao.errors %}
                        <div class="text-danger mt-1">{{ form_doc.descricao.errors }}</div>
                    {% endif %}
                </div>
            </form>
        </div>
    </div>

    <!-- Lista de Documentos da Empresa -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="fas fa-building me-2"></i>Documentos da Empresa Enviados ({{ total_documentos }})</h5>
        </div>
        <div class="card-body">
            {% if documentos_empresa %}
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th><i class="fas fa-heading me-2"></i>Título</th>
                                <th><i class="fas fa-tags me-2"></i>Categoria</th>
                                <th><i class="fas fa-file me-2"></i>Arquivo</th>
                                <th><i class="fas fa-calendar me-2"></i>Data do Envio</th>
                                <th><i class="fas fa-user me-2"></i>Enviado Por</th>
                                <th class="text-center">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for doc in documentos_empresa %}
                            <tr>
                                <td><strong>#{{ doc.id }}</strong></td>
                                <td><strong>{{ doc.titulo }}</strong></td>
                                <td><span class="badge bg-info">{{ doc.get_categoria_display }}</span></td>
                                <td>
                                    <i class="fas fa-file text-primary me-2"></i>
                                    {{ doc.nome_arquivo }}
                                </td>
                                <td>{{ doc.data_upload|date:"d/m/Y \à\s H:i" }}</td>
                                <td>{{ doc.enviado_por.get_full_name|default:doc.enviado_por.username }}</td>
                                <td class="text-center">
                                    <a href="{{ doc.arquivo.url }}" 
                                       class="btn btn-sm btn-primary" 
                                       target="_blank"
                                       title="Visualizar documento">
                                        <i class="fas fa-eye me-1"></i>Ver
                                    </a>
                                    <a href="{{ doc.arquivo.url }}" 
                                       class="btn btn-sm btn-success" 
                                       download
                                       title="Baixar documento">
                                        <i class="fas fa-download me-1"></i>Baixar
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-building fa-4x text-muted mb-3"></i>
                    <h3>Nenhum documento enviado</h3>
                    <p class="text-muted">Use o formulário acima para enviar o primeiro documento da empresa para este cliente.</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Upload de Nota Fiscal -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="fas fa-upload me-2"></i>Enviar Nova Nota Fiscal</h5>
        </div>
        <div class="card-body">
            {% if messages %}
                {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                {% endfor %}
            {% endif %}

            <form method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
                {% csrf_token %}
                <input type="hidden" name="form_type" value="nota_fiscal">
                
                <div class="row">
                    <div class="col-md-8 mb-3">
                        <label for="{{ form_nf.arquivo_pdf.id_for_label }}" class="form-label">
                            <i class="fas fa-file-pdf me-2"></i>{{ form_nf.arquivo_pdf.label }}
                        </label>
                        {{ form_nf.arquivo_pdf }}
                        {% if form_nf.arquivo_pdf.errors %}
                            <div class="text-danger mt-1">{{ form_nf.arquivo_pdf.errors }}</div>
                        {% endif %}
                        <div class="form-text">
                            Formatos aceitos: PDF | Tamanho máximo: 10MB
                        </div>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <label class="form-label">&nbsp;</label>
                        <button type="submit" class="btn btn-success w-100">
                            <i class="fas fa-paper-plane me-2"></i>Enviar Nota Fiscal
                        </button>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="{{ form_nf.observacoes.id_for_label }}" class="form-label">
                        {{ form_nf.observacoes.label }}
                    </label>
                    {{ form_nf.observacoes }}
                    {% if form_nf.observacoes.errors %}
                        <div class="text-danger mt-1">{{ form_nf.observacoes.errors }}</div>
                    {% endif %}
                </div>
            </form>
        </div>
    </div>

    <!-- Lista de Notas Fiscais -->
    <div class="card shadow-sm">
        <div class="card-header bg-dark text-white">
            <h5 class="mb-0"><i class="fas fa-list me-2"></i>Notas Fiscais Enviadas ({{ total_notas }})</h5>
        </div>
        <div class="card-body">
            {% if notas_fiscais %}
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th><i class="fas fa-file-pdf me-2"></i>Arquivo</th>
                                <th><i class="fas fa-calendar me-2"></i>Data do Envio</th>
                                <th><i class="fas fa-user me-2"></i>Enviado Por</th>
                                <th><i class="fas fa-weight me-2"></i>Tamanho</th>
                                <th class="text-center">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for nota in notas_fiscais %}
                            <tr>
                                <td><strong>#{{ nota.id }}</strong></td>
                                <td>
                                    <i class="fas fa-file-pdf text-danger me-2"></i>
                                    {{ nota.nome_arquivo }}
                                </td>
                                <td>{{ nota.data_upload|date:"d/m/Y \à\s H:i" }}</td>
                                <td>{{ nota.enviado_por.get_full_name|default:nota.enviado_por.username }}</td>
                                <td><span class="badge bg-secondary">{{ nota.tamanho_arquivo }}</span></td>
                                <td class="text-center">
                                    <a href="{{ nota.arquivo_pdf.url }}" 
                                       class="btn btn-sm btn-primary" 
                                       target="_blank"
                                       title="Visualizar nota fiscal">
                                        <i class="fas fa-eye me-1"></i>Ver
                                    </a>
                                    <a href="{{ nota.arquivo_pdf.url }}" 
                                       class="btn btn-sm btn-success" 
                                       download
                                       title="Baixar nota fiscal">
                                        <i class="fas fa-download me-1"></i>Baixar
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-file-invoice-dollar fa-4x text-muted mb-3"></i>
                    <h3>Nenhuma nota fiscal enviada</h3>
                    <p class="text-muted">Use o formulário acima para enviar a primeira nota fiscal para este cliente.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
.table > :not(caption) > * > * {
    padding: 0.75rem;
}

.btn-sm {
    font-size: 0.875rem;
    margin: 0 0.125rem;
}

dl dt {
    font-weight: 600;
}

dl dd {
    margin-bottom: 0.5rem;
}
</style>
{% endblock %}
